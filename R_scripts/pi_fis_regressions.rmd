# Set up notebook
## Load libraries & functions
```{r warning=F}
source(here::here("libraries.R"))
source(here::here("functions.R"))
```

These analyses use the narrow, conservative genetic dataset:
-R = 0.75 & -min_maf = 0.05

*THE OUTPUT FROM THESE RESULTS HAS BEEN OVERWRITTEN WITH RESULTS FROM THE R = 0.5 SECTION BELOW BECAUSE THEY ARE NOT BEING USED FOR THIS ANALYSIS*
# Import data
## Urbanization data
```{r}
urb <- read.csv(here::here("./clean_data/urb_metrics.csv")) %>%
  dplyr::mutate(site_id = as.factor(site_id),
                patch_id = as.factor(patch_id),
                urb_rur = as.factor(urb_rur),
                quadrant = as.factor(quadrant),
                river_valley = as.factor(river_valley)
                )
```

## Genetic data
```{r}

diversity_all_sites <- here::here("./populations_no-IBD_vcf-all_mainfiles/mmaf0.05_R0.75/populations.sumstats_summary.tsv") %>%
  extract_variant_position_summary() %>%
# if population doesn't start with "MWI", it should start with "MW"
  # clean names
  janitor::clean_names() %>%
  # rename col 1
  dplyr::rename(pop_id = 1) %>%
  dplyr::mutate(pop_id = as.factor(pop_id)) %>%

### Add "MW" to numeric populations
  add_MW_IDs()

```

## Join genetic data with urbanization data
```{r}
# left vs. full join because some populations in urb_clean weren't genotyped due to lack of material
diversity_all_sites %<>%
  left_join(., urb, by = "patch_id") %>%
  dplyr::mutate(patch_id = as.factor(patch_id),
                pop_id = as.factor(pop_id))

```

# Does urbanization predict genetic diversity within pops? **R = 0.75, mmaf = 0.5**
## Explore data
### Structure
```{r}
str(diversity_all_sites)

head(diversity_all_sites)

diversity_all_sites %>%
  dplyr::select(1, 3, 4, "pi", "fis", "City_dist", "urb_score") %>%
  view

```

### Visualizations
```{r}
ggplot(diversity_all_sites, 
       aes(y= fis)) + 
  geom_boxplot()

ggplot(diversity_all_sites, 
       aes(y= pi)) + 
  geom_boxplot()


# quick regressions of genetic vars against distance from cc
ggplot(diversity_all_sites, 
       aes(x = City_dist,
           y = fis)) + 
  geom_point()

ggplot(diversity_all_sites, 
       aes(x = City_dist,
           y = pi)) + 
  geom_point()

ggplot(diversity_all_sites, 
       aes(x = urb_score,
           y = pi)) + 
  geom_point() 

qplot(data = diversity_all_sites,
      City_dist, num_indv)


# regress all selected variables against one another
diversity_all_sites %>%
  dplyr::select(pi, num_indv, fis, urb_score, City_dist) %>%
  pairs()


# look at distributions of urb vs rural pops
qplot(data = diversity_all_sites,
      u_r_dist, pi)

qplot(data = diversity_all_sites,
      u_r_usc, pi)

qplot(data = diversity_all_sites,
      u_r_dist, fis)

qplot(data = diversity_all_sites,
      u_r_usc, fis)

```

### Does urbanization correlate with number of individuals/population?
```{r}
test1 <- glmmTMB(City_dist ~ num_indv, diversity_all_sites)
performance::check_model(test1)
car::Anova(test1) # yes
r.squaredGLMM(test1) # only ~4% variance explained


test1 <- glmmTMB(urb_score ~ num_indv, diversity_all_sites)
performance::check_model(test1)
car::Anova(test1) # no
```

### Does the number of individuals per populations correlate with pop gen stats?
#### FIS
```{r}

ggplot(diversity_all_sites, 
       aes(x = num_indv,
           y = fis)) + 
  geom_point(aes(color = City_dist)) +
  scale_color_continuous(type = "viridis")

# this (and the df) shows us that populations with 1 individual all have fis = 0.
# I'll remove them from this analysis' dataset.



test1 <- glmmTMB(fis ~ num_indv,
                 diversity_all_sites %>%
                   dplyr::filter(fis != 0))
performance::check_model(test1)
car::Anova(test1) # yes
r.squaredGLMM(test1) # ~28% variance explained
# SO I WILL add num_indivs as a random effect to these models

```

#### Pi
```{r}
qplot(diversity_all_sites$num_indv,
      diversity_all_sites$pi)

ggplot(diversity_all_sites,
       aes(x = num_indv,
           y = pi)) +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() 

test1 <- glmmTMB(pi ~ num_indv,
                 diversity_all_sites)
performance::check_model(test1)
car::Anova(test1) # yes
r.squaredGLMM(test1) # ~7% variance explained
# SO I WILL add num_indivs as a random effect to these models
# 

diversity_all_sites %>%
  dplyr::group_by(round(num_indv, 0)) %>%
  dplyr::summarise(pi_per_groupsize <- mean(pi))
```

## Urbanization is continuous
### Fit linear models/diagnostics
#### Inbreeding coefficient (FIS)
##### City_dist
```{r}

fis_dist <- glmmTMB(fis ~ City_dist + (1|num_indv),
           diversity_all_sites %>%
             dplyr::filter(fis != 0))

performance::check_model(fis_dist)
```

##### Urb_score
```{r}
fis_usc <- glmmTMB(fis ~ urb_score  + (1|num_indv),
           diversity_all_sites %>%
             dplyr::filter(fis != 0))

performance::check_model(fis_usc)
```

#### Pi
##### City_dist
```{r}
pi_dist <- glmmTMB(pi ~ City_dist  + (1|num_indv),
           diversity_all_sites)

performance::check_model(pi_dist)

```

##### Urb_score
###### All individuals
```{r}
pi_usc <- glmmTMB(pi ~ urb_score  + (1|num_indv),
           diversity_all_sites)

performance::check_model(pi_usc)

# % decrease with urb: (have to create pi_usc_pred object in Figures section below)
perc_decrease(pi_usc_pred) # 5.5%
```

###### Sites with only 1 individual
```{r}
pi_usc_1indiv <- glmmTMB(pi ~ urb_score,
           diversity_all_sites %>%
             dplyr::filter(num_indv == 1))

performance::check_model(pi_usc_1indiv)

car::Anova(pi_usc_1indiv)

pi_usc_pred_1indiv <- ggeffects::ggpredict(pi_usc_1indiv,
                                   terms = c("urb_score"),
                                   type = "fe")

plot(pi_usc_pred_1indiv, 
     add.data = F) +
  geom_ribbon(aes(x = x,
                  ymin = conf.low,
                  ymax = conf.high),
              # fill = "#66a182",
               alpha = 0.1
              ) +
  # geom_point(data = diversity_all_sites %>%
  #            dplyr::filter(num_indv == 1),
  #            aes(x = urb_score,
  #            y = pi)) +
  xlab("Urbanization Score") +
  ylab("Pi") +
  ylim(0.18, 0.25) +
  labs(title = "") +
  scale_x_reverse() +
  theme_pubr() +
  labs_pubr() 

MuMIn::r.squaredGLMM(pi_usc_1indiv) # R2m = 0.101

# % decrease with urb:
perc_decrease(pi_dist_pred_1indiv) # 11.8%
```

### ANOVA & effect sizes
```{r}

mod_list <- list(fis_dist,
                 fis_usc,
                 pi_dist,
                 pi_usc)


all_anovas <- do.call(rbind, create_anova_df(mod_list)) %>%
  view

# create flextable
all_anovas %>%
  dplyr::select(-Sig) %>%
  flextable::flextable() %>%
  flextable::compose(i = 1, j = 3, part = "header",
                     value = as_paragraph("Î§", as_sup("2"))) %>%
  flextable::compose(i = 1, j = 6, part = "header",
                     value = as_paragraph("R", as_sup("2"))) %>%
  bold(~ p <= 0.05) %>%
  flextable::autofit() %T>%
  flextable::save_as_image(here::here("./Figures_Tables/regressions/pi_fis_anova.png"))
```

### Figures
#### FIS
##### City_dist
```{r}
fis_dist_pred <- ggeffects::ggpredict(fis_dist,
                                   terms = c("City_dist"),
                                   type = "fe")

fis_dist_pred_plot <- plot(fis_dist_pred, 
     add.data = F) +
  # geom_point(data = diversity_all_sites,
  #            aes(x = City_dist,
  #                y = fis)) +
  geom_ribbon(aes(x = x,
                  ymin = conf.low,
                  ymax = conf.high),
              # fill = "#66a182",
               alpha = 0.1
              ) +
  xlab("Distance to City Center (km)") +
  ylab("FIS") +
  ylim(0, 0.06) +
  labs(title = "") +
  theme_pubr() +
  labs_pubr() 

fis_dist_pred_plot
```

##### Urb_score
```{r}
fis_usc_pred <- ggeffects::ggpredict(fis_usc,
                                   terms = c("urb_score"),
                                   type = "fe")
 
fis_usc_pred_plot <- plot(fis_usc_pred, 
     add.data = F) +
  geom_ribbon(aes(x = x,
                  ymin = conf.low,
                  ymax = conf.high),
              # fill = "#66a182",
               alpha = 0.1
              ) +
  xlab("Urbanization Score") +
  ylab("FIS") +
  ylim(0, 0.06) +
  labs(title = "") +
  theme_pubr() +
  labs_pubr() +
  xlim(4, -4)

fis_usc_pred_plot
```

#### Pi
##### City_dist
```{r}
pi_dist_pred <- ggeffects::ggpredict(pi_dist,
                                   terms = c("City_dist"),
                                   type = "fe")

pi_dist_pred_plot <- plot(pi_dist_pred, 
     add.data = F) +
  geom_ribbon(aes(x = x,
                  ymin = conf.low,
                  ymax = conf.high),
              # fill = "#66a182",
               alpha = 0.1
              ) +
  xlab("Distance to City Center (km)") +
  ylab("Pi") +
  ylim(0.2, 0.26) +
  labs(title = "") +
  theme_pubr() +
  labs_pubr() 

pi_dist_pred_plot
```

##### Urb_score
```{r}
pi_usc_pred <- ggeffects::ggpredict(pi_usc,
                                   terms = c("urb_score"),
                                   type = "fe")

pi_usc_pred_plot <- plot(pi_usc_pred, 
     add.data = F) +
  geom_ribbon(aes(x = x,
                  ymin = conf.low,
                  ymax = conf.high),
              # fill = "#66a182",
               alpha = 0.1
              ) +
  xlab("Urbanization Score") +
  ylab("Pi") +
  ylim(0.2, 0.26) +
  labs(title = "") +
  xlim(4, -4) +
  theme_pubr() +
  labs_pubr() 

pi_usc_pred_plot
```

#### Number of individuals per pop
##### City_dist
```{r}
ggplot(diversity_all_sites,
       aes(x = City_dist,
           y = num_indv)) +
  xlab("Distance to City Center (km)") +
  ylab("Individuals/Population") +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() 

ggplot(diversity_all_sites,
       aes(x = num_indv)) +
  geom_histogram() +
  xlab("Individuals/Population") +
#  plot_aesthetics +
  theme_pubr() +
  labs_pubr() 
```

##### Urb_score
```{r}
ggplot(diversity_all_sites,
       aes(x = urb_score,
           y = num_indv)) +
  xlab("Urbanization Score") +
  ylab("Individuals/Population") +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() +
  xlim(4, -4)

```

#### Export all in one pdf
```{r}
# not including indivs/pop plots

(fis_dist_pred_plot | fis_usc_pred_plot) /
(pi_dist_pred_plot | pi_usc_pred_plot)

ggsave(here::here("./Figures_Tables/regressions/pi_fis.png"),
       width = 10,
       height = 7,
       units = "in")

```


These analyses use the liberal genetic dataset:
-R = 0.5 & -min_maf = 2/256
# Import data
## Genetic data
```{r}

diversity_all_sites2 <- here::here("./summary_stats/output_populations_no-IBD/mmaf0.007813_R0.5/output_populations_no-IBD-vcf-all/mmaf0.007813_R0.5/populations.sumstats_summary.tsv") %>%
  extract_variant_position_summary() %>%
# if population doesn't start with "MWI", it should start with "MW"
  # clean names
  janitor::clean_names() %>%
  # rename col 1
  dplyr::rename(pop_id = 1) %>%
  dplyr::mutate(pop_id = as.factor(pop_id)) %>%

### Add "MW" to numeric populations
  add_MW_IDs()

```

## Join genetic data with urbanization data
```{r}
# left vs. full join because some populations in urb_clean weren't genotyped due to lack of material
diversity_all_sites2 %<>%
  left_join(., urb, by = "patch_id") %>%
  dplyr::mutate(patch_id = as.factor(patch_id),
                pop_id = as.factor(pop_id))

```

# Does urbanization predict genetic diversity within pops? **R = 0.5, mmaf = 2/256**
## Explore data
### Structure
```{r}
str(diversity_all_sites2)

head(diversity_all_sites2)

diversity_all_sites2 %>%
  dplyr::select(1, 3, 4, "pi", "fis", "City_dist", "urb_score") %>%
  view

```

### Visualizations
```{r}
ggplot(diversity_all_sites2, 
       aes(y= fis)) + 
  geom_boxplot()

ggplot(diversity_all_sites2, 
       aes(y= pi)) + 
  geom_boxplot()


# quick regressions of genetic vars against distance from cc
ggplot(diversity_all_sites2, 
       aes(x = City_dist,
           y = fis)) + 
  geom_point()

ggplot(diversity_all_sites2, 
       aes(x = City_dist,
           y = pi)) + 
  geom_point()

ggplot(diversity_all_sites2, 
       aes(x = urb_score,
           y = pi)) + 
  geom_point() 

qplot(data = diversity_all_sites2,
      City_dist, num_indv)


# regress all selected variables against one another
diversity_all_sites2 %>%
  dplyr::select(pi, num_indv, fis, urb_score, City_dist) %>%
  pairs()


# look at distributions of urb vs rural pops
qplot(data = diversity_all_sites2,
      u_r_dist, pi)

qplot(data = diversity_all_sites2,
      u_r_usc, pi)

qplot(data = diversity_all_sites2,
      u_r_dist, fis)

qplot(data = diversity_all_sites2,
      u_r_usc, fis)

```

### Does urbanization correlate with number of individuals/population?
```{r}
test1 <- glmmTMB(City_dist ~ num_indv, diversity_all_sites2)
performance::check_model(test1)
car::Anova(test1) # yes
r.squaredGLMM(test1) # only ~4% variance explained


test1 <- glmmTMB(urb_score ~ num_indv, diversity_all_sites2)
performance::check_model(test1)
car::Anova(test1) # no
```

### Does the number of individuals per populations correlate with pop gen stats?
#### FIS
```{r}

ggplot(diversity_all_sites2, 
       aes(x = num_indv,
           y = fis)) + 
  geom_point(aes(color = City_dist)) +
  scale_color_continuous(type = "viridis")

# this (and the df) shows us that populations with 1 individual all have fis = 0.
# I'll remove them from this analysis' dataset.



test1 <- glmmTMB(fis ~ num_indv,
                 diversity_all_sites2 %>%
                   dplyr::filter(fis != 0))
performance::check_model(test1)
car::Anova(test1) # yes
r.squaredGLMM(test1) # ~58% variance explained
# SO I WILL add num_indivs as a random effect to these models

```

#### Pi
```{r}
qplot(diversity_all_sites2$num_indv,
      diversity_all_sites2$pi)

ggplot(diversity_all_sites2,
       aes(x = num_indv,
           y = pi)) +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() 

test1 <- glmmTMB(pi ~ num_indv,
                 diversity_all_sites2)
performance::check_model(test1)
car::Anova(test1) # yes
r.squaredGLMM(test1) # ~28% variance explained
# SO I WILL add num_indivs as a random effect to these models


diversity_all_sites2 %>%
  dplyr::group_by(round(num_indv, 0)) %>%
  dplyr::summarise(pi_per_groupsize <- mean(pi))
```

## Urbanization is continuous
### Fit linear models/diagnostics
#### Inbreeding coefficient (FIS)
##### City_dist
```{r}

fis_dist <- glmmTMB(fis ~ City_dist + (1|num_indv),
           diversity_all_sites2 %>%
             dplyr::filter(fis != 0))

performance::check_model(fis_dist)
```

##### Urb_score
```{r}
fis_usc <- glmmTMB(fis ~ urb_score  + (1|num_indv),
           diversity_all_sites2 %>%
             dplyr::filter(fis != 0))

performance::check_model(fis_usc)
```

#### Pi
##### City_dist
```{r}
pi_dist <- glmmTMB(pi ~ City_dist  + (1|num_indv),
           diversity_all_sites2)

performance::check_model(pi_dist)

```

##### Urb_score
###### All individuals
```{r}
pi_usc <- glmmTMB(pi ~ urb_score  + (1|num_indv),
           diversity_all_sites2)

performance::check_model(pi_usc)

# % decrease with urb: (have to create pi_usc_pred object in Figures section below)
perc_decrease(pi_usc_pred) # 5.5%
```

###### Sites with only 1 individual
```{r}
pi_usc_1indiv <- glmmTMB(pi ~ urb_score,
           diversity_all_sites2 %>%
             dplyr::filter(num_indv == 1))

performance::check_model(pi_usc_1indiv)

car::Anova(pi_usc_1indiv)

pi_usc_pred_1indiv <- ggeffects::ggpredict(pi_usc_1indiv,
                                   terms = c("urb_score"),
                                   type = "fe")

plot(pi_usc_pred_1indiv, 
     add.data = F) +
  geom_ribbon(aes(x = x,
                  ymin = conf.low,
                  ymax = conf.high),
              # fill = "#66a182",
               alpha = 0.1
              ) +
  # geom_point(data = diversity_all_sites2 %>%
  #            dplyr::filter(num_indv == 1),
  #            aes(x = urb_score,
  #            y = pi)) +
  xlab("Urbanization Score") +
  ylab("Pi") +
 # ylim(0.18, 0.25) +
  labs(title = "") +
  scale_x_reverse() +
  theme_pubr() +
  labs_pubr() 

MuMIn::r.squaredGLMM(pi_usc_1indiv) # R2m = 0.069

# % decrease with urb:
perc_decrease(pi_dist_pred_1indiv) # 11.8%
```

### ANOVA & effect sizes
```{r}

mod_list <- list(fis_dist,
                 fis_usc,
                 pi_dist,
                 pi_usc)


all_anovas <- do.call(rbind, create_anova_df(mod_list)) %>%
  view

# create flextable
all_anovas %>%
  dplyr::select(-Sig) %>%
  flextable::flextable() %>%
  flextable::compose(i = 1, j = 3, part = "header",
                     value = as_paragraph("Î§", as_sup("2"))) %>%
  flextable::compose(i = 1, j = 6, part = "header",
                     value = as_paragraph("R", as_sup("2"))) %>%
  bold(~ p <= 0.05) %>%
  flextable::autofit() %T>%
  flextable::save_as_image(here::here("./Figures_Tables/regressions/pi_fis_anova.png"))
```

### Figures
#### FIS
##### City_dist
```{r}
fis_dist_pred <- ggeffects::ggpredict(fis_dist,
                                   terms = c("City_dist"),
                                   type = "fe")

fis_dist_pred_plot <- plot(fis_dist_pred, 
     add.data = F) +
  # geom_point(data = diversity_all_sites2,
  #            aes(x = City_dist,
  #                y = fis)) +
  geom_ribbon(aes(x = x,
                  ymin = conf.low,
                  ymax = conf.high),
              # fill = "#66a182",
               alpha = 0.1
              ) +
  xlab("Distance to City Center (km)") +
  ylab("FIS") +
  ylim(0.01, 0.05) +
  labs(title = "") +
  theme_pubr() +
  labs_pubr() 

fis_dist_pred_plot
```

##### Urb_score
```{r}
fis_usc_pred <- ggeffects::ggpredict(fis_usc,
                                   terms = c("urb_score"),
                                   type = "fe")
 
fis_usc_pred_plot <- plot(fis_usc_pred, 
     add.data = F) +
  geom_ribbon(aes(x = x,
                  ymin = conf.low,
                  ymax = conf.high),
              # fill = "#66a182",
               alpha = 0.1
              ) +
  xlab("Urbanization Score") +
  ylab("FIS") +
  ylim(0.01, 0.05) +
  labs(title = "") +
  theme_pubr() +
  labs_pubr() +
  xlim(4, -4)

fis_usc_pred_plot
```

#### Pi
##### City_dist
```{r}
pi_dist_pred <- ggeffects::ggpredict(pi_dist,
                                   terms = c("City_dist"),
                                   type = "fe")

pi_dist_pred_plot <- plot(pi_dist_pred, 
     add.data = F) +
  geom_ribbon(aes(x = x,
                  ymin = conf.low,
                  ymax = conf.high),
              # fill = "#66a182",
               alpha = 0.1
              ) +
  xlab("Distance to City Center (km)") +
  ylab("Pi") +
  ylim(0.085, 0.105) +
  labs(title = "") +
  theme_pubr() +
  labs_pubr() 

pi_dist_pred_plot
```

##### Urb_score
```{r}
pi_usc_pred <- ggeffects::ggpredict(pi_usc,
                                   terms = c("urb_score"),
                                   type = "fe")

pi_usc_pred_plot <- plot(pi_usc_pred, 
     add.data = F) +
  geom_ribbon(aes(x = x,
                  ymin = conf.low,
                  ymax = conf.high),
              # fill = "#66a182",
               alpha = 0.1
              ) +
  xlab("Urbanization Score") +
  ylab("Pi") +
  ylim(0.085, 0.105) +
  labs(title = "") +
  xlim(4, -4) +
  theme_pubr() +
  labs_pubr() 

pi_usc_pred_plot
```

#### Number of individuals per pop
##### City_dist
```{r}
ggplot(diversity_all_sites2,
       aes(x = City_dist,
           y = num_indv)) +
  xlab("Distance to City Center (km)") +
  ylab("Individuals/Population") +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() 

```

##### Urb_score
```{r}
ggplot(diversity_all_sites2,
       aes(x = urb_score,
           y = num_indv)) +
  xlab("Urbanization Score") +
  ylab("Individuals/Population") +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() +
  xlim(4, -4)

```

#### Export all in one pdf
```{r}
# not including indivs/pop plots

(fis_dist_pred_plot | fis_usc_pred_plot) /
(pi_dist_pred_plot | pi_usc_pred_plot)

ggsave(here::here("./Figures_Tables/regressions/pi_fis.png"),
       width = 10,
       height = 7,
       units = "in")

```

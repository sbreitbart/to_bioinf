---
title: Comparing how different -R values impacts exp/obs homozygosity/heterozygosity
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
    number_sections: true
    theme: lumen
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```


# Set up notebook
## Load libraries
```{r warning=F}
source(here::here("libraries.R"))
```

## Import data
### Urbanization data
```{r}
urb <- read.csv(here::here("./clean_data/urb_metrics.csv")) %>%
  dplyr::mutate(site_id = as.factor(site_id),
                patch_id = as.factor(patch_id),
                urb_rur = as.factor(urb_rur),
                quadrant = as.factor(quadrant),
                river_valley = as.factor(river_valley)
                )
```

### Genetic data
```{r}

## Extract variant positions summaries for one trial
extract_variant_position_summary <- function(file) {
  
    text <- readLines(file)
    begin_line <- grep("# Variant positions", text)
    end_line <- grep("# All positions", text)
    data_text <- text[(begin_line + 1):(end_line - 1)]
    data_df <- read.table(text = data_text, header = FALSE, sep = "\t")
    header <- text[begin_line + 1]
    colnames(data_df) <- unlist(strsplit(header, "\t"))

  return(data_df)
}

# create an empty list to store the output from each file
output_list <- list()

# file list
file_list <- c(
  here::here("./summary_stats/trial_02/output_filtering_fstats_trial01/populations.sumstats_summary.tsv"),
  here::here("./summary_stats/trial_02/output_filtering_fstats_trial02/populations.sumstats_summary.tsv"),
  here::here("./summary_stats/trial_02/output_filtering_fstats_trial03/populations.sumstats_summary.tsv"),
  here::here("./summary_stats/trial_02/output_filtering_fstats_trial04/populations.sumstats_summary.tsv"),
  here::here("./summary_stats/trial_02/output_filtering_fstats_trial05/populations.sumstats_summary.tsv"),
  here::here("./summary_stats/trial_02/output_filtering_fstats_trial06/populations.sumstats_summary.tsv"),
  here::here("./summary_stats/trial_02/output_filtering_fstats_trial07/populations.sumstats_summary.tsv"),
  here::here("./summary_stats/trial_02/output_filtering_fstats_trial08/populations.sumstats_summary.tsv"),
  here::here("./summary_stats/trial_02/output_filtering_fstats_trial09/populations.sumstats_summary.tsv"),
  here::here("./summary_stats/trial_02/output_filtering_fstats_trial10/populations.sumstats_summary.tsv"),
  here::here("./summary_stats/trial_02/output_filtering_fstats_trial11/populations.sumstats_summary.tsv"),
  here::here("./summary_stats/trial_02/output_filtering_fstats_trial12/populations.sumstats_summary.tsv"),
  here::here("./summary_stats/trial_02/output_filtering_fstats_trial13/populations.sumstats_summary.tsv")
  )

# loop through each file and apply the function
for (file in file_list) {
  output_list[[file]] <- extract_variant_position_summary(file) %>%
# if population doesn't start with "MWI", it should start with "MW"
  # clean names
  janitor::clean_names() %>%
  # rename col 1
  dplyr::rename(pop_id = 1) %>%
  dplyr::mutate(pop_id = as.factor(pop_id))
}


# take entries with numeric populations and add "MW" as prefix
add_MW_IDs <- function(div_df) {
  # Filter out populations that start with "MWI" or "UTSC"
  MW_pops <- div_df %>%
    filter(!str_detect(pop_id, "MWI")) %>%
    filter(!str_detect(pop_id, "UTSC"))

  # Get populations that start with "MWI" or "UTSC"
  MWI_UTSC_pops <- anti_join(div_df, MW_pops)

  # Split up populations MW001->MW009 vs MW010->MW079
  MW_pops_singledigits <- MW_pops[nchar(as.character(MW_pops$pop_id)) == 1, ]
  MW_pops_doubledigits <- MW_pops[nchar(as.character(MW_pops$pop_id)) != 1, ]

  # Add "MW00" to single-digit populations
  MW_pops_singledigits %<>%
    dplyr::mutate(patch_id = paste0("MW00", pop_id))

  # Add "MW0" to double-digit populations
  MW_pops_doubledigits %<>%
    dplyr::mutate(patch_id = paste0("MW0", pop_id))

  # Bring all entries together again
  all_pops <- full_join(MW_pops_singledigits,
                         MW_pops_doubledigits) %>%
    dplyr::relocate(patch_id, .before = 1) %>%
    full_join(.,
              MWI_UTSC_pops) %>%
    # If patch_id column is NA (for MWI and UTSC values), replace it with value from pop_id
    dplyr::mutate(patch_id = coalesce(patch_id, pop_id))

  return(all_pops)
}

output_list %<>% lapply(., add_MW_IDs)


## Join genetic data with urbanization data
join_genetic_data <- function(div_df){

# left vs. full join because some populations in urb_clean weren't genotyped due to lack of material
  div_df %<>%
    left_join(., urb, by = "patch_id") %>%
    dplyr::mutate(patch_id = as.factor(patch_id),
                  pop_id = as.factor(pop_id)) %>%


# make new columns: u_r_dist & u_r_usc (urban or rural)
# this column is different from urb_rur, which I made when scouting sites for the 100 populations. I don't have those types of designations for the sites I imported from my previous observational study (note the NAs). So I'll calculate two new columns that assign a population an "urban" or "rural" status based on its distance from city center (u_r_dist) or urbanization score (u_r_usc)
  dplyr::mutate(u_r_dist = case_when(
    City_dist <= 40 ~ "Urban",
    TRUE ~ "Rural")) %>%
  dplyr::mutate(u_r_usc = case_when(
    urb_score > 0 ~ "Urban",
    TRUE ~ "Rural"))
    
  return(div_df)
}

output_list %<>% lapply(., join_genetic_data)

# add min_maf values
for (i in seq_along(output_list)) {
  if (i < 7) {
    output_list[[i]]$min_maf <- as.factor(0)
  } else {
    output_list[[i]]$min_maf <- as.factor(0.05)
  }
}

# add -R values
for (i in seq_along(output_list)) {
  if (i == 1 || i == 7) {
    output_list[[i]]$R <- "0.0076"
  } else if (i == 2 || i == 8) {
    output_list[[i]]$R <- "0.01"
  } else if (i == 3 || i == 9) {
    output_list[[i]]$R <- "0.25"
  } else if (i == 4 || i == 10) {
    output_list[[i]]$R <- "0.5"
  } else if (i == 5 || i == 11) {
    output_list[[i]]$R <- "0.75"
  } else if (i == 6 || i == 12) {
    output_list[[i]]$R <- "1"
  } else {
    output_list[[i]]$R <- "0.0038"
  }
}


# separate dfs into individual objects
trial01 <- output_list[[file_list[01]]]
trial02 <- output_list[[file_list[02]]]
trial03 <- output_list[[file_list[03]]]
trial04 <- output_list[[file_list[04]]]
trial05 <- output_list[[file_list[05]]]
trial06 <- output_list[[file_list[06]]]
trial07 <- output_list[[file_list[07]]]
trial08 <- output_list[[file_list[08]]]
trial09 <- output_list[[file_list[09]]]
trial10 <- output_list[[file_list[10]]]
trial11 <- output_list[[file_list[11]]]
trial12 <- output_list[[file_list[12]]]
trial13 <- output_list[[file_list[13]]]
```

# How do -R values impact exp/obs homozygosity/heterozygosity?
## Urbanization is continuous
### Fit linear models/diagnostics
#### Set up function that fits lm and performs anova
```{r}
fit_analyze_lm <- function(formula, output_list) {
  
  # extract response and urbanization from the formula
  response <- sub("~.*", "", formula)
  urbanization <- sub(".*~\\s*", "", formula)
  
  # fit linear models to each data frame in the list
  lm_list <- lapply(output_list, function(df) {
    lm(formula, data = df)
  })
  
  # perform Anova and extract R-squared values for each linear model
  anova_list <- lapply(seq_along(output_list), function(i) {
    df <- output_list[[i]]
    lm <- lm_list[[i]]
    anova_result <- car::Anova(lm) %>%
      broom::tidy(car::Anova(lm))
    r_squared <- summary(lm)$r.squared
    min_maf <- df$min_maf[1]
    R <- df$R[1]
    data.frame(df_number = i,
               response = response,
               urbanization = urbanization,
               min_maf = min_maf,
               R = R,
               r_squared = r_squared,
               anova_result)
  })
  
  # combine the results into one data frame
  results_df <- do.call(rbind, anova_list)
  return(results_df)
}

```

#### Expected heterozygosity (Het_exp)
```{r}
##### City_dist
exp_het_dist_anova <- fit_analyze_lm("exp_het ~ City_dist",
                                     output_list)

##### Urb_score
exp_het_usc_anova <- fit_analyze_lm("exp_het ~ urb_score",
                                     output_list)
```

#### Observed heterozygosity (Het_obs)
```{r}
##### City_dist
obs_het_dist_anova <- fit_analyze_lm("obs_het ~ City_dist",
                                     output_list)

##### Urb_score
obs_het_usc_anova <- fit_analyze_lm("obs_het ~ urb_score",
                                     output_list)
```

#### Expected homozygosity (Hom_exp)
```{r}
##### City_dist
exp_hom_dist_anova <- fit_analyze_lm("exp_hom ~ City_dist",
                                     output_list)

##### Urb_score
exp_hom_usc_anova <- fit_analyze_lm("exp_hom ~ urb_score",
                                     output_list)
```

#### Observed homozygosity (Hom_obs)
```{r}
##### City_dist
obs_hom_dist_anova <- fit_analyze_lm("obs_hom ~ City_dist",
                                     output_list)

##### Urb_score
obs_hom_usc_anova <- fit_analyze_lm("obs_hom ~ urb_score",
                                     output_list)
```

### Figures
#### ANOVA
##### Expected heterozygosity
###### City_dist
```{r}

ex_het_dist <- ggplot(data = exp_het_dist_anova,
       aes(x = r_squared,
           y = p.value,
           label = R)) +
  geom_jitter(aes(
        #   shape = min_maf,
           fill = R),
       color = "black",
       shape = 21,
       width = 0.005,
       size = 2)  +
  ggtitle(label = "Expected Heterozygosity",
          subtitle = "Distance to the City Center (continuous)") +
  facet_wrap(facets = "min_maf",
             labeller = "label_both",
             strip.position = c("top")) +
  scale_fill_brewer(palette = "Spectral") +
  theme_bw() +
  labs_pubr()+
  theme(panel.spacing = unit(22, "pt")) 
ex_het_dist
# ggsave("Figures_Tables/comparing_R_minmaf/Exp_het_dist.png",
#        last_plot(),
#        width = 22,
#        height = 6,
#        units = "cm")

```

###### Urb_score
```{r}

ex_het_usc <- ggplot(data = exp_het_usc_anova,
       aes(x = r_squared,
           y = p.value,
           label = R)) +
  geom_jitter(aes(
        #   shape = min_maf,
           fill = R),
       color = "black",
       shape = 21,
       width = 0.0009,
       size = 2)  +
  ggtitle(label = "Expected Heterozygosity",
          subtitle = "Urbanization Score (continuous)") +
  facet_wrap(facets = "min_maf",
             labeller = "label_both",
             strip.position = c("top")) +
  scale_fill_brewer(palette = "Spectral") +
  theme_bw() +
  labs_pubr()+
  theme(panel.spacing = unit(22, "pt")) 
ex_het_usc
# ggsave("Figures_Tables/comparing_R_minmaf/Exp_het_usc.png",
#        last_plot(),
#        width = 22,
#        height = 6,
#        units = "cm")
```

##### Obs heterozygosity
###### City_dist
```{r}

obs_het_dist <- ggplot(data = obs_het_dist_anova,
       aes(x = r_squared,
           y = p.value,
           label = R)) +
  geom_jitter(aes(
        #   shape = min_maf,
           fill = R),
       color = "black",
       shape = 21,
       width = 0.008,
       size = 2)  +
  ggtitle(label = "Observed Heterozygosity",
          subtitle = "Distance to the City Center (continuous)") +
  facet_wrap(facets = "min_maf",
             labeller = "label_both",
             strip.position = c("top")) +
  scale_fill_brewer(palette = "Spectral") +
  theme_bw() +
  labs_pubr()+
  theme(panel.spacing = unit(22, "pt")) 
obs_het_dist
# ggsave("Figures_Tables/comparing_R_minmaf/obs_het_dist.png",
#        last_plot(),
#        width = 22,
#        height = 6,
#        units = "cm")

```

###### Urb_score
```{r}

obs_het_usc <- ggplot(data = obs_het_usc_anova,
       aes(x = r_squared,
           y = p.value,
           label = R)) +
  geom_jitter(aes(
        #   shape = min_maf,
           fill = R),
       color = "black",
       shape = 21,
       width = 0.009,
       size = 2)  +
  ggtitle(label = "Observed Heterozygosity",
          subtitle = "Urbanization Score (continuous)") +
  facet_wrap(facets = "min_maf",
             labeller = "label_both",
             strip.position = c("top")) +
  scale_fill_brewer(palette = "Spectral") +
  theme_bw() +
  labs_pubr()+
  theme(panel.spacing = unit(22, "pt")) 
obs_het_usc
# ggsave("Figures_Tables/comparing_R_minmaf/obs_het_usc.png",
#        last_plot(),
#        width = 22,
#        height = 6,
#        units = "cm")
```

##### Expected homozygosity
###### City_dist
```{r}

ex_hom_dist <- ggplot(data = exp_hom_dist_anova,
       aes(x = r_squared,
           y = p.value,
           label = R)) +
  geom_jitter(aes(
        #   shape = min_maf,
           fill = R),
       color = "black",
       shape = 21,
       width = 0.005,
       size = 2)  +
  ggtitle(label = "Expected Homozygosity",
          subtitle = "Distance to the City Center (continuous)") +
  facet_wrap(facets = "min_maf",
             labeller = "label_both",
             strip.position = c("top")) +
  scale_fill_brewer(palette = "Spectral") +
  theme_bw() +
  labs_pubr()+
  theme(panel.spacing = unit(22, "pt")) 
ex_hom_dist
# ggsave("Figures_Tables/comparing_R_minmaf/Exp_hom_dist.png",
#        last_plot(),
#        width = 22,
#        height = 6,
#        units = "cm")

```

###### Urb_score
```{r}

ex_hom_usc <- ggplot(data = exp_hom_usc_anova,
       aes(x = r_squared,
           y = p.value,
           label = R)) +
  geom_jitter(aes(
        #   shape = min_maf,
           fill = R),
       color = "black",
       shape = 21,
       width = 0.0007,
       size = 2)  +
  ggtitle(label = "Expected Homozygosity",
          subtitle = "Urbanization Score (continuous)") +
  facet_wrap(facets = "min_maf",
             labeller = "label_both",
             strip.position = c("top")) +
  scale_fill_brewer(palette = "Spectral") +
  theme_bw() +
  labs_pubr()+
  theme(panel.spacing = unit(22, "pt")) 
ex_hom_usc
# ggsave("Figures_Tables/comparing_R_minmaf/Exp_hom_usc.png",
#        last_plot(),
#        width = 22,
#        height = 6,
#        units = "cm")
```

##### Obs homozygosity
###### City_dist
```{r}

obs_hom_dist <- ggplot(data = obs_hom_dist_anova,
       aes(x = r_squared,
           y = p.value,
           label = R)) +
  geom_jitter(aes(
        #   shape = min_maf,
           fill = R),
       color = "black",
       shape = 21,
       width = 0.001,
       size = 2)  +
  ggtitle(label = "Observed Homozygosity",
          subtitle = "Distance to the City Center (continuous)") +
  facet_wrap(facets = "min_maf",
             labeller = "label_both",
             strip.position = c("top")) +
  scale_fill_brewer(palette = "Spectral") +
  theme_bw() +
  labs_pubr()+
  theme(panel.spacing = unit(22, "pt")) 
obs_hom_dist
# ggsave("Figures_Tables/comparing_R_minmaf/obs_hom_dist.png",
#        last_plot(),
#        width = 22,
#        height = 6,
#        units = "cm")

```

###### Urb_score
```{r}

obs_hom_usc <- ggplot(data = obs_hom_usc_anova,
       aes(x = r_squared,
           y = p.value,
           label = R)) +
  geom_jitter(aes(
        #   shape = min_maf,
           fill = R),
       color = "black",
       shape = 21,
       width = 0.0009,
       size = 2)  +
  ggtitle(label = "Observed Homozygosity",
          subtitle = "Urbanization Score (continuous)") +
  facet_wrap(facets = "min_maf",
             labeller = "label_both",
             strip.position = c("top")) +
  scale_fill_brewer(palette = "Spectral") +
  theme_bw() +
  labs_pubr()+
  theme(panel.spacing = unit(22, "pt")) 
obs_hom_usc
# ggsave("Figures_Tables/comparing_R_minmaf/obs_hom_usc.png",
#        last_plot(),
#        width = 22,
#        height = 6,
#        units = "cm")
```

##### All
```{r}
library(patchwork)

# heterozygosity plots
ex_het_dist + ex_het_usc + obs_het_dist + obs_het_usc

ggsave("Figures_Tables/comparing_R_minmaf/heterozygosity_all.png",
       last_plot(),
       width = 30,
       height = 15,
       units = "cm")


# homozygosity plots
ex_hom_dist + ex_hom_usc + obs_hom_dist + obs_hom_usc

ggsave("Figures_Tables/comparing_R_minmaf/homozygosity_all.png",
       last_plot(),
       width = 30,
       height = 15,
       units = "cm")
```

#### Regressions
##### Expected heterozygosity
###### City_dist
```{r}

# Create a list to store the plots
plot_list <- list()

# Loop over the data frames and create a ggplot2 regression for each one
for (i in 1:13) {
  p <- ggplot(output_list[[i]],
              aes(x = City_dist, y = exp_het)) +
    geom_point() +
    geom_smooth(method = "lm") +
    labs(title = paste("Trial", i)) +
    ylim(0,0.3) +
    theme_bw() +
    labs_pubr()
    
  plot_list[[i]] <- p
}

# Arrange the plots using patchwork
regressions_exp_het_dist <- wrap_plots(plot_list) +
  plot_layout(ncol = 6)
  
regressions_exp_het_dist

ggsave("Figures_Tables/comparing_R_minmaf/exp_het_regressions_dist.png",
       last_plot(),
       width = 30,
       height = 15,
       units = "cm")
```

###### Urb_score
```{r}

# Create a list to store the plots
plot_list <- list()

# Loop over the data frames and create a ggplot2 regression for each one
for (i in 1:13) {
  p <- ggplot(output_list[[i]],
              aes(x = urb_score, y = exp_het)) +
    geom_point() +
    geom_smooth(method = "lm") +
    labs(title = paste("Trial", i)) +
    ylim(0,0.3) +
    xlim(4, -4) +
    theme_bw() +
    labs_pubr()
    
  plot_list[[i]] <- p
}

# Arrange the plots using patchwork
regressions_exp_het_usc <- wrap_plots(plot_list) +
  plot_layout(ncol = 6)
  
regressions_exp_het_usc

ggsave("Figures_Tables/comparing_R_minmaf/exp_het_regressions_usc.png",
       last_plot(),
       width = 30,
       height = 15,
       units = "cm")
```



##### Observed heterozygosity
###### City_dist
```{r}

# Create a list to store the plots
plot_list <- list()

# Loop over the data frames and create a ggplot2 regression for each one
for (i in 1:13) {
  p <- ggplot(output_list[[i]],
              aes(x = City_dist, y = obs_het)) +
    geom_point() +
    geom_smooth(method = "lm") +
    labs(title = paste("Trial", i)) +
    ylim(0,0.6) +
    theme_bw() +
    labs_pubr()
    
  plot_list[[i]] <- p
}

# Arrange the plots using patchwork
regressions_obs_het_dist <- wrap_plots(plot_list) +
  plot_layout(ncol = 6)
  
regressions_obs_het_dist

ggsave("Figures_Tables/comparing_R_minmaf/obs_het_regressions_dist.png",
       last_plot(),
       width = 30,
       height = 15,
       units = "cm")
```

###### Urb_score
```{r}

# Create a list to store the plots
plot_list <- list()

# Loop over the data frames and create a ggplot2 regression for each one
for (i in 1:13) {
  p <- ggplot(output_list[[i]],
              aes(x = urb_score, y = obs_het)) +
    geom_point() +
    geom_smooth(method = "lm") +
    labs(title = paste("Trial", i)) +
    ylim(0,0.6) +
    xlim(4, -4) +
    theme_bw() +
    labs_pubr()
    
  plot_list[[i]] <- p
}

# Arrange the plots using patchwork
regressions_obs_het_usc <- wrap_plots(plot_list) +
  plot_layout(ncol = 6)
  
regressions_obs_het_usc

ggsave("Figures_Tables/comparing_R_minmaf/obs_het_regressions_usc.png",
       last_plot(),
       width = 30,
       height = 15,
       units = "cm")
```




##### Expected Homozygosity
###### City_dist
```{r}

# Create a list to store the plots
plot_list <- list()

# Loop over the data frames and create a ggplot2 regression for each one
for (i in 1:13) {
  p <- ggplot(output_list[[i]],
              aes(x = City_dist, y = exp_hom)) +
    geom_point() +
    geom_smooth(method = "lm") +
    labs(title = paste("Trial", i)) +
    ylim(0.7,1) +
    theme_bw() +
    labs_pubr()
    
  plot_list[[i]] <- p
}

# Arrange the plots using patchwork
regressions_exp_hom_dist <- wrap_plots(plot_list) +
  plot_layout(ncol = 6)
  
regressions_exp_hom_dist

ggsave("Figures_Tables/comparing_R_minmaf/exp_hom_regressions_dist.png",
       last_plot(),
       width = 30,
       height = 15,
       units = "cm")
```

###### Urb_score
```{r}

# Create a list to store the plots
plot_list <- list()

# Loop over the data frames and create a ggplot2 regression for each one
for (i in 1:13) {
  p <- ggplot(output_list[[i]],
              aes(x = urb_score, y = exp_hom)) +
    geom_point() +
    geom_smooth(method = "lm") +
    labs(title = paste("Trial", i)) +
    ylim(0.7,1) +
    xlim(4, -4) +
    theme_bw() +
    labs_pubr()
    
  plot_list[[i]] <- p
}

# Arrange the plots using patchwork
regressions_exp_hom_usc <- wrap_plots(plot_list) +
  plot_layout(ncol = 6)
  
regressions_exp_hom_usc

ggsave("Figures_Tables/comparing_R_minmaf/exp_hom_regressions_usc.png",
       last_plot(),
       width = 30,
       height = 15,
       units = "cm")
```

##### Observed Homozygosity
###### City_dist
```{r}

# Create a list to store the plots
plot_list <- list()

# Loop over the data frames and create a ggplot2 regression for each one
for (i in 1:13) {
  p <- ggplot(output_list[[i]],
              aes(x = City_dist, y = obs_hom)) +
    geom_point() +
    geom_smooth(method = "lm") +
    labs(title = paste("Trial", i)) +
    ylim(0.45,1) +
    theme_bw() +
    labs_pubr()
    
  plot_list[[i]] <- p
}

# Arrange the plots using patchwork
regressions_obs_hom_dist <- wrap_plots(plot_list) +
  plot_layout(ncol = 6)
  
regressions_obs_hom_dist

ggsave("Figures_Tables/comparing_R_minmaf/obs_hom_regressions_dist.png",
       last_plot(),
       width = 30,
       height = 15,
       units = "cm")
```

###### Urb_score
```{r}

# Create a list to store the plots
plot_list <- list()

# Loop over the data frames and create a ggplot2 regression for each one
for (i in 1:13) {
  p <- ggplot(output_list[[i]],
              aes(x = urb_score, y = obs_hom)) +
    geom_point() +
    geom_smooth(method = "lm") +
    labs(title = paste("Trial", i)) +
    ylim(0.45,1) +
    xlim(4, -4) +
    theme_bw() +
    labs_pubr()
    
  plot_list[[i]] <- p
}

# Arrange the plots using patchwork
regressions_obs_hom_usc <- wrap_plots(plot_list) +
  plot_layout(ncol = 6)
  
regressions_obs_hom_usc

ggsave("Figures_Tables/comparing_R_minmaf/obs_hom_regressions_usc.png",
       last_plot(),
       width = 30,
       height = 15,
       units = "cm")
```


## Urbanization is categorical

## Compare expected w/observed heterozygosity, homozygosity
### Create table
```{r}
# Create an empty list to store results
chisq_results <- list()

# Loop through each dataframe and perform chi square test
for (i in seq_along(output_list)) {
  
  chisq_test_hom_het <- chisq.test(
    output_list[[i]]$obs_hom, 
    output_list[[i]]$exp_hom)
  
  
  chisq_results[[i]] <- data.frame(
    trial = i,
    R = output_list[[i]]$R[1],
    min_maf = output_list[[i]]$min_maf[1],
    statistic = chisq_test_hom_het$statistic,
    df = chisq_test_hom_het$parameter,
    p = chisq_test_hom_het$p.value
    
  )
}

# Combine all results into one table
all_chisq_results <- do.call(rbind, chisq_results) %>%
  dplyr::mutate(p = round(p, 3)) %>%
  dplyr::mutate(p = ifelse(p < 0.001, "<0.001", p))

all_chisq_results %>%
  flextable() %>%
  flextable::compose(i = 1, j = 4, part = "header",
                     value = as_paragraph("Î§", as_sup("2"))) %>%
  flextable::set_caption("Chi Square Tests") %>%
  flextable::autofit() %>%
  #flextable::save_as_image("Figures_Tables/comparing_R_minmaf/ChiSq_tests.png") %>%
  flextable::save_as_docx(path = "Figures_Tables/comparing_R_minmaf/ChiSq_tests.docx")
```

### Create basic graph
```{r}
# create labels for only 3 super-close points
all_chisq_results$label <- all_chisq_results$R
all_chisq_results$label[c(1:6, 9:13)] <- ""

ggplot(data = all_chisq_results %>%
         dplyr::filter(min_maf == 0.05) %>%
         dplyr::mutate(p = ifelse(p == "<0.001", 0.001, p)) %>%
         dplyr::mutate(p = as.numeric(p)) %>%
         dplyr::mutate(R = as.numeric(R)),
        aes(x = R,
            y = p,
            label = label)) +
    geom_line(color = "blue",
            size = 1) +
    ggrepel::geom_label_repel(
    aes(R, p, label = label),
    nudge_y = -0.015) +
  geom_point(color = "blue",
             fill = "orange",
             size = 3,
             shape = 21) +
  ggpubr::theme_pubr()

ggsave("Figures_Tables/comparing_R_minmaf/chisq_graph.png", last_plot())

```



These analyses use the narrow, conservative genetic dataset:
-R = 0.75 & -min_maf = 0.05

# Set up notebook
## Load libraries & functions
```{r warning=F}
source(here::here("libraries.R"))
source(here::here("functions.R"))
```

## Import data
### Urbanization data
```{r}
urb <- read.csv(here::here("./clean_data/urb_metrics.csv")) %>%
  dplyr::mutate(site_id = as.factor(site_id),
                patch_id = as.factor(patch_id),
                urb_rur = as.factor(urb_rur),
                quadrant = as.factor(quadrant),
                river_valley = as.factor(river_valley)
                )
```

### Genetic data
```{r}

fis <- here::here("./populations_no-IBD_vcf-all_mainfiles/mmaf0.05_R0.75/populations.sumstats_summary.tsv") %>%
  extract_variant_position_summary() %>%
# if population doesn't start with "MWI", it should start with "MW"
  # clean names
  janitor::clean_names() %>%
  # rename col 1
  dplyr::rename(pop_id = 1) %>%
  dplyr::mutate(pop_id = as.factor(pop_id)) %>%

### Add "MW" to numeric populations
  add_MW_IDs() %>%


## Join genetic data with urbanization data

# left vs. full join because some populations in urb_clean weren't genotyped due to lack of material
  left_join(., urb, by = "patch_id") %>%
  dplyr::mutate(patch_id = as.factor(patch_id),
                pop_id = as.factor(pop_id)) %>%
  
  dplyr::select(patch_id, num_indv, fis, urb_score:u_r_usc)

```

# Explore/clean data
```{r}
# regress fis vs. individuals/pop
ggplot(fis, 
       aes(x = num_indv,
           y = fis)) + 
  geom_smooth(method=lm,
              color = "black",
              se=FALSE) +
  geom_point(aes(color = City_dist),
             size = 2) +
  scale_color_continuous(type = "viridis") +
  ggpubr::theme_pubr()

# this (and the df) shows us that populations with 1 individual all have fis = 0.
# I'll remove them from this analysis' dataset.


fis %<>%
  dplyr::filter(num_indv != 1)


# regress fis vs. city dist
ggplot(fis, 
       aes(x = City_dist,
           y = fis)) + 
  geom_smooth(method=lm,
              color = "black",
              se=FALSE) +
  geom_point(aes(size = num_indv,
                 color = City_dist)) +
  scale_color_continuous(type = "viridis") +
  ggpubr::theme_pubr()

range(fis$fis)
```

# Compute means per group, w/o accounting for diffs in pop size
## Urban
```{r}
# Urbanization = distance to city center
fis_u_dist <- fis %>%
  dplyr::filter(u_r_dist == "Urban") %>%
  dplyr::select(fis) %>%
  colMeans() %>%
  round(4) %T>%
  print()

# Urbanization = urbanization score
fis_u_usc <- fis %>%
  dplyr::filter(u_r_usc == "Urban") %>%
  dplyr::select(fis) %>%
  colMeans() %>%
  round(4) %T>%
  print()
```

## Rural
```{r}
# Urbanization = distance to city center
fis_r_dist <- fis %>%
  dplyr::filter(u_r_dist == "Rural") %>%
  dplyr::select(fis) %>%
  colMeans() %>%
  round(4) %T>%
  print()

# Urbanization = urbanization score
fis_r_usc <- fis %>%
  dplyr::filter(u_r_usc == "Rural") %>%
  dplyr::select(fis) %>%
  colMeans() %>%
  round(4) %T>%
  print()
```

## Put into table
```{r}
fis_summary <- data.frame(
  Urbanization = c("Distance to City Center", "Urbanization Score",
                   "Distance to City Center", "Urbanization Score"),
  Environment = c("Urban", "Urban",
                  "Rural", "Rural"),
  FIS = c(fis_u_dist, fis_u_usc,
          fis_r_dist, fis_r_usc))

fis_summary_wide <- fis_summary %>%
  pivot_wider(names_from = Environment, 
              values_from = FIS)

# Print the wide table
print(fis_summary_wide)
```


# Compute means per group, accounting for diffs in pop size
## Urban
```{r}
# Urbanization = distance to city center
fis_u_dist2 <- fis %>%
  dplyr::filter(u_r_dist == "Urban") %>%
  dplyr::mutate(fis_per_indv = fis/num_indv) %>%
  dplyr::select(fis_per_indv) %>%
  colMeans() %>%
  round(4) %T>%
  print()

# Urbanization = urbanization score
fis_u_usc2 <- fis %>%
  dplyr::filter(u_r_usc == "Urban") %>%
  dplyr::mutate(fis_per_indv = fis/num_indv) %>%
  dplyr::select(fis_per_indv) %>%
  colMeans() %>%
  round(4) %T>%
  print()
```

## Rural
```{r}
# Urbanization = distance to city center
fis_r_dist2 <- fis %>%
  dplyr::filter(u_r_dist == "Rural") %>%
  dplyr::mutate(fis_per_indv = fis/num_indv) %>%
  dplyr::select(fis_per_indv) %>%
  colMeans() %>%
  round(4) %T>%
  print()

# Urbanization = urbanization score
fis_r_usc2 <- fis %>%
  dplyr::filter(u_r_usc == "Rural") %>%
  dplyr::mutate(fis_per_indv = fis/num_indv) %>%
  dplyr::select(fis_per_indv) %>%
  colMeans() %>%
  round(4) %T>%
  print()
```


## Put means into table
```{r}
fis_summary2 <- data.frame(
  Urbanization = c("Distance to City Center", "Urbanization Score",
                   "Distance to City Center", "Urbanization Score"),
  Environment = c("Urban", "Urban",
                  "Rural", "Rural"),
  FIS = c(fis_u_dist2, fis_u_usc2,
          fis_r_dist2, fis_r_usc2))

fis_summary_wide2 <- fis_summary2 %>%
  pivot_wider(names_from = Environment, 
              values_from = FIS)

print(fis_summary_wide2)
```


## Export tables
```{r}
fis_summary_wide %>%
  flextable() %>%
  flextable::autofit() %>%
  save_as_docx(path = here::here("./Figures_Tables/fis/FIS.docx"))


fis_summary_wide2 %>%
  flextable() %>%
  flextable::autofit() %>%
  save_as_docx(path = here::here("./Figures_Tables/fis/FIS_per_indiv.docx"))
```

# Figures
## Group means w/o accounting for diffs in pop size
### Urb=dist
```{r}
plot_dist1 <- ggplot(data = fis,
       aes(x = u_r_dist,
           y = fis)) +
  geom_violin(aes(fill = u_r_dist,
                  color = u_r_dist),
              alpha = 0.5) +
  geom_boxplot(width = 0.1,
               fill = "white") +
  # geom_jitter(shape = 16,
  #             position = position_jitter(0.1)) +
  # geom_dotplot(binaxis='y', stackdir='center', dotsize=1) +
  ggpubr::theme_pubr(legend = "none") +
  xlab("Urbanization\n(Distance to City Center)") +
  ylab(expression("F" ["IS"])) +
  scale_fill_viridis_d(option = "viridis", end = 0.4) +
  scale_color_viridis_d(option = "viridis", end = 0.4)
```

### Urb=usc
```{r}
plot_usc1 <- ggplot(data = fis,
       aes(x = u_r_usc,
           y = fis)) +
  geom_violin(aes(fill = u_r_usc,
                  color = u_r_usc),
              alpha = 0.5
              ) +
  geom_boxplot(width = 0.1,
               fill = "white") +
  # geom_jitter(shape = 16,
  #             position = position_jitter(0.1)) +
  # geom_dotplot(binaxis='y', stackdir='center', dotsize=1) +
  ggpubr::theme_pubr(legend = "none") +
  xlab("Urbanization\n(Urbanization Score)") +
  ylab(expression("F" ["IS"])) +
  scale_fill_viridis_d(option = "viridis", end = 0.4) +
  scale_color_viridis_d(option = "viridis", end = 0.4)
```


## Group means accounting for diffs in pop size
### Urb=dist
```{r}
plot_dist2 <- ggplot(data = fis,
       aes(x = u_r_dist,
           y = fis/num_indv)) +
  geom_violin(aes(fill = u_r_dist,
                  color = u_r_dist),
              alpha = 0.5) +
  geom_boxplot(width = 0.1,
               fill = "white") +
  # geom_jitter(shape = 16,
  #             position = position_jitter(0.1)) +
  # geom_dotplot(binaxis='y', stackdir='center', dotsize=1) +
  ggpubr::theme_pubr(legend = "none") +
  xlab("Urbanization\n(Distance to City Center)") +
  ylab(expression("F"[IS]~"(per individual)")) +
  scale_fill_viridis_d(option = "viridis", end = 0.4) +
  scale_color_viridis_d(option = "viridis", end = 0.4)
```

### Urb=usc
```{r}
plot_usc2 <- ggplot(data = fis,
       aes(x = u_r_usc,
           y = fis/num_indv)) +
  geom_violin(aes(fill = u_r_usc,
                  color = u_r_usc),
              alpha = 0.5
              ) +
  geom_boxplot(width = 0.1,
               fill = "white") +
  # geom_jitter(shape = 16,
  #             position = position_jitter(0.1)) +
  # geom_dotplot(binaxis='y', stackdir='center', dotsize=1) +
  ggpubr::theme_pubr(legend = "none") +
  xlab("Urbanization\n(Urbanization Score)") +
  ylab(expression("F"[IS]~"(per individual)")) +
  scale_fill_viridis_d(option = "viridis", end = 0.4) +
  scale_color_viridis_d(option = "viridis", end = 0.4)
```

## Export
```{r}
(plot_dist1 + plot_usc1) /
(plot_dist2 + plot_usc2)

ggsave(plot = last_plot(),
       filename = here::here("./Figures_Tables/fis/fis.png"),
       height = 15,
       width = 20,
       units = "cm")
```


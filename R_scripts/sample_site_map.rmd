# Set up notebook
## Load packages
```{r}
source(here::here("libraries.R"))
source(here::here("functions.R"))
```

## Import data
```{r}
urb <- read.csv(here::here("./clean_data/urb_metrics.csv")) %>%
  dplyr::mutate(site_id = as.factor(site_id),
                patch_id = as.factor(patch_id),
                urb_rur = as.factor(urb_rur),
                quadrant = as.factor(quadrant),
                river_valley = as.factor(river_valley)
                ) 


all_sites <- read.csv(here::here("./genomic_resources/pop_map3.csv")) %>%
    # rename col 1
  dplyr::rename(pop_id = 2) %>%
  dplyr::mutate(pop_id = as.factor(pop_id)) %>%
### Add "MW" to numeric populations
  add_MW_IDs()

# keep only the sampling sites for which I sequenced DNA
sites <- left_join(all_sites,
                   urb)

# check
length(unique(sites$patch_id))


max(sites$City_dist) # max City_dist
min(sites$City_dist) # min City_dist

max(sites$urb_score) # max Urb Score
min(sites$urb_score) # min Urb Score

# Number of rural vs urban sites
# first, make df with only unique sites
sites_unique <- sites %>%
  dplyr::group_by(patch_id) %>%
  dplyr::summarise(u_r_dist = first(u_r_dist),
                   u_r_usc = first(u_r_usc))

sum(sites_unique$u_r_dist == "Urban")
sum(sites_unique$u_r_dist == "Rural")
sum(sites_unique$u_r_usc == "Urban")
sum(sites_unique$u_r_usc == "Rural")

```

# Sampling site maps
## Main map: Urban/rural symbols
### Based on distance to CC
```{r}
mylocation <- c(-80.5, 43.2, -78.5, 44.2)
base_map <- ggmap(get_map(location = mylocation, maptype = 'terrain', source = "stamen"))

 map1 <- base_map +
  geom_point(data = sites, 
             mapping = aes(x = long, 
                           y = lat,
                           fill=u_r_dist,
                           shape=u_r_dist),
             size=3) +
  labs(x = 'Longitude', 
       y = 'Latitude',
       fill = "Site Classification") +
   scale_shape_manual(name = "Site Classification",
                     values = c(24,21)) +
   scale_fill_manual(name = "Site Classification",
                    values = c('red', 'cyan')) +
   scalebar(x.min = -80.5, x.max = -78.6,
            y.min = 43.25, y.max = 44.2,
            dist = 20, dist_unit = "km",
            st.bottom = FALSE, st.color = "black",
            transform = TRUE, model = 'WGS84',
           st.dist=.04) +
  theme(legend.position = c(0.85, 0.25),
        legend.background = element_rect(fill = "white",
                                         colour = "black"),
        legend.box.margin = margin(6, 6, 6, 6)) 
 
north2(map1, x = .679, y = .3, scale = 0.11, symbol = 1)


# Export
dev.copy2pdf(file = here::here("./Figures_Tables/sample_site_map/pops_urb_rur_based-on-city_dist.pdf"),
             width = 7.5, height = 5)

# export as png too
png(here::here("./Figures_Tables/sample_site_map/pops_urb_rur_based-on-city_dist.png"),
             width = 20, height = 12.5,
    units = "cm",
    res = 720)

north2(map1, x = .679, y = .3, scale = 0.11, symbol = 1)

dev.off()
```

### Based on urb score
```{r}
map2 <- base_map +
  geom_point(data = sites,
             mapping = aes(x = long, 
                           y = lat, 
                           fill=u_r_usc, 
                           shape=u_r_usc), 
             size=3) +
  labs(x = 'Longitude',
       y = 'Latitude',
       fill = "Site Classification") +
  scale_shape_manual(name = "Site Classification",
                     values = c(24,21)) +
  scale_fill_manual(name = "Site Classification",
                    values = c('red', 'cyan')) +
  scalebar(x.min = -80.5,
           x.max = -78.6,
           y.min = 43.25,
           y.max = 44.2,
           dist = 20, 
           dist_unit = "km",
           st.bottom = FALSE,
           st.color = "black",
           transform = TRUE,
           model = 'WGS84',
           st.dist=.04) +
  theme(legend.position = c(0.85, 0.25),
        legend.background = element_rect(fill = "white",
                                         colour = "black"),
        legend.box.margin = margin(6, 6, 6, 6)        ) 

north2(map2, x = .679, y = .3, scale = 0.11, symbol = 1)


# Export
dev.copy2pdf(file = here::here("./Figures_Tables/sample_site_map/pops_urb_rur_based-on-urb_score.pdf"),
             width = 7.5, height = 5)
```

## Main map: Distance to CC
```{r}
map1_dist <- base_map +
  geom_point(data = urb_scores,
             mapping = aes(x = long,
                           y = lat,
                           fill = City_dist),
             size = 3,
             shape = 23,
             color = "black") +
  labs(x = 'Longitude', 
       y = 'Latitude', 
       fill = "Urbanization Score") +
  scale_fill_gradient(low = "dark red", high = "white",
                      #breaks=c(-4, -2, 0, 2, 4),
                      labels=c("0 (Urban)", 20, 40, 60, "80 (Rural)"),
                       limits=c(0, 80),
                      name = "Distance to \nCity Center (km)"
                      ) +
  scalebar(x.min = -80.5,
           x.max = -78.6,
            y.min = 43.25, 
           y.max = 44.2,
            dist = 20, 
           dist_unit = "km",
            st.bottom = FALSE, 
           st.color = "black",
            transform = TRUE,
           model = 'WGS84',
           st.dist=.04) +
  theme(
    legend.position = c(0.85, 0.37),
        legend.background = element_rect(fill = "white",
                                         colour = "black"),
        legend.box.margin = margin(6, 6, 6, 6)) 

north2(map1_dist, x = .679, y = .3, scale = 0.11, symbol = 1)


# Export
dev.copy2pdf(file = here::here("./Figures_Tables/sample_site_map/gta_sampling_citydist.pdf"),
             width = 7.5, height = 5)
```


## Main map: urbanization score
```{r}

map1_usc <- base_map +
  geom_point(data = urb_scores,
             mapping = aes(x = long,
                           y = lat,
                           fill = urb_score),
             size = 3,
             shape = 21,
             color = "black") +
  labs(x = 'Longitude', 
       y = 'Latitude', 
       fill = "Urbanization Score") +
  scale_fill_gradient(low = "white", high = "dark red",
                      breaks=c(-4, -2, 0, 2, 4),
                      labels=c("-4 (Rural)", -2, 0, 2, "4 (Urban)"),
                      limits=c(-4, 4),
                      name = "Urbanization Score"
                      ) +
  scalebar(x.min = -80.5,
           x.max = -78.6,
            y.min = 43.25, 
           y.max = 44.2,
            dist = 20, 
           dist_unit = "km",
            st.bottom = FALSE, 
           st.color = "black",
            transform = TRUE,
           model = 'WGS84',
           st.dist=.04) +
  theme(
    legend.position = c(0.85, 0.37),
        legend.background = element_rect(fill = "white",
                                         colour = "black"),
        legend.box.margin = margin(6, 6, 6, 6)) 

north2(map1_usc, x = .679, y = .3, scale = 0.11, symbol = 1)


# Export
dev.copy2pdf(file = here::here("./Figures_Tables/sample_site_map/gta_sampling_urbscore.pdf"),
             width = 7.5, height = 5)
```

# Adding river valley markers
```{r}
# first need to find out which sites are characterized as being near a river valley...
# need the greenbelt planning map
# then have to put coordinates in those cells and assign them


map3 <- map1 + 

north2(map3, x = .679, y = .3, scale = 0.11, symbol = 1)

```

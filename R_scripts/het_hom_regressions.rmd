---
title: Comparing continuous/categorical urbanization data with variant only genetic data
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
    number_sections: true
    theme: lumen
---

will use broadest genetic dataset possible
-R < 1 & -min_maf < 0.05

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

# Set up notebook
## Load libraries & functions
```{r warning=F}
source(here::here("libraries.R"))
source(here::here("functions.R"))
```

## Import data
### Urbanization data
```{r}
urb <- read.csv(here::here("./clean_data/urb_metrics.csv")) %>%
  dplyr::mutate(site_id = as.factor(site_id),
                patch_id = as.factor(patch_id),
                urb_rur = as.factor(urb_rur),
                quadrant = as.factor(quadrant),
                river_valley = as.factor(river_valley)
                )
```

### Genetic data
```{r}
# replace this file after I finalize -R and -min_maf
# input_file <- here::here("./summary_stats/trial_02/output_refmap_run2/populations.sumstats_summary.tsv")


div <- extract_variant_position_summary(input_file) %>%
# if population doesn't start with "MWI", it should start with "MW"
  # clean names
  janitor::clean_names() %>%
  # rename col 1
  dplyr::rename(pop_id = 1) %>%
  dplyr::mutate(pop_id = as.factor(pop_id))


# take entries with numeric populations and add "MW" as prefix
diversity_variant_sites <- add_MW_IDs(div)

```

## Join genetic data with urbanization data
```{r}
# left vs. full join because some populations in urb_clean weren't genotyped due to lack of material
diversity_variant_sites %<>%
  left_join(., urb, by = "patch_id") %>%
  dplyr::mutate(patch_id = as.factor(patch_id),
                pop_id = as.factor(pop_id))


# make new columns: u_r_dist & u_r_usc (urban or rural)
# this column is different from urb_rur, which I made when scouting sites for the 100 populations. I don't have those types of designations for the sites I imported from my previous observational study (note the NAs). So I'll calculate two new columns that assign a population an "urban" or "rural" status based on its distance from city center (u_r_dist) or urbanization score (u_r_usc)
diversity_variant_sites %<>%
  dplyr::mutate(u_r_dist = case_when(
    City_dist <= 40 ~ "Urban",
    TRUE ~ "Rural")) %>%
  dplyr::mutate(u_r_usc = case_when(
    urb_score > 0 ~ "Urban",
    TRUE ~ "Rural"))

```

# Does urbanization predict genetic diversity within pops?
## Explore data
```{r}
str(diversity_variant_sites)

head(diversity_variant_sites)

diversity_variant_sites %>%
  dplyr::select(1, 3, 4, "exp_het", "obs_het", "exp_hom", "obs_hom", "City_dist", "urb_score") %>%
  view

# quick boxplots
boxplot(diversity_variant_sites$obs_het)
boxplot(diversity_variant_sites$exp_het)
boxplot(diversity_variant_sites$obs_hom)
boxplot(diversity_variant_sites$exp_hom)

# quick regressions of genetic vars against distance from cc

qplot(data = diversity_variant_sites,
      City_dist, obs_het)

qplot(data = diversity_variant_sites,
      City_dist, exp_het)

qplot(data = diversity_variant_sites,
      City_dist, obs_hom)

qplot(data = diversity_variant_sites,
      City_dist, exp_hom)

qplot(data = diversity_variant_sites,
      exp_het, obs_het)

qplot(data = diversity_variant_sites,
      City_dist, num_indv)

# regress all selected variables against one another
diversity_variant_sites %>%
  dplyr::select( exp_het, obs_het, exp_hom, obs_hom, num_indv, urb_score, City_dist) %>%
  pairs()


# does urb correlated with other population descriptors?

## number of individuals/population
test1 <- glmmTMB(City_dist ~ num_indv, diversity_variant_sites)
performance::check_model(test1)
car::Anova(test1) # yes
r.squaredGLMM(test1) # ~4% variance explained
```

## Urbanization is continuous
### Fit linear models/diagnostics
#### Expected heterozygosity (Het_exp)
##### City_dist
```{r}
Het_exp_dist <- glmmTMB(exp_het ~ City_dist,
           diversity_variant_sites)

performance::check_model(Het_exp_dist)
```

##### Urb_score
```{r}
Het_exp_usc <- glmmTMB(exp_het ~ urb_score,
           diversity_variant_sites)

performance::check_model(Het_exp_usc)
```

#### Observed heterozygosity (Het_obs)
##### City_dist
```{r}
Het_obs_dist <- glmmTMB(obs_het ~ City_dist,
           diversity_variant_sites)

performance::check_model(Het_obs_dist)
```

##### Urb_score
```{r}
Het_obs_usc <- glmmTMB(obs_het ~ urb_score,
           diversity_variant_sites)

performance::check_model(Het_obs_usc)
```

#### Expected homozygosity (Hom_exp)
##### City_dist
```{r}
Hom_exp_dist <- glmmTMB(exp_hom ~ City_dist,
           diversity_variant_sites)

performance::check_model(Hom_exp_dist)
```

##### Urb_score
```{r}
Hom_exp_usc <- glmmTMB(exp_hom ~ urb_score,
           diversity_variant_sites)

performance::check_model(Hom_exp_usc)
```


#### Observed homozygosity (Hom_obs)
##### City_dist
```{r}
Hom_obs_dist <- glmmTMB(obs_hom ~ City_dist,
           diversity_variant_sites)

performance::check_model(Hom_obs_dist)
```

##### Urb_score
```{r}
Hom_obs_usc <- glmmTMB(obs_hom ~ urb_score,
           diversity_variant_sites)

performance::check_model(Hom_obs_usc)
```

### ANOVA & effect sizes
```{r}

mod_list <- list(Het_obs_dist,
                 Het_obs_usc,
                 Hom_obs_dist,
                 Hom_obs_usc)

create_anova_df <- lapply(mod_list, function(model) {
  anova_result <- car::Anova(model)
  
  formula <- formula(model)[2] %>%
    unlist()
  
  Rsq <- MuMIn::r.squaredGLMM(model)[1] %>%
  round(digits = 3) %>%
  format(nsmall = 3)
  
  # ADD EFFECT SIZES
  
  anova_tidy <- broom::tidy(anova_result) %>%
    dplyr::mutate("Variable" = as.character(formula),
                  "Rsq" = as.numeric(Rsq)) %>%
    dplyr::rename("Chi_sq" = statistic,
                  "p" = p.value,
                  "Urbanization" = term) %>%
    dplyr::mutate("Sig" = case_when(
      p <= 0.05 & p > 0.01 ~ "*",
      p <= 0.01 & p > 0.001 ~ "**",
      p <= 0.001 ~ "***",
      TRUE ~ "")) %>%
    dplyr::mutate(Chi_sq = format(round(Chi_sq, digits = 3), nsmall = 3),
                  p = format(round(p, digits = 3), nsmall = 3)) %>%
  dplyr::arrange(Urbanization, Variable) %>%
  dplyr::mutate("Variable" = case_when(
      Variable == "exp_het" ~ "Expected heterozygosity",
      Variable == "obs_het" ~ "Observed heterozygosity",
      Variable == "exp_hom" ~ "Expected homozygosity",
      Variable == "obs_hom" ~ "Observed homozygosity",
      TRUE ~ ""))
  })

all_anovas <- do.call(rbind, create_anova_df) %>%
  dplyr::select(1,5,2,3,4,7,6) %T>%
  view

# create flextable
all_anovas %>%
  dplyr::select(-Sig) %>%
  flextable::flextable() %>%
  flextable::compose(i = 1, j = 2, part = "header",
                     value = as_paragraph("Î§", as_sup("2"))) %>%
  flextable::compose(i = 1, j = 5, part = "header",
                     value = as_paragraph("R", as_sup("2"))) %>%
  bold(~ p <= 0.05) %>%
  flextable::autofit()
```

### Figures
#### Expected heterozygosity
##### City_dist
```{r}
ggplot(diversity_variant_sites,
       aes(x = City_dist,
           y = exp_het)) +
  xlab("Distance to City Center (km)") +
  ylab("Expected Heterozygosity") +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() 

```

##### Urb_score
```{r}
ggplot(diversity_variant_sites,
       aes(x = urb_score,
           y = exp_het)) +
  xlab("Urbanization Score") +
  ylab("Expected Heterozygosity") +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() +
  xlim(4, -4)
```

#### Obs heterozygosity
##### City_dist
```{r}
ggplot(diversity_variant_sites,
       aes(x = City_dist,
           y = obs_het)) +
  xlab("Distance to City Center (km)") +
  ylab("Observed Heterozygosity") +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() 

```

##### Urb_score
```{r}
ggplot(diversity_variant_sites,
       aes(x = urb_score,
           y = obs_het)) +
  xlab("Urbanization Score") +
  ylab("Observed Heterozygosity") +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() +
  xlim(4, -4)

```

#### Expected homozygosity
##### City_dist
```{r}
ggplot(diversity_variant_sites,
       aes(x = City_dist,
           y = exp_hom)) +
  xlab("Distance to City Center (km)") +
  ylab("Expected Homozygosity") +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() 

```

##### Urb_score
```{r}
ggplot(diversity_variant_sites,
       aes(x = urb_score,
           y = exp_hom)) +
  xlab("Urbanization Score") +
  ylab("Expected Homozygosity") +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() +
  xlim(4, -4)
```

#### Obs homozygosity
##### City_dist
```{r}
ggplot(diversity_variant_sites,
       aes(x = City_dist,
           y = obs_hom)) +
  xlab("Distance to City Center (km)") +
  ylab("Observed Homozygosity") +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() 

```

##### Urb_score
```{r}
ggplot(diversity_variant_sites,
       aes(x = urb_score,
           y = obs_hom)) +
  xlab("Urbanization Score") +
  ylab("Observed Homozygosity") +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() +
  xlim(4, -4)

```

#### Number of individuals per pop
##### City_dist
```{r}
ggplot(diversity_variant_sites,
       aes(x = City_dist,
           y = num_indv)) +
  xlab("Distance to City Center (km)") +
  ylab("Individuals/Population") +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() 

```

##### Urb_score
```{r}
ggplot(diversity_variant_sites,
       aes(x = urb_score,
           y = num_indv)) +
  xlab("Urbanization Score") +
  ylab("Individuals/Population") +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() +
  xlim(4, -4)

```

## Urbanization is categorical
### Fit linear models/diagnostics
#### Expected heterozygosity (Het_exp)
##### u_r_dist
```{r}
Het_exp_dist_cat <- glmmTMB(exp_het ~ u_r_dist,
           diversity_variant_sites)

performance::check_model(Het_exp_dist_cat)
```

##### u_r_usc
```{r}
Het_exp_usc_cat <- glmmTMB(exp_het ~ u_r_usc,
           diversity_variant_sites)

performance::check_model(Het_exp_usc_cat)
```

#### Observed heterozygosity (Het_obs)
##### u_r_dist
```{r}
Het_obs_dist_cat <- glmmTMB(obs_het ~ u_r_dist,
           diversity_variant_sites)

performance::check_model(Het_obs_dist_cat)
```

##### u_r_usc
```{r}
Het_obs_usc_cat <- glmmTMB(obs_het ~ u_r_usc,
           diversity_variant_sites)

performance::check_model(Het_obs_usc_cat)
```

#### Expected homozygosity (Hom_exp)
##### u_r_dist
```{r}
Hom_exp_dist_cat <- glmmTMB(exp_hom ~ u_r_dist,
           diversity_variant_sites)

performance::check_model(Hom_exp_dist_cat)
```

##### u_r_usc
```{r}
Hom_exp_usc_cat <- glmmTMB(exp_hom ~ u_r_usc,
           diversity_variant_sites)

performance::check_model(Hom_exp_usc_cat)
```


#### Observed homozygosity (Hom_obs)
##### u_r_dist
```{r}
Hom_obs_dist_cat <- glmmTMB(obs_hom ~ u_r_dist,
           diversity_variant_sites)

performance::check_model(Hom_obs_dist_cat)
```

##### u_r_usc
```{r}
Hom_obs_usc_cat <- glmmTMB(obs_hom ~ u_r_usc,
           diversity_variant_sites)

performance::check_model(Hom_obs_usc_cat)
```

### ANOVA & effect sizes
```{r}

mod_list_cat <- list(Het_obs_dist_cat,
                 Het_obs_usc_cat,
                 Hom_obs_dist_cat,
                 Hom_obs_usc_cat)

create_anova_df_cat <- lapply(mod_list_cat, function(model) {
  anova_result <- car::Anova(model)
  
  formula <- formula(model)[2] %>%
    unlist()
  
  Rsq <- MuMIn::r.squaredGLMM(model)[1] %>%
  round(digits = 3) %>%
  format(nsmall = 3)
  
  # ADD EFFECT SIZES
  
  anova_tidy <- broom::tidy(anova_result) %>%
    dplyr::mutate("Variable" = as.character(formula),
                  "Rsq" = as.numeric(Rsq)) %>%
    dplyr::rename("Chi_sq" = statistic,
                  "p" = p.value,
                  "Urbanization" = term) %>%
    dplyr::mutate("Sig" = case_when(
      p <= 0.05 & p > 0.01 ~ "*",
      p <= 0.01 & p > 0.001 ~ "**",
      p <= 0.001 ~ "***",
      TRUE ~ "")) %>%
    dplyr::mutate(Chi_sq = format(round(Chi_sq, digits = 3), nsmall = 3),
                  p = format(round(p, digits = 3), nsmall = 3)) %>%
  dplyr::arrange(Urbanization, Variable) %>%
  dplyr::mutate("Variable" = case_when(
      Variable == "exp_het" ~ "Expected heterozygosity",
      Variable == "obs_het" ~ "Observed heterozygosity",
      Variable == "exp_hom" ~ "Expected homozygosity",
      Variable == "obs_hom" ~ "Observed homozygosity",
      TRUE ~ "")) %>%
  dplyr::mutate("Urbanization" = case_when(
      Urbanization == "u_r_dist" ~ "Distance (categorical)",
      Urbanization == "u_r_usc" ~ "Urbanization Score (categorical)",
      TRUE ~ ""))
  })

all_anovas_cat <- do.call(rbind, create_anova_df_cat) %>%
  dplyr::select(1,5,2,3,4,7,6) %T>%
  view

# create flextable
all_anovas_cat %>%
  dplyr::select(-Sig) %>%
  flextable::flextable() %>%
  flextable::compose(i = 1, j = 2, part = "header",
                     value = as_paragraph("Î§", as_sup("2"))) %>%
  flextable::compose(i = 1, j = 5, part = "header",
                     value = as_paragraph("R", as_sup("2"))) %>%
  bold(~ p <= 0.05) %>%
  flextable::autofit()
```


### Figures
#### Expected heterozygosity
##### City_dist
```{r}
ggplot(diversity_variant_sites,
       aes(x = City_dist,
           y = exp_het)) +
  xlab("Distance to City Center (km)") +
  ylab("Expected Heterozygosity") +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() 

```

##### Urb_score
```{r}
ggplot(diversity_variant_sites,
       aes(x = urb_score,
           y = exp_het)) +
  xlab("Urbanization Score") +
  ylab("Expected Heterozygosity") +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() +
  xlim(4, -4)
```

#### Obs heterozygosity
##### City_dist
```{r}
ggplot(diversity_variant_sites,
       aes(x = City_dist,
           y = obs_het)) +
  xlab("Distance to City Center (km)") +
  ylab("Observed Heterozygosity") +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() 

```

##### Urb_score
```{r}
ggplot(diversity_variant_sites,
       aes(x = urb_score,
           y = obs_het)) +
  xlab("Urbanization Score") +
  ylab("Observed Heterozygosity") +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() +
  xlim(4, -4)

```

#### Expected homozygosity
##### City_dist
```{r}
ggplot(diversity_variant_sites,
       aes(x = City_dist,
           y = exp_hom)) +
  xlab("Distance to City Center (km)") +
  ylab("Expected Homozygosity") +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() 

```

##### Urb_score
```{r}
ggplot(diversity_variant_sites,
       aes(x = urb_score,
           y = exp_hom)) +
  xlab("Urbanization Score") +
  ylab("Expected Homozygosity") +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() +
  xlim(4, -4)
```

#### Obs homozygosity
##### City_dist
```{r}
ggplot(diversity_variant_sites,
       aes(x = City_dist,
           y = obs_hom)) +
  xlab("Distance to City Center (km)") +
  ylab("Observed Homozygosity") +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() 

```

##### Urb_score
```{r}
ggplot(diversity_variant_sites,
       aes(x = urb_score,
           y = obs_hom)) +
  xlab("Urbanization Score") +
  ylab("Observed Homozygosity") +
  plot_aesthetics +
  theme_pubr() +
  labs_pubr() +
  xlim(4, -4)

```

## Compare expected w/observed heterozygosity, homozygosity
```{r}
# All populations
chisq.test(diversity_all_sites$obs_hom, diversity_all_sites$exp_hom)
chisq.test(diversity_all_sites$obs_het, diversity_all_sites$exp_het)


# Only urban populations
## distance
div_urb_dist <- diversity_all_sites %>%
   dplyr::filter(u_r_dist == "Urban")

chisq.test(div_urb_dist$obs_hom, div_urb_dist$exp_hom)
chisq.test(div_urb_dist$obs_het, div_urb_dist$exp_het)


## urb score
div_urb_usc <- diversity_all_sites %>%
   dplyr::filter(u_r_usc == "Urban")

chisq.test(div_urb_usc$obs_hom, div_urb_usc$exp_hom)
chisq.test(div_urb_usc$obs_het, div_urb_usc$exp_het)



# Only rural populations
## distance
div_rur_dist <- diversity_all_sites %>%
   dplyr::filter(u_r_dist == "Rural")

chisq.test(div_rur_dist$obs_hom, div_rur_dist$exp_hom)
chisq.test(div_rur_dist$obs_het, div_rur_dist$exp_het)


## urb score
div_rur_usc <- diversity_all_sites %>%
   dplyr::filter(u_r_usc == "Rural")

chisq.test(div_rur_usc$obs_hom, div_rur_usc$exp_hom)
chisq.test(div_rur_usc$obs_het, div_rur_usc$exp_het)


# Looks like the largest differences btwn exp and obs het/hom are in the rural plants when urb = urb score
```

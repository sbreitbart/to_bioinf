# Set up notebook
## load libraries
```{r}
source("libraries.R")
source("functions.R")
```

# Import data
## mu = 1.0x10^-8 & generation time = 1 year
### All sites in 1 population
```{r}
full_fig_1e8 <- read.delim(here::here("./results/StairwayPlot/mu_1e-8/gen_time_1yr/full_mmaf0.007813_mut_rate_1e-8.final.summary")) %>%
  dplyr::select(-c(theta_per_site_median,
                   theta_per_site_2.5.,
                   theta_per_site_97.5.,
                   n_estimation,
                   mutation_per_site)) %>%
  # remove duplicate rows
  distinct(.keep_all = TRUE)

```

## mu = 1.0x10^-8 & generation time = 2 years
### All sites in 1 population
```{r}
full_fig_1e8_2yrs <- read.delim(here::here("./results/StairwayPlot/mu_1e-8/gen_time_2yr/full_mmaf0.007813_mut_rate_1e-8_2yrs.final.summary")) %>%
  dplyr::select(-c(theta_per_site_median,
                   theta_per_site_2.5.,
                   theta_per_site_97.5.,
                   n_estimation,
                   mutation_per_site)) %>%
  # remove duplicate rows
  distinct(.keep_all = TRUE)

```

## mu = 1.2x10^-8 & generation time = 1 year
### All sites in 1 population
```{r}
full_fig <- read.delim(here::here("./results/StairwayPlot/mu_1.2e-8/gen_time_1yr/full_mmaf0.007813.final.summary")) %>%
  dplyr::select(-c(theta_per_site_median,
                   theta_per_site_2.5.,
                   theta_per_site_97.5.,
                   n_estimation,
                   mutation_per_site)) %>%
  # remove duplicate rows
  distinct(.keep_all = TRUE)

```

### Urban
#### Dist to CC
```{r}
urb_fig <- read.delim(here::here("./results/StairwayPlot/mu_1.2e-8/gen_time_1yr/urban_dist_mmaf0.007813.final.summary")) %>%
  dplyr::select(-c(theta_per_site_median,
                   theta_per_site_2.5.,
                   theta_per_site_97.5.,
                   n_estimation,
                   mutation_per_site)) %>%
  # remove duplicate rows
  distinct(.keep_all = TRUE)

```

#### Urb Score
```{r}
urb_fig2 <- read.delim(here::here("./results/StairwayPlot/mu_1.2e-8/gen_time_1yr/urban_usc_mmaf0.007813.final.summary")) %>%
  dplyr::select(-c(theta_per_site_median,
                   theta_per_site_2.5.,
                   theta_per_site_97.5.,
                   n_estimation,
                   mutation_per_site)) %>%
  # remove duplicate rows
  distinct(.keep_all = TRUE)

```

### Rural
#### Dist to CC
```{r}
rur_fig <- read.delim(here::here("./results/StairwayPlot/mu_1.2e-8/gen_time_1yr/rural_dist_mmaf0.007813.final.summary")) %>%
  dplyr::select(-c(theta_per_site_median,
                   theta_per_site_2.5.,
                   theta_per_site_97.5.,
                   n_estimation,
                   mutation_per_site)) %>%
  # remove duplicate rows
  distinct(.keep_all = TRUE)

```

#### Urb score
```{r}
rur_fig2 <- read.delim(here::here("./results/StairwayPlot/mu_1.2e-8/gen_time_1yr/rural_usc_mmaf0.007813.final.summary")) %>%
  dplyr::select(-c(theta_per_site_median,
                   theta_per_site_2.5.,
                   theta_per_site_97.5.,
                   n_estimation,
                   mutation_per_site)) %>%
  # remove duplicate rows
  distinct(.keep_all = TRUE)

```

### Merge dfs
#### Urb = dist to CC
```{r}
all_dist <- dplyr::full_join(urb_fig %>%
                    dplyr::mutate(Group = "Urban"),
                  rur_fig %>%
                    dplyr::mutate(Group = "Rural")) %>%
  dplyr::full_join(.,
                   full_fig %>%
                    dplyr::mutate(Group = "Entire population"))

# remove duplicate rows
all_dist %<>%
  distinct(.keep_all = TRUE)
```


#### Urb = urb score
```{r}
all_usc <- dplyr::full_join(urb_fig2 %>%
                    dplyr::mutate(Group = "Urban"),
                  rur_fig2 %>%
                    dplyr::mutate(Group = "Rural")) %>%
  dplyr::full_join(.,
                   full_fig %>%
                    dplyr::mutate(Group = "Entire population"))

# remove duplicate rows
all_usc %<>%
  distinct(.keep_all = TRUE)
```

## mu = 1.2x10^-8 & generation time = 2 years
### All sites in 1 population
```{r}
full_fig_2yrs <- read.delim(here::here("./results/StairwayPlot/mu_1.2e-8/gen_time_2yr/full_mmaf0.007813_mut_rate_1.2e-8_2yrs.final.summary")) %>%
  dplyr::select(-c(theta_per_site_median,
                   theta_per_site_2.5.,
                   theta_per_site_97.5.,
                   n_estimation,
                   mutation_per_site)) %>%
  # remove duplicate rows
  distinct(.keep_all = TRUE)

```

## mu = 1.8x10^-8 & generation time = 1 year
### All sites in 1 population
```{r}
full_fig_1.8e8 <- read.delim(here::here("./results/StairwayPlot/mu_1.8e-8/gen_time_1yr/full_mmaf0.007813_mut_rate_1.8e-8.final.summary")) %>%
  dplyr::select(-c(theta_per_site_median,
                   theta_per_site_2.5.,
                   theta_per_site_97.5.,
                   n_estimation,
                   mutation_per_site)) %>%
  # remove duplicate rows
  distinct(.keep_all = TRUE)

```

### Urban
#### Dist to CC
```{r}
urb_fig_1.8e8 <- read.delim(here::here("./results/StairwayPlot/mu_1.8e-8/gen_time_1yr/urban_dist_mmaf0.007813_mut_rate_1.8e-8.final.summary")) %>%
  dplyr::select(-c(theta_per_site_median,
                   theta_per_site_2.5.,
                   theta_per_site_97.5.,
                   n_estimation,
                   mutation_per_site)) %>%
  # remove duplicate rows
  distinct(.keep_all = TRUE)

```

#### Urb Score
```{r}
urb_fig2_1.8e8 <- read.delim(here::here("./results/StairwayPlot/mu_1.8e-8/gen_time_1yr/urban_usc_mmaf0.007813_mut_rate_1.8e-8.final.summary")) %>%
  dplyr::select(-c(theta_per_site_median,
                   theta_per_site_2.5.,
                   theta_per_site_97.5.,
                   n_estimation,
                   mutation_per_site)) %>%
  # remove duplicate rows
  distinct(.keep_all = TRUE)

```

### Rural
#### Dist to CC
```{r}
rur_fig_1.8e8 <- read.delim(here::here("./results/StairwayPlot/mu_1.8e-8/gen_time_1yr/rural_dist_mmaf0.007813_mut_rate_1.8e-8.final.summary")) %>%
  dplyr::select(-c(theta_per_site_median,
                   theta_per_site_2.5.,
                   theta_per_site_97.5.,
                   n_estimation,
                   mutation_per_site)) %>%
  # remove duplicate rows
  distinct(.keep_all = TRUE)

```

#### Urb score
```{r}
rur_fig2_1.8e8 <- read.delim(here::here("./results/StairwayPlot/mu_1.8e-8/gen_time_1yr/rural_usc_mmaf0.007813_mut_rate_1.8e-8.final.summary")) %>%
  dplyr::select(-c(theta_per_site_median,
                   theta_per_site_2.5.,
                   theta_per_site_97.5.,
                   n_estimation,
                   mutation_per_site)) %>%
  # remove duplicate rows
  distinct(.keep_all = TRUE)

```

### Merge dfs
#### Urb = dist to CC
```{r}
all_dist_1.8e8 <- dplyr::full_join(urb_fig_1.8e8 %>%
                    dplyr::mutate(Group = "Urban"),
                  rur_fig_1.8e8 %>%
                    dplyr::mutate(Group = "Rural")) %>%
  dplyr::full_join(.,
                   full_fig_1.8e8 %>%
                    dplyr::mutate(Group = "Entire population"))

# remove duplicate rows
all_dist_1.8e8 %<>%
  distinct(.keep_all = TRUE)
```


#### Urb = urb score
```{r}
all_usc_1.8e8 <- dplyr::full_join(urb_fig2_1.8e8 %>%
                    dplyr::mutate(Group = "Urban"),
                  rur_fig2_1.8e8 %>%
                    dplyr::mutate(Group = "Rural")) %>%
  dplyr::full_join(.,
                   full_fig_1.8e8 %>%
                    dplyr::mutate(Group = "Entire population"))

# remove duplicate rows
all_usc_1.8e8 %<>%
  distinct(.keep_all = TRUE)
```

## mu = 1.8x10^-8 & generation time = 2 years
### All sites in 1 population
```{r}
full_fig_1.8e8_2yr <- read.delim(here::here("./results/StairwayPlot/mu_1.8e-8/gen_time_2yr/full/full_mmaf0.007813_mut_rate_1.8e-8_2yrs.final.summary")) %>%
  dplyr::select(-c(theta_per_site_median,
                   theta_per_site_2.5.,
                   theta_per_site_97.5.,
                   n_estimation,
                   mutation_per_site)) %>%
  # remove duplicate rows
  distinct(.keep_all = TRUE)

```

### Urban
#### Dist to CC
```{r}
urb_fig_1.8e8_2yr <- read.delim(here::here("./results/StairwayPlot/mu_1.8e-8/gen_time_2yr/urb_dist/urban_dist_mmaf0.007813_mut_rate_1.8e-8_gt2yrs.final.summary")) %>%
  dplyr::select(-c(theta_per_site_median,
                   theta_per_site_2.5.,
                   theta_per_site_97.5.,
                   n_estimation,
                   mutation_per_site)) %>%
  # remove duplicate rows
  distinct(.keep_all = TRUE)

```

#### Urb Score
```{r}
urb_fig2_1.8e8_2yr <- read.delim(here::here("./results/StairwayPlot/mu_1.8e-8/gen_time_2yr/urb_usc/urban_usc_mmaf0.007813_mut_rate_1.8e-8_gt2yrs.final.summary")) %>%
  dplyr::select(-c(theta_per_site_median,
                   theta_per_site_2.5.,
                   theta_per_site_97.5.,
                   n_estimation,
                   mutation_per_site)) %>%
  # remove duplicate rows
  distinct(.keep_all = TRUE)

```

### Rural
#### Dist to CC
```{r}
rur_fig_1.8e8_2yr <- read.delim(here::here("./results/StairwayPlot/mu_1.8e-8/gen_time_2yr/rur_dist/rural_dist_mmaf0.007813_mut_rate_1.8e-8_gt2yrs.final.summary")) %>%
  dplyr::select(-c(theta_per_site_median,
                   theta_per_site_2.5.,
                   theta_per_site_97.5.,
                   n_estimation,
                   mutation_per_site)) %>%
  # remove duplicate rows
  distinct(.keep_all = TRUE)

```

#### Urb score
```{r}
rur_fig2_1.8e8_2yr <- read.delim(here::here("./results/StairwayPlot/mu_1.8e-8/gen_time_2yr/rur_usc/rural_usc_mmaf0.007813_mut_rate_1.8e-8_gt2yrs.final.summary")) %>%
  dplyr::select(-c(theta_per_site_median,
                   theta_per_site_2.5.,
                   theta_per_site_97.5.,
                   n_estimation,
                   mutation_per_site)) %>%
  # remove duplicate rows
  distinct(.keep_all = TRUE)

```

### Merge dfs
#### Urb = dist to CC
```{r}
all_dist_1.8e8_2yr <- dplyr::full_join(urb_fig_1.8e8_2yr %>%
                    dplyr::mutate(Group = "Urban"),
                  rur_fig_1.8e8_2yr %>%
                    dplyr::mutate(Group = "Rural")) %>%
  dplyr::full_join(.,
                   full_fig_1.8e8_2yr %>%
                    dplyr::mutate(Group = "Entire population"))

# remove duplicate rows
all_dist_1.8e8_2yr %<>%
  distinct(.keep_all = TRUE)
```

#### Urb = urb score
```{r}
all_usc_1.8e8_2yr <- dplyr::full_join(urb_fig2_1.8e8_2yr %>%
                    dplyr::mutate(Group = "Urban"),
                  rur_fig2_1.8e8_2yr %>%
                    dplyr::mutate(Group = "Rural")) %>%
  dplyr::full_join(.,
                   full_fig_1.8e8_2yr %>%
                    dplyr::mutate(Group = "Entire population"))

# remove duplicate rows
all_usc_1.8e8_2yr %<>%
  distinct(.keep_all = TRUE)
```

## mu = 2.6x10^-8 & generation time = 1 year
### All sites in 1 population
```{r}
full_fig_2.6e8 <- read.delim(here::here("./results/StairwayPlot/mu_2.6e-8/gen_time_1yr/full_mmaf0.007813_mut_rate_2.6e-8.final.summary")) %>%
  dplyr::select(-c(theta_per_site_median,
                   theta_per_site_2.5.,
                   theta_per_site_97.5.,
                   n_estimation,
                   mutation_per_site)) %>%
  # remove duplicate rows
  distinct(.keep_all = TRUE)

```

## mu = 2.6x10^-8 & generation time = 2 years
### All sites in 1 population
```{r}
full_fig_2.6e8_2yrs <- read.delim(here::here("./results/StairwayPlot/mu_2.6e-8/gen_time_2yr/full_mmaf0.007813_mut_rate_2.6e-8_2yrs.final.summary")) %>%
  dplyr::select(-c(theta_per_site_median,
                   theta_per_site_2.5.,
                   theta_per_site_97.5.,
                   n_estimation,
                   mutation_per_site)) %>%
  # remove duplicate rows
  distinct(.keep_all = TRUE)

```

# Create table with Helene's breakpoint analysis
Adding this here because this requires data to be imported first, and the following plots need this breakpoint table to be created first.
## Create original output table
```{r}
##        year.l year.u rate.est rate.CI.95.l rate.CI.95.u
## slope1   2017   2018 -1.78375     -1.67883     -1.89273
## slope2   2010   2017 -0.26525     -0.25766     -0.27288
## slope3   1975   2010 -0.04738     -0.04599     -0.04876
## slope4   1825   1975 -0.00726     -0.00701     -0.00752
## slope5   1644   1825 -0.00330     -0.00299     -0.00360
## slope6   1226   1644 -0.00068     -0.00055     -0.00082
## slope7   -113   1226 -0.00010     -0.00008     -0.00013
## slope8  -5762   -113  0.00002      0.00002      0.00001
## slope9 -12981  -5762  0.00014      0.00014      0.00013

breakpoint_table <- data.frame(
  "Start" = as.numeric(c(2017,
                       2010,
                       1975,
                       1825,
                       1644,
                       1226,
                       -113,
                       -5762,
                       -12981)),
  "End" = as.numeric(c(2018,
                     2017,
                     2010,
                     1975,
                     1825,
                     1644,
                     1226,
                     -113,
                     -5762)),
  "Rate" = as.numeric(c(-1.78375,
                      -0.26525,
                      -0.04738,
                      -0.00726,
                      -0.00330,
                      -0.00068,
                      -0.00010,
                      0.00002,
                      0.00014)),
  "CI_Lower" = as.numeric(c(-1.67883,
                                -0.25766,
                                -0.04599,
                                -0.00701,
                                -0.00299,
                                -0.00055,
                                -0.00008,
                                0.00002,
                                0.00014)),
  "CI_Upper" = as.numeric(c(-1.89273,
                                -0.27288,
                                -0.04876,
                                -0.00752,
                                -0.00360,
                                -0.00082,
                                -0.00013,
                                0.00001,
                                0.00013)),
  
  # and add historical interpretation
  "Historical_Interpretation" = as.character(c("Conservation groups (e.g., Suzuki Foundation) encourage Toronto residents to plant milkweed",
                                               "\"",
                                               "Urban expansion in Toronto",
                                               "Colonization and settlement by Europeans; urban and rural expansion",
                                               "European diseases decimate Indigenous populations",
                                               "Indigenous agriculture grows",
                                               "Indigenous populations present",
                                               "\"",
                                               "Glaciers retreat; climate warms; Indigenous populations present")))
```

## Add Ne and other table elements
```{r}
# Add Ne from the Start of the period to the table

# first, get Starting Nes
start_ne_yrs <- breakpoint_table %>%
  dplyr::select(Start)

# Get median Nes and year from output data, then convert year from years ago to BCE/AD system
all_ne <- full_fig_1.8e8_2yr %>%
  dplyr::select(c(year, Ne_median)) %>%
  dplyr::distinct() %>%
  dplyr::mutate(years_ago = year) %>% 
  dplyr::mutate(year = year*(-1) + 2019) # data collected in 2018 or 2019

# find Ne in output data closest to period Start (as long as it's equal or later than Start time)
output_Start_Nes <- fuzzyjoin::difference_inner_join(
  start_ne_yrs, all_ne,
  by = c("Start" = "year"),
  max_dist = 10) %>%
  dplyr::filter(year >= Start) %>%
  dplyr::group_by(Start) %>%
  dplyr::filter(abs(Start - year) == min(abs(Start - year))) %>%
  dplyr::ungroup()

# Add output Start Nes to breakpoint table
breakpoint_table %<>%
  dplyr::left_join(.,
                   output_Start_Nes %>%
                     dplyr::select(-year),
                   by = "Start") %>%
  dplyr::rename(Start_median_Ne = Ne_median) %>%
  # multiply Start_median_Ne x 1000 because Ne is in multiples of 1000
  dplyr::mutate(Start_median_Ne = Start_median_Ne * 1000) %>%
  dplyr::mutate(years_from_2019 = 2019 - Start) %>%
  dplyr::select(years_from_2019, Start, Start_median_Ne, End:Historical_Interpretation) %>%
  dplyr::mutate(Start = as.factor(Start),
                End = as.factor(End) # remove commas
             #   ,Period = paste0(Start, " - ", End)
                ) %>%
#  dplyr::relocate(Period, .before = "Start") %>%
  
  # round numeric columns to 3 digits unless if <0.001... then convert to scientific format
  dplyr::mutate(across(where(is.numeric),
                ~ if_else(abs(.) < 0.001,
                          formatC(.,
                                  format = "e",
                                  digits = 2),
                          as.character(round(., 3))))) %>%
  dplyr::mutate(Start_median_Ne = as.numeric(Start_median_Ne)) %>%
  dplyr::rename('95% CI\n (Lower)' = "CI_Lower",
                '95% CI\n (Upper)' = "CI_Upper",
                'Historical Interpretation' = "Historical_Interpretation",
                'Years ago' = "years_from_2019")
```

## Make, export flextable
```{r}
breakpoint_table %>%
  flextable::flextable() %>%
  flextable::compose(j = "Start_median_Ne",
                     part = "header", 
                     value = as_paragraph("Start N", as_sub("e"))) %>%
  flextable::align(part = "all",
                   j = c(1:6),
                   align = "center") %>%
  flextable::autofit() %>%
  flextable::width(j = 8,
                   width = 2.15,
                   unit = "in") %>%
  flextable::save_as_docx(path = here::here("./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_2yr/breakpoint_table.docx"))

```

# Create figures
## Export plots
### Mu = 1.0e-8 & gen time = 1 yr
#### Export main plot
```{r}
make_ne_plot(full_fig_1e8,
                   "./Figures_Tables/Stairway_plot/mu_1e-8/gen_time_1yr/full_with_inset.png")
```

### Mu = 1.0e-8 & gen time = 2 yr
#### Export main plot
```{r}
make_ne_plot(full_fig_1e8_2yrs,
                   "./Figures_Tables/Stairway_plot/mu_1e-8/gen_time_2yr/full_with_inset.png")
```


### Mu = 1.2e-8 & gen time = 1 yr
#### Export main plot
```{r}
make_ne_plot(full_fig,
                   "./Figures_Tables/Stairway_plot/mu_1.2e-8/gen_time_1yr/full_with_inset.png")
```

#### Export all plots
```{r}
export_all_plots(df_distCC = all_dist,
                 df_urbscore = all_usc,
                 mu = "1.2e-8",
                 gen_time = "1yr")
```

### Mu = 1.2e-8 & gen time = 2 yr
#### Export main plot
```{r}
make_ne_plot(full_fig_2yrs,
                   "./Figures_Tables/Stairway_plot/mu_1.2e-8/gen_time_2yr/full_with_inset.png")
```

### Mu = 1.8e-8 & gen time = 1 yr
#### Export main plot
```{r}
make_ne_plot(full_fig_1.8e8,
                   "./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_1yr/full_with_inset.png")
```

#### Export DIST plots WITH conf intervals
##### Full plot
```{r}
dist_CIs <- ggplot(
    all_dist_1.8e8 %>%
      dplyr::filter(Group != "Entire population"),
    aes(x = year))  +
  
      # add vertical lines at breakpoints
      geom_vline(xintercept = as.vector(as.numeric(breakpoint_table$`Years ago`)),
                 color = plasma(9, begin = 0.15, end = 0.9),
                 linetype = "D3") +
    
    # add median Ne and CIs
     geom_line(aes(color = Group,
                   y = Ne_median/1000),
               linewidth = 1,
               linetype = "solid") +
  
    geom_line(aes(color = Group,
                   y = Ne_97.5./1000),
               linewidth = 0.5,
              linetype = "dashed") +
  
      geom_line(aes(color = Group,
                   y = Ne_2.5./1000),
               linewidth = 0.5,
               linetype = "dashed") +

    
    scale_x_continuous(labels = scales::comma,
                       limits = c(NA, 40000)) +
    scale_y_continuous(
      #breaks=c(0, 25000, 50000, 75000, 100000, 125000, 150000),
                       labels = scales::comma,
                       limits = c(0, 
                                  NA
                                  )
                       ) +
  scale_color_manual(name = "Group", 
                     labels=c('Rural', 'Urban'),
                     values=c('grey', 'black')) +
    xlab("Years ago") +
    ylab("Median Nₑ (million individuals)") +
    theme_bw() +
    labs_pubr() +
    theme(plot.margin = unit(c(0.5,1,0.5,0.5), "cm"))
  
ggsave(plot = dist_CIs,
       filename = "./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_1yr/distance/conf_ints.png",
       width = 17,
       height = 9,
       units = "cm")
```

##### inset plot
```{r}
dist_CIs_inset <- ggplot(
  all_dist_1.8e8 %>%
    dplyr::filter(Group != "Entire population"),
  aes(x = year))  +
  
  # add vertical lines at breakpoints
  geom_vline(xintercept = as.vector(as.numeric(breakpoint_table$`Years ago`)),
             color = plasma(9, begin = 0.15, end = 0.9),
             linetype = "D3") +
  
  # add median Ne and CIs
  geom_line(aes(color = Group,
                y = Ne_median/1000),
            linewidth = 1,
            # color = "black",
            linetype = "solid") +
  
  geom_line(aes(color = Group,
                y = Ne_97.5./1000),
            linewidth = 0.5,
            # color = "black",
            linetype = "dashed") +
  
  geom_line(aes(color = Group,
                y = Ne_2.5./1000),
            linewidth = 0.5,
            #  color = "black",
            linetype = "dashed") +
  
  scale_x_continuous(labels = scales::comma,
                     limits = c(NA, 2300)) +
  scale_y_continuous(
    labels = scales::comma,
    limits = c(0, 
               NA
    )
  ) +
  scale_color_manual(name = "Group", 
                     labels=c('Rural', 'Urban'),
                     values=c('grey', 'black')) +
  xlab("Years ago") +
  ylab("Median Nₑ (million individuals)") +
  theme_bw() +
  labs_pubr() +
  theme(plot.margin = unit(c(0.5,1,0.5,0.5), "cm"))

ggsave(plot = dist_CIs_inset,
       filename = "./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_1yr/distance/inset_conf_ints.png",
       width = 17,
       height = 9,
       units = "cm")
```

##### Full plot WITH inset
```{r}
dist_plot_CIs <- dist_CIs +
  
  theme(plot.margin = unit(c(0.5,1,0.5,0.5), "cm"),
        legend.position = "top") +
  # make legend point size larger
  guides(colour = guide_legend(
    override.aes = list(size=3)))


### Plot inset (past 2300 years)
dist_plot_CIs_inset <- dist_CIs_inset +
  
  theme(axis.title = element_blank(),
        plot.background = element_rect(
          colour = "black",
          fill = "white",
          size = 1),
        legend.position = "none")



#### Export
ggsave(plot =
         ### Overlay inset in full figure
         cowplot::ggdraw() +
         draw_plot(dist_plot_CIs) +
         draw_plot(dist_plot_CIs_inset,
                   x = 0.52,
                   y = 0.35, 
                   width = 0.4,
                   height = 0.45),     
       filename = here::here("./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_1yr/distance/both_with_inset_CIs.png"),
       height = 5,
       width = 9,
       dpi = 200)

```

#### Export URB SCORE plots WITH conf intervals
##### Full plot
```{r}
usc_CIs <- ggplot(
  all_usc_1.8e8 %>%
    dplyr::filter(Group != "Entire population"),
  aes(x = year))  +
  
        # add vertical lines at breakpoints
      geom_vline(xintercept = as.vector(as.numeric(breakpoint_table$`Years ago`)),
                 color = plasma(9, begin = 0.15, end = 0.9),
                 linetype = "D3") +
    
    # add median Ne and CIs
  geom_line(aes(color = Group,
                y = Ne_median/1000),
            linewidth = 1,
            linetype = "solid") +
  
  geom_line(aes(color = Group,
                y = Ne_97.5./1000),
            linewidth = 0.5,
            linetype = "dashed") +
  
  geom_line(aes(color = Group,
                y = Ne_2.5./1000),
            linewidth = 0.5,
            linetype = "dashed") +
  
  scale_x_continuous(labels = scales::comma,
                     limits = c(NA, 40000)) +
  scale_y_continuous(
    #breaks=c(0, 25000, 50000, 75000, 100000, 125000, 150000),
    labels = scales::comma,
    limits = c(0, 
               NA
    )
  ) +
  scale_color_manual(name = "Group", 
                     labels=c('Rural', 'Urban'),
                     values=c('grey', 'black')) +
  xlab("Years ago") +
  ylab("Median Nₑ (million individuals)") +
  theme_bw() +
  labs_pubr() +
  theme(plot.margin = unit(c(0.5,1,0.5,0.5), "cm"))

ggsave(plot = usc_CIs,
       filename = "./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_1yr/urb_score/conf_ints.png",
       width = 17,
       height = 9,
       units = "cm")
```

##### inset plot
```{r}
usc_CIs_inset <- ggplot(
  all_usc_1.8e8 %>%
    dplyr::filter(Group != "Entire population"),
  aes(x = year))  +
  
  # add vertical lines at breakpoints
  geom_vline(xintercept = as.vector(as.numeric(breakpoint_table$`Years ago`)),
             color = plasma(9, begin = 0.15, end = 0.9),
             
             linetype = "D3") +
  
  # add median Ne and CIs
  geom_line(aes(color = Group,
                y = Ne_median/1000),
            linewidth = 1,
            linetype = "solid") +
  
  geom_line(aes(color = Group,
                y = Ne_97.5./1000),
            linewidth = 0.5,
            linetype = "dashed") +
  
  geom_line(aes(color = Group,
                y = Ne_2.5./1000),
            linewidth = 0.5,
            linetype = "dashed") +
  
  
  scale_x_continuous(labels = scales::comma,
                     limits = c(NA, 2300)) +
  scale_y_continuous(
    labels = scales::comma,
    limits = c(0, 
               NA
    )
  ) +
  scale_color_manual(name = "Group", 
                     labels=c('Rural', 'Urban'),
                     values=c('grey', 'black')) +
  xlab("Years ago") +
  ylab("Median Nₑ (million individuals)") +
  theme_bw() +
  labs_pubr() +
  theme(plot.margin = unit(c(0.5,1,0.5,0.5), "cm"))

ggsave(plot = usc_CIs_inset,
       filename = "./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_1yr/urb_score/inset_conf_ints.png",
       width = 17,
       height = 9,
       units = "cm")
```

##### Full plot WITH inset
```{r}
usc_plot_CIs <- usc_CIs +
  
  theme(plot.margin = unit(c(0.5,1,0.5,0.5), "cm"),
        legend.position = "top") +
  # make legend point size larger
  guides(colour = guide_legend(
    override.aes = list(size=3)))


### Plot inset (past 2300 years)
usc_plot_CIs_inset <- usc_CIs_inset +
  
  theme(axis.title = element_blank(),
        plot.background = element_rect(
          colour = "black",
          fill = "white",
          size = 1),
        legend.position = "none")


#### Export
ggsave(plot =
         ### Overlay inset in full figure
         cowplot::ggdraw() +
         draw_plot(usc_plot_CIs) +
         draw_plot(usc_plot_CIs_inset,
                   x = 0.52,
                   y = 0.35, 
                   width = 0.4,
                   height = 0.45),     
       filename = here::here("./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_1yr/urb_score/both_with_inset_CIs.png"),
       height = 5,
       width = 9,
       dpi = 200)

```

#### Export all plots
```{r}
export_all_plots(df_distCC = all_dist_1.8e8,
                 df_urbscore = all_usc_1.8e8,
                 mu = "1.8e-8",
                 gen_time = "1yr")
```

#### Export main, urb, and rur plots as a composite figure
```{r}
main_1.8e8_CIs_1yr_composite <- rasterGrob(readPNG(here::here("./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_1yr/full_with_inset.png")))

main_1.8e8_CIs_1yr_composite_dist <- rasterGrob(readPNG(here::here("./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_1yr/distance/both_with_inset_CIs.png")))

main_1.8e8_CIs_1yr_composite_usc <- rasterGrob(readPNG(here::here("./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_1yr/urb_score/both_with_inset_CIs.png")))


main_1.8e8_CIs_1yr_composite_plots <- gridExtra::grid.arrange(main_1.8e8_CIs_1yr_composite,
                                                        main_1.8e8_CIs_1yr_composite_dist,
main_1.8e8_CIs_1yr_composite_usc,
                        layout_matrix = rbind(c(1, 1), c(2, 3)),
             left = textGrob("A", 
                            x = unit(12, "npc"), 
                            y = unit(0.95, "npc"),
                            gp = gpar(fontsize = 12)),
             top = textGrob("B", 
                            x = unit(0, "npc"), 
                            y = unit(-11.5, "npc"),
                            gp = gpar(fontsize = 12)),      
            right = textGrob("C", 
                            x = unit(-18.5, "npc"), 
                            y = unit(0.43, "npc"),
                            gp = gpar(fontsize = 12)))

ggsave("./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_1yr/main_figs_1yr.png", 
       plot = main_1.8e8_CIs_1yr_composite_plots,
       width = 8.6,
       height = 4.85,
       units = "in",
       dpi = 400)
```

### Mu = 1.8e-8 & gen time = 2 yr
#### Export main plot
```{r}
make_ne_plot(full_fig_1.8e8_2yr,
                   "./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_2yr/full_with_inset.png")
```

#### Export DIST plots WITH conf intervals
##### Full plot
```{r}
dist_CIs_2yr <- ggplot(
  all_dist_1.8e8_2yr %>%
    dplyr::filter(Group != "Entire population"),
  aes(x = year))  +
  
  # add vertical lines at breakpoints
  geom_vline(xintercept = as.vector(as.numeric(breakpoint_table$`Years ago`)),
             #   color = "lightgreen",
             color = plasma(9, begin = 0.15, end = 0.9),
             
             linetype = "D3") +
  
  # add median Ne and CIs
  geom_line(aes(color = Group,
                y = Ne_median/1000),
            linewidth = 1,
            linetype = "solid") +
  
  geom_line(aes(color = Group,
                y = Ne_97.5./1000),
            linewidth = 0.5,
            linetype = "dashed") +
  
  geom_line(aes(color = Group,
                y = Ne_2.5./1000),
            linewidth = 0.5,
            linetype = "dashed") +
  
  
  scale_x_continuous(labels = scales::comma,
                     limits = c(NA, 40000)) +
  scale_y_continuous(
    #breaks=c(0, 25000, 50000, 75000, 100000, 125000, 150000),
    labels = scales::comma,
    limits = c(0, 
               NA
    )
  ) +
  scale_color_manual(name = "Group", 
                     labels=c('Rural', 'Urban'),
                     values=c('grey', 'black')) +
  xlab("Years ago") +
  ylab("Median Nₑ (million individuals)") +
  theme_bw() +
  labs_pubr() +
  theme(plot.margin = unit(c(0.5,1,0.5,0.5), "cm"))

ggsave(plot = dist_CIs_2yr,
       filename = "./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_2yr/distance/conf_ints.png",
       width = 17,
       height = 9,
       units = "cm")
```

##### inset plot
```{r}
dist_CIs_inset_2yr <- ggplot(
  all_dist_1.8e8_2yr %>%
    dplyr::filter(Group != "Entire population"),
  aes(x = year))  +
  
  # add vertical lines at breakpoints
  geom_vline(xintercept = as.vector(as.numeric(breakpoint_table$`Years ago`)),
             #   color = "lightgreen",
             color = plasma(9, begin = 0.15, end = 0.9),
             
             linetype = "D3") +
  
  # add median Ne and CIs
  geom_line(aes(color = Group,
                y = Ne_median/1000),
            linewidth = 1,
            # color = "black",
            linetype = "solid") +
  
  geom_line(aes(color = Group,
                y = Ne_97.5./1000),
            linewidth = 0.5,
            # color = "black",
            linetype = "dashed") +
  
  geom_line(aes(color = Group,
                y = Ne_2.5./1000),
            linewidth = 0.5,
            #  color = "black",
            linetype = "dashed") +
  
  
  scale_x_continuous(labels = scales::comma,
                     limits = c(NA, 2300)) +
  scale_y_continuous(
    labels = scales::comma,
    limits = c(0, 
               NA
    )
  ) +
  scale_color_manual(name = "Group", 
                     labels=c('Rural', 'Urban'),
                     values=c('grey', 'black')) +
  xlab("Years ago") +
  ylab("Median Nₑ (million individuals)") +
  theme_bw() +
  labs_pubr() +
  theme(plot.margin = unit(c(0.5,1,0.5,0.5), "cm"))

ggsave(plot = dist_CIs_inset_2yr,
       filename = "./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_2yr/distance/inset_conf_ints.png",
       width = 17,
       height = 9,
       units = "cm")
```

##### Full plot WITH inset
```{r}
dist_plot_CIs_2yr <- dist_CIs_2yr +
  
  theme(plot.margin = unit(c(0.5,1,0.5,0.5), "cm"),
        legend.position = "top") +
  # make legend point size larger
  guides(colour = guide_legend(
    override.aes = list(size=3)))


### Plot inset (past 2300 years)
dist_plot_CIs_inset_2yr <- dist_CIs_inset_2yr +
  
  theme(axis.title = element_blank(),
        plot.background = element_rect(
          colour = "black",
          fill = "white",
          size = 1),
        legend.position = "none")


#### Export
ggsave(plot =
         ### Overlay inset in full figure
         cowplot::ggdraw() +
         draw_plot(dist_plot_CIs_2yr) +
         draw_plot(dist_plot_CIs_inset_2yr,
                   x = 0.6,
                   y = 0.37, 
                   width = 0.34,
                   height = 0.45),     
       filename = here::here("./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_2yr/distance/both_with_inset_CIs.png"),
       height = 5,
       width = 9,
       dpi = 200)
```


#### Export URB SCORE plots WITH conf intervals
##### Full plot
```{r}
usc_CIs_2yr <- ggplot(
  all_usc_1.8e8_2yr %>%
    dplyr::filter(Group != "Entire population"),
  aes(x = year))  +
  
  # add vertical lines at breakpoints
  geom_vline(xintercept = as.vector(as.numeric(breakpoint_table$`Years ago`)),
             #   color = "lightgreen",
             color = plasma(9, begin = 0.15, end = 0.9),
             
             linetype = "D3") +
  
  # add median Ne and CIs
  geom_line(aes(color = Group,
                y = Ne_median/1000),
            linewidth = 1,
            linetype = "solid") +
  
  geom_line(aes(color = Group,
                y = Ne_97.5./1000),
            linewidth = 0.5,
            linetype = "dashed") +
  
  geom_line(aes(color = Group,
                y = Ne_2.5./1000),
            linewidth = 0.5,
            linetype = "dashed") +
  
  scale_x_continuous(labels = scales::comma,
                     limits = c(NA, 40000)) +
  scale_y_continuous(
    #breaks=c(0, 25000, 50000, 75000, 100000, 125000, 150000),
    labels = scales::comma,
    limits = c(0, 
               NA
    )
  ) +
  scale_color_manual(name = "Group", 
                     labels=c('Rural', 'Urban'),
                     values=c('grey', 'black')) +
  xlab("Years ago") +
  ylab("Median Nₑ (million individuals)") +
  theme_bw() +
  labs_pubr() +
  theme(plot.margin = unit(c(0.5,1,0.5,0.5), "cm"))

ggsave(plot = usc_CIs_2yr,
       filename = "./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_2yr/urb_score/conf_ints.png",
       width = 17,
       height = 9,
       units = "cm")
```

##### inset plot
```{r}
usc_CIs_inset_2yr <- ggplot(
  all_usc_1.8e8_2yr %>%
    dplyr::filter(Group != "Entire population"),
  aes(x = year))  +
  
  # add vertical lines at breakpoints
  geom_vline(xintercept = as.vector(as.numeric(breakpoint_table$`Years ago`)),
             #   color = "lightgreen",
             color = plasma(9, begin = 0.15, end = 0.9),
             
             linetype = "D3") +
  
  # add median Ne and CIs
  geom_line(aes(color = Group,
                y = Ne_median/1000),
            linewidth = 1,
            linetype = "solid") +
  
  geom_line(aes(color = Group,
                y = Ne_97.5./1000),
            linewidth = 0.5,
            linetype = "dashed") +
  
  geom_line(aes(color = Group,
                y = Ne_2.5./1000),
            linewidth = 0.5,
            linetype = "dashed") +
  
  scale_x_continuous(labels = scales::comma,
                     limits = c(NA, 2300)) +
  scale_y_continuous(
    labels = scales::comma,
    limits = c(0, 
               NA
    )
  ) +
  scale_color_manual(name = "Group", 
                     labels=c('Rural', 'Urban'),
                     values=c('grey', 'black')) +
  xlab("Years ago") +
  ylab("Median Nₑ (million individuals)") +
  theme_bw() +
  labs_pubr() +
  theme(plot.margin = unit(c(0.5,1,0.5,0.5), "cm"))

ggsave(plot = usc_CIs_inset_2yr,
       filename = "./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_2yr/urb_score/inset_conf_ints.png",
       width = 17,
       height = 9,
       units = "cm")
```

##### Full plot WITH inset
```{r}
usc_plot_CIs_2yr <- usc_CIs_2yr +
  
  theme(plot.margin = unit(c(0.5,1,0.5,0.5), "cm"),
        legend.position = "top") +
  # make legend point size larger
  guides(colour = guide_legend(
    override.aes = list(size=3)))


### Plot inset (past 2300 years)
usc_plot_CIs_inset_2yr <- usc_CIs_inset_2yr +
  
  theme(axis.title = element_blank(),
        plot.background = element_rect(
          colour = "black",
          fill = "white",
          size = 1),
        legend.position = "none")



#### Export
ggsave(plot =
         ### Overlay inset in full figure
         cowplot::ggdraw() +
         draw_plot(usc_plot_CIs_2yr) +
         draw_plot(usc_plot_CIs_inset_2yr,
                   x = 0.6,
                   y = 0.37, 
                   width = 0.34,
                   height = 0.45),    
       filename = here::here("./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_2yr/urb_score/both_with_inset_CIs.png"),
       height = 5,
       width = 9,
       dpi = 200)

```

#### Export dist and usc plots as a composite figure
```{r}
dist_CIs_2yr_composite <- rasterGrob(readPNG(here::here("./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_2yr/distance/both_with_inset_CIs.png")))

usc_CIs_2yr_composite <- rasterGrob(readPNG(here::here("./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_2yr/urb_score/both_with_inset_CIs.png")))


usc_CIs_2yr_composite_plots <- gridExtra::grid.arrange(dist_CIs_2yr_composite, 
                        usc_CIs_2yr_composite,
                        ncol = 1,
             left = textGrob("A", 
                            x = unit(1, "npc"), 
                            y = unit(0.95, "npc"),
                            gp = gpar(fontsize = 12)),
             right = textGrob("B", 
                            x = unit(-26, "npc"), 
                            y = unit(0.45, "npc"),
                            gp = gpar(fontsize = 12)))

ggsave("./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_2yr/main_figs_UR.png", 
       plot = usc_CIs_2yr_composite_plots,
       width = 6,
       height = 6.7,
       units = "in",
       dpi = 400)
```

### Mu = 2.6e-8 & gen time = 1 yr
#### Export main plot
```{r}
make_ne_plot(full_fig_2.6e8,
                   "./Figures_Tables/Stairway_plot/mu_2.6e-8/gen_time_1yr/full_with_inset.png")
```

### Mu = 2.6e-8 & gen time = 2 yr
#### Export main plot
```{r}
make_ne_plot(full_fig_2.6e8_2yrs,
                   "./Figures_Tables/Stairway_plot/mu_2.6e-8/gen_time_2yr/full_with_inset.png")
```

### Export 1yr, variable mutation rate plots as a composite figure
```{r}
mut1e8_CIs_1yr_composite <- rasterGrob(readPNG(here::here("./Figures_Tables/Stairway_plot/mu_1e-8/gen_time_1yr/full_with_inset.png")))

mut1.2e8_CIs_1yr_composite <- rasterGrob(readPNG(here::here("./Figures_Tables/Stairway_plot/mu_1.2e-8/gen_time_1yr/full_with_inset.png")))

mut1.8e8_CIs_1yr_composite <- rasterGrob(readPNG(here::here("./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_1yr/full_with_inset.png")))

mut2.6e8_CIs_1yr_composite <- rasterGrob(readPNG(here::here("./Figures_Tables/Stairway_plot/mu_2.6e-8/gen_time_1yr/full_with_inset.png")))


var_mut_CIs_1yr_composite_plots <- gridExtra::grid.arrange(mut1e8_CIs_1yr_composite, 
                        mut1.2e8_CIs_1yr_composite,
                        mut1.8e8_CIs_1yr_composite,
                        mut2.6e8_CIs_1yr_composite,
                        ncol = 2,
             left = textGrob("A", 
                            x = unit(1, "npc"), 
                            y = unit(0.95, "npc"),
                            gp = gpar(fontsize = 12)),
             right = textGrob("B", 
                            x = unit(-16, "npc"), 
                            y = unit(0.95, "npc"),
                            gp = gpar(fontsize = 12)),
             top = textGrob("C", 
                            x = unit(0, "npc"), 
                            y = unit(-12, "npc"),
                            gp = gpar(fontsize = 12)),
             bottom = textGrob("D", 
                            x = unit(0.51, "npc"), 
                            y = unit(12.4, "npc"),
                            gp = gpar(fontsize = 12)))

ggsave("./Figures_Tables/Stairway_plot/main_figs_1yr_var_mut.png", 
       plot = var_mut_CIs_1yr_composite_plots,
       width = 8*0.9,
       height = 6.2*0.9,
       units = "in",
       dpi = 400)
```

### Export 2yr, variable mutation rate plots as a composite figure
```{r}
mut1e8_CIs_2yr_composite <- rasterGrob(readPNG(here::here("./Figures_Tables/Stairway_plot/mu_1e-8/gen_time_2yr/full_with_inset.png")))

mut1.2e8_CIs_2yr_composite <- rasterGrob(readPNG(here::here("./Figures_Tables/Stairway_plot/mu_1.2e-8/gen_time_2yr/full_with_inset.png")))

mut1.8e8_CIs_2yr_composite <- rasterGrob(readPNG(here::here("./Figures_Tables/Stairway_plot/mu_1.8e-8/gen_time_2yr/full_with_inset.png")))

mut2.6e8_CIs_2yr_composite <- rasterGrob(readPNG(here::here("./Figures_Tables/Stairway_plot/mu_2.6e-8/gen_time_2yr/full_with_inset.png")))


var_mut_CIs_2yr_composite_plots <- gridExtra::grid.arrange(mut1e8_CIs_2yr_composite, 
                        mut1.2e8_CIs_2yr_composite,
                        mut1.8e8_CIs_2yr_composite,
                        mut2.6e8_CIs_2yr_composite,
                        ncol = 2,
             left = textGrob("A", 
                            x = unit(1, "npc"), 
                            y = unit(0.95, "npc"),
                            gp = gpar(fontsize = 12)),
             right = textGrob("B", 
                            x = unit(-16, "npc"), 
                            y = unit(0.95, "npc"),
                            gp = gpar(fontsize = 12)),
             top = textGrob("C", 
                            x = unit(0, "npc"), 
                            y = unit(-12, "npc"),
                            gp = gpar(fontsize = 12)),
             bottom = textGrob("D", 
                            x = unit(0.51, "npc"), 
                            y = unit(12.4, "npc"),
                            gp = gpar(fontsize = 12)))

ggsave("./Figures_Tables/Stairway_plot/main_figs_2yr_var_mut.png", 
       plot = var_mut_CIs_2yr_composite_plots,
       width = 8*0.9,
       height = 6.2*0.9,
       units = "in",
       dpi = 400)
```

# Calculate Ne stats
## mu = 1.8 x 10^-8, gen time = 1 yr
```{r}
Ne_stats(full_fig_1.8e8)
Ne_stats(urb_fig_1.8e8)
#Ne_stats(urb_fig2_1.8e8)
Ne_stats(rur_fig_1.8e8)
#Ne_stats(rur_fig2_1.8e8)

Ne_stats_CI(full_fig_1.8e8)
Ne_stats_CI(urb_fig_1.8e8)
Ne_stats_CI(rur_fig_1.8e8)

```

## mu = 1.8 x 10^-8, gen time = 2 yr
```{r}
Ne_stats(full_fig_1.8e8_2yr)
Ne_stats(urb_fig_1.8e8_2yr)
#Ne_stats(urb_fig2_1.8e8_2yr)
Ne_stats(rur_fig_1.8e8_2yr)
#Ne_stats(rur_fig2_1.8e8_2yr)

Ne_stats_CI(full_fig_1.8e8_2yr)
Ne_stats_CI(urb_fig_1.8e8_2yr)
Ne_stats_CI(rur_fig_1.8e8_2yr)

```

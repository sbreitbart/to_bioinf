# Set up notebook
## Load libraries
```{r}
# install.packages("conStruct")
library(here)
library(tidyverse)
library(magrittr)
library(conStruct)
# install.packages("fields")
library(fields)
```

## Convert allele data in STRUCTURE format to ConStruct format

Following this guide: https://cran.r-project.org/web/packages/conStruct/vignettes/format-data.html#other-formats-to-construct

- copied populations.structure (structure file) to populations_structure.txt, as recommended
- then deleted first line from .txt file: "# Stacks v2.62;  Structure v2.3; April 13, 2023"

This is the "Allele frequency data".
```{r}
allele_frqs <- conStruct::structure2conStruct(
  infile = here::here("./summary_stats/trial_02/output_filtering_fstats_trial06/populations_structure.txt"),
  onerowperind = FALSE,
  start.loci = 3,
  start.samples = 2,
  missing.datum = -9,
  outfile = here("./clean_data/construct_data_trial06"))
```

## Load in other data
### Geographic sampling coordinates
```{r}
# coordinates of all populations
all_coords <- read.csv(here::here("./clean_data/urb_metrics.csv"))

# the populations of this project, in order
pop_map2 <- read.csv(here::here("./genomic_resources/pop_map2.csv")) %>%
  dplyr::rename("sample" = 1)

# add MW IDs to populations that are currently numbers
add_MW_IDs <- function(div_df) {
  # Filter out populations that start with "MWI" or "UTSC"
  MW_pops <- div_df %>%
    filter(!str_detect(population, "MWI")) %>%
    filter(!str_detect(population, "UTSC"))

  # Get populations that start with "MWI" or "UTSC"
  MWI_UTSC_pops <- anti_join(div_df, MW_pops)

  # Split up populations MW001->MW009 vs MW010->MW079
  MW_pops_singledigits <- MW_pops[nchar(as.character(MW_pops$population)) == 1, ]
  MW_pops_doubledigits <- MW_pops[nchar(as.character(MW_pops$population)) != 1, ]

  # Add "MW00" to single-digit populations
  MW_pops_singledigits %<>%
    dplyr::mutate(patch_id = paste0("MW00", population))

  # Add "MW0" to double-digit populations
  MW_pops_doubledigits %<>%
    dplyr::mutate(patch_id = paste0("MW0", population))

  # Bring all entries together again
  all_pops <- full_join(MW_pops_singledigits,
                         MW_pops_doubledigits) %>%
    dplyr::relocate(patch_id, .before = 1) %>%
    full_join(.,
              MWI_UTSC_pops) %>%
    # If patch_id column is NA (for MWI and UTSC values), replace it with value from population
    dplyr::mutate(patch_id = coalesce(patch_id, population))

  return(all_pops)
}
pop_map2_IDs <- add_MW_IDs(pop_map2)

# join coordinates w/current populations
coords <- right_join(coordinates %>%
                      dplyr::select(patch_id, lat, long),
                    pop_map2_IDs %>%
                      dplyr::select(-population),
                    by = "patch_id") %>%
  arrange(sample) %>%
  dplyr::select(long, lat) %>%
  dplyr::rename("Lon" = 1,
                "Lat" = 2) %>%
  as.matrix()
```

### Geographic distance matrix
```{r}
# calculate pairwise great-circle distance between sampling coordinates
distances <- fields::rdist.earth(coords,
                            # distances in km
                            miles = FALSE)
```

# Run spatial model
## Run 1: 4/20/23 (k = 3)
Took about 3-4 hours to run
```{r}
#       the number of layers (K)
#       the allele frequency data (freqs)
#       the geographic distance matrix (geoDist)
#       the sampling coordinates (coords)

spatial_mod_run <- conStruct(spatial = TRUE, 
                    K = 3, 
                    freqs = allele_frqs,
                    geoDist = distances, 
                    coords = coords,
                    prefix = "spK3")
```

Output:

checking data.block

	reading 261 samples
	reading 1362 loci

checking specified model


user has specified a spatial model with 3 layer(s)


SAMPLING FOR MODEL 'space_multiK' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.198 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 1980 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:   1 / 1000 [  0%]  (Warmup)
Chain 1: Iteration: 100 / 1000 [ 10%]  (Warmup)
Chain 1: Iteration: 200 / 1000 [ 20%]  (Warmup)
Chain 1: Iteration: 300 / 1000 [ 30%]  (Warmup)
Chain 1: Iteration: 400 / 1000 [ 40%]  (Warmup)
Chain 1: Iteration: 500 / 1000 [ 50%]  (Warmup)
Chain 1: Iteration: 501 / 1000 [ 50%]  (Sampling)
Chain 1: Iteration: 600 / 1000 [ 60%]  (Sampling)
Chain 1: Iteration: 700 / 1000 [ 70%]  (Sampling)
Chain 1: Iteration: 800 / 1000 [ 80%]  (Sampling)
Chain 1: Iteration: 900 / 1000 [ 90%]  (Sampling)
Chain 1: Iteration: 1000 / 1000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 6583.45 seconds (Warm-up)
Chain 1:                3706.35 seconds (Sampling)
Chain 1:                10289.8 seconds (Total)
Chain 1: 
Warning messages:
1: There were 249 divergent transitions after warmup. See
https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
to find out why this is a problem and how to eliminate them. 
2: Examine the pairs() plot to diagnose sampling problems
3: The largest R-hat is 2.02, indicating chains have not mixed.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#r-hat 
4: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess 
5: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess 

## Run 2: 4/20/23 (k = 2)
Took about 3 hours to run__
```{r}
#       the number of layers (K)
#       the allele frequency data (freqs)
#       the geographic distance matrix (geoDist)
#       the sampling coordinates (coords)

spatial_mod_run2 <- conStruct(spatial = TRUE, 
                    K = 2, 
                    freqs = allele_frqs,
                    geoDist = distances, 
                    coords = coords,
                    prefix = "spK2")
```

Output:

checking data.block

	reading 261 samples
	reading 1362 loci

checking specified model


user has specified a spatial model with 2 layer(s)


SAMPLING FOR MODEL 'space_multiK' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.331 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 3310 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:   1 / 1000 [  0%]  (Warmup)
Chain 1: Iteration: 100 / 1000 [ 10%]  (Warmup)
Chain 1: Iteration: 200 / 1000 [ 20%]  (Warmup)
Chain 1: Iteration: 300 / 1000 [ 30%]  (Warmup)
Chain 1: Iteration: 400 / 1000 [ 40%]  (Warmup)
Chain 1: Iteration: 500 / 1000 [ 50%]  (Warmup)
Chain 1: Iteration: 501 / 1000 [ 50%]  (Sampling)
Chain 1: Iteration: 600 / 1000 [ 60%]  (Sampling)
Chain 1: Iteration: 700 / 1000 [ 70%]  (Sampling)
Chain 1: Iteration: 800 / 1000 [ 80%]  (Sampling)
Chain 1: Iteration: 900 / 1000 [ 90%]  (Sampling)
Chain 1: Iteration: 1000 / 1000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 5022.06 seconds (Warm-up)
Chain 1:                1736.5 seconds (Sampling)
Chain 1:                6758.56 seconds (Total)
Chain 1: 
Warning messages:
1: There were 242 divergent transitions after warmup. See
https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
to find out why this is a problem and how to eliminate them. 
2: Examine the pairs() plot to diagnose sampling problems
 
3: The largest R-hat is 2.12, indicating chains have not mixed.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#r-hat 
4: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess 
5: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess 


## Run 3: 4/20/23 (k = 1)
Took about 20 min
```{r}
#       the number of layers (K)
#       the allele frequency data (freqs)
#       the geographic distance matrix (geoDist)
#       the sampling coordinates (coords)

spatial_mod_run3 <- conStruct(spatial = TRUE, 
                    K = 1, 
                    freqs = allele_frqs,
                    geoDist = distances, 
                    coords = coords,
                    prefix = "spK1")
```

Output:

checking data.block

	reading 261 samples
	reading 1362 loci

checking specified model


user has specified a spatial model with 1 layer(s)


SAMPLING FOR MODEL 'space_oneK' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.205 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 2050 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:   1 / 1000 [  0%]  (Warmup)
Chain 1: Iteration: 100 / 1000 [ 10%]  (Warmup)
Chain 1: Iteration: 200 / 1000 [ 20%]  (Warmup)
Chain 1: Iteration: 300 / 1000 [ 30%]  (Warmup)
Chain 1: Iteration: 400 / 1000 [ 40%]  (Warmup)
Chain 1: Iteration: 500 / 1000 [ 50%]  (Warmup)
Chain 1: Iteration: 501 / 1000 [ 50%]  (Sampling)
Chain 1: Iteration: 600 / 1000 [ 60%]  (Sampling)
Chain 1: Iteration: 700 / 1000 [ 70%]  (Sampling)
Chain 1: Iteration: 800 / 1000 [ 80%]  (Sampling)
Chain 1: Iteration: 900 / 1000 [ 90%]  (Sampling)
Chain 1: Iteration: 1000 / 1000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 430.624 seconds (Warm-up)
Chain 1:                331.916 seconds (Sampling)
Chain 1:                762.54 seconds (Total)
Chain 1: 
Warning messages:
1: The largest R-hat is 1.09, indicating chains have not mixed.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#r-hat 
2: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess 
3: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess 

# Run non-spatial model (like STRUCTURE)
## Run 1: 4/20/23 (k = 2)
Took about 2 hours to run.
```{r}
#       the number of layers (K)
#       the allele frequency data (freqs)
#       the sampling coordinates (coords)
#
#   if you're running the nonspatial model, 
#       you do not have to specify 
#       the geographic distance matrix (geoDist)

nonspatial_mod_run <- conStruct(spatial = FALSE, 
                    K = 2, 
                    freqs = allele_frqs, 
                    geoDist = NULL, 
                    coords = coords,
                    prefix = "nspK2")
```

Output:

SAMPLING FOR MODEL 'multiK' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.035 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 350 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:   1 / 1000 [  0%]  (Warmup)
Chain 1: Iteration: 100 / 1000 [ 10%]  (Warmup)
Chain 1: Iteration: 200 / 1000 [ 20%]  (Warmup)
Chain 1: Iteration: 300 / 1000 [ 30%]  (Warmup)
Chain 1: Iteration: 400 / 1000 [ 40%]  (Warmup)
Chain 1: Iteration: 500 / 1000 [ 50%]  (Warmup)
Chain 1: Iteration: 501 / 1000 [ 50%]  (Sampling)
Chain 1: Iteration: 600 / 1000 [ 60%]  (Sampling)
Chain 1: Iteration: 700 / 1000 [ 70%]  (Sampling)
Chain 1: Iteration: 800 / 1000 [ 80%]  (Sampling)
Chain 1: Iteration: 900 / 1000 [ 90%]  (Sampling)
Chain 1: Iteration: 1000 / 1000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 4184.01 seconds (Warm-up)
Chain 1:                1594.36 seconds (Sampling)
Chain 1:                5778.37 seconds (Total)
Chain 1:

Warning messages:
1: There were 236 divergent transitions after warmup. See
https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup to find out why this is a problem and how to eliminate them. 
2: Examine the pairs() plot to diagnose sampling problems
3: The largest R-hat is 2.12, indicating chains have not mixed.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#r-hat 
4: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess 
5: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess

## Run 2: 4/20/23 (k = 1)
Took about 15 minutes to run.
```{r}
#       the number of layers (K)
#       the allele frequency data (freqs)
#       the sampling coordinates (coords)
#
#   if you're running the nonspatial model, 
#       you do not have to specify 
#       the geographic distance matrix (geoDist)

nonspatial_mod_run2 <- conStruct(spatial = FALSE, 
                    K = 1, 
                    freqs = allele_frqs, 
                    geoDist = NULL, 
                    coords = coords,
                    prefix = "nspK1")
```

Output:

checking data.block

	reading 261 samples
	reading 1362 loci

checking specified model


user has specified a purely discrete model with 1 layer(s)


SAMPLING FOR MODEL 'oneK' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.049 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 490 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:   1 / 1000 [  0%]  (Warmup)
Chain 1: Iteration: 100 / 1000 [ 10%]  (Warmup)
Chain 1: Iteration: 200 / 1000 [ 20%]  (Warmup)
Chain 1: Iteration: 300 / 1000 [ 30%]  (Warmup)
Chain 1: Iteration: 400 / 1000 [ 40%]  (Warmup)
Chain 1: Iteration: 500 / 1000 [ 50%]  (Warmup)
Chain 1: Iteration: 501 / 1000 [ 50%]  (Sampling)
Chain 1: Iteration: 600 / 1000 [ 60%]  (Sampling)
Chain 1: Iteration: 700 / 1000 [ 70%]  (Sampling)
Chain 1: Iteration: 800 / 1000 [ 80%]  (Sampling)
Chain 1: Iteration: 900 / 1000 [ 90%]  (Sampling)
Chain 1: Iteration: 1000 / 1000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 160.941 seconds (Warm-up)
Chain 1:                180.133 seconds (Sampling)
Chain 1:                341.074 seconds (Total)
Chain 1: 
Warning messages:
1: The largest R-hat is 1.06, indicating chains have not mixed.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#r-hat 
2: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess 
3: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess 

## Run 3: 4/20/23 (k = 1), 2000 iterations
Took about 15 minutes to run.
```{r}
#       the number of layers (K)
#       the allele frequency data (freqs)
#       the sampling coordinates (coords)
#
#   if you're running the nonspatial model, 
#       you do not have to specify 
#       the geographic distance matrix (geoDist)

nonspatial_mod_run3 <- conStruct(spatial = FALSE, 
                    K = 1, 
                    freqs = allele_frqs, 
                    geoDist = NULL, 
                    coords = coords,
                    prefix = "nspK1_1",
         # increasing the # of iterations from 1000 to 2000 based on the output from the previous run, which had some warnings that might be alleviated from increasing the number of iterations
                    n.iter = 2000 )
```

Output:

checking data.block

	reading 261 samples
	reading 1362 loci

checking specified model


user has specified a purely discrete model with 1 layer(s)


SAMPLING FOR MODEL 'oneK' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.064 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 640 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 327.072 seconds (Warm-up)
Chain 1:                382.115 seconds (Sampling)
Chain 1:                709.187 seconds (Total)
Chain 1: 
Warning messages:
1: The largest R-hat is 1.06, indicating chains have not mixed.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#r-hat 
2: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess 
3: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess

## Run 4: 4/20/23 (k = 1), 5000 iterations
Took about 30 minutes to run.
```{r}
#       the number of layers (K)
#       the allele frequency data (freqs)
#       the sampling coordinates (coords)
#
#   if you're running the nonspatial model, 
#       you do not have to specify 
#       the geographic distance matrix (geoDist)

nonspatial_mod_run4 <- conStruct(spatial = FALSE, 
                    K = 1, 
                    freqs = allele_frqs, 
                    geoDist = NULL, 
                    coords = coords,
                    prefix = "nspK1_2",
         # increasing the # of iterations from 1000 to 5000 
                    n.iter = 5000 )
```

Output:


checking data.block

	reading 261 samples
	reading 1362 loci

checking specified model


user has specified a purely discrete model with 1 layer(s)


SAMPLING FOR MODEL 'oneK' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.089 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 890 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:    1 / 5000 [  0%]  (Warmup)
Chain 1: Iteration:  500 / 5000 [ 10%]  (Warmup)
Chain 1: Iteration: 1000 / 5000 [ 20%]  (Warmup)
Chain 1: Iteration: 1500 / 5000 [ 30%]  (Warmup)
Chain 1: Iteration: 2000 / 5000 [ 40%]  (Warmup)
Chain 1: Iteration: 2500 / 5000 [ 50%]  (Warmup)
Chain 1: Iteration: 2501 / 5000 [ 50%]  (Sampling)
Chain 1: Iteration: 3000 / 5000 [ 60%]  (Sampling)
Chain 1: Iteration: 3500 / 5000 [ 70%]  (Sampling)
Chain 1: Iteration: 4000 / 5000 [ 80%]  (Sampling)
Chain 1: Iteration: 4500 / 5000 [ 90%]  (Sampling)
Chain 1: Iteration: 5000 / 5000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 895.454 seconds (Warm-up)
Chain 1:                918.618 seconds (Sampling)
Chain 1:                1814.07 seconds (Total)
Chain 1: 
Warning message:
Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess 

## Run 5: 4/20/23 (k = 1), 10,000 iterations
```{r}
#       the number of layers (K)
#       the allele frequency data (freqs)
#       the sampling coordinates (coords)
#
#   if you're running the nonspatial model, 
#       you do not have to specify 
#       the geographic distance matrix (geoDist)

nonspatial_mod_run5 <- conStruct(spatial = FALSE, 
                    K = 1, 
                    freqs = allele_frqs, 
                    geoDist = NULL, 
                    coords = coords,
                    prefix = "nspK1_3",
         # increasing the # of iterations from 1000 to 10000
                    n.iter = 10000 )
```

Output:

checking data.block

	reading 261 samples
	reading 1362 loci

checking specified model


user has specified a purely discrete model with 1 layer(s)


SAMPLING FOR MODEL 'oneK' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.041 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 410 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:    1 / 10000 [  0%]  (Warmup)
Chain 1: Iteration:  500 / 10000 [  5%]  (Warmup)
Chain 1: Iteration: 1000 / 10000 [ 10%]  (Warmup)
Chain 1: Iteration: 1500 / 10000 [ 15%]  (Warmup)
Chain 1: Iteration: 2000 / 10000 [ 20%]  (Warmup)
Chain 1: Iteration: 2500 / 10000 [ 25%]  (Warmup)
Chain 1: Iteration: 3000 / 10000 [ 30%]  (Warmup)
Chain 1: Iteration: 3500 / 10000 [ 35%]  (Warmup)
Chain 1: Iteration: 4000 / 10000 [ 40%]  (Warmup)
Chain 1: Iteration: 4500 / 10000 [ 45%]  (Warmup)
Chain 1: Iteration: 5000 / 10000 [ 50%]  (Warmup)
Chain 1: Iteration: 5001 / 10000 [ 50%]  (Sampling)
Chain 1: Iteration: 5500 / 10000 [ 55%]  (Sampling)
Chain 1: Iteration: 6000 / 10000 [ 60%]  (Sampling)
Chain 1: Iteration: 6500 / 10000 [ 65%]  (Sampling)
Chain 1: Iteration: 7000 / 10000 [ 70%]  (Sampling)
Chain 1: Iteration: 7500 / 10000 [ 75%]  (Sampling)
Chain 1: Iteration: 8000 / 10000 [ 80%]  (Sampling)
Chain 1: Iteration: 8500 / 10000 [ 85%]  (Sampling)
Chain 1: Iteration: 9000 / 10000 [ 90%]  (Sampling)
Chain 1: Iteration: 9500 / 10000 [ 95%]  (Sampling)
Chain 1: Iteration: 10000 / 10000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 1356.03 seconds (Warm-up)
Chain 1:                1586.16 seconds (Sampling)
Chain 1:                2942.19 seconds (Total)
Chain 1: 
Warning messages:
1: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess 
2: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess 

## Run 6: 4/21/23 (k = 1), 10,000 iterations, 2 chains
```{r}
#       the number of layers (K)
#       the allele frequency data (freqs)
#       the sampling coordinates (coords)
#
#   if you're running the nonspatial model, 
#       you do not have to specify 
#       the geographic distance matrix (geoDist)

nonspatial_mod_run6 <- conStruct(spatial = FALSE, 
                    K = 1, 
                    freqs = allele_frqs, 
                    geoDist = NULL, 
                    coords = coords,
                    prefix = "nspK1_4",
                    n.chains = 2,
                    n.iter = 10000 )
```

Output:

checking data.block

	reading 261 samples
	reading 1362 loci

checking specified model


user has specified a purely discrete model with 1 layer(s)


SAMPLING FOR MODEL 'oneK' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.094 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 940 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:    1 / 10000 [  0%]  (Warmup)
Chain 1: Iteration:  500 / 10000 [  5%]  (Warmup)
Chain 1: Iteration: 1000 / 10000 [ 10%]  (Warmup)
Chain 1: Iteration: 1500 / 10000 [ 15%]  (Warmup)
Chain 1: Iteration: 2000 / 10000 [ 20%]  (Warmup)
Chain 1: Iteration: 2500 / 10000 [ 25%]  (Warmup)
Chain 1: Iteration: 3000 / 10000 [ 30%]  (Warmup)
Chain 1: Iteration: 3500 / 10000 [ 35%]  (Warmup)
Chain 1: Iteration: 4000 / 10000 [ 40%]  (Warmup)
Chain 1: Iteration: 4500 / 10000 [ 45%]  (Warmup)
Chain 1: Iteration: 5000 / 10000 [ 50%]  (Warmup)
Chain 1: Iteration: 5001 / 10000 [ 50%]  (Sampling)
Chain 1: Iteration: 5500 / 10000 [ 55%]  (Sampling)
Chain 1: Iteration: 6000 / 10000 [ 60%]  (Sampling)
Chain 1: Iteration: 6500 / 10000 [ 65%]  (Sampling)
Chain 1: Iteration: 7000 / 10000 [ 70%]  (Sampling)
Chain 1: Iteration: 7500 / 10000 [ 75%]  (Sampling)
Chain 1: Iteration: 8000 / 10000 [ 80%]  (Sampling)
Chain 1: Iteration: 8500 / 10000 [ 85%]  (Sampling)
Chain 1: Iteration: 9000 / 10000 [ 90%]  (Sampling)
Chain 1: Iteration: 9500 / 10000 [ 95%]  (Sampling)
Chain 1: Iteration: 10000 / 10000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 1333.1 seconds (Warm-up)
Chain 1:                1563.41 seconds (Sampling)
Chain 1:                2896.51 seconds (Total)
Chain 1: 

SAMPLING FOR MODEL 'oneK' NOW (CHAIN 2).
Chain 2: 
Chain 2: Gradient evaluation took 0.02 seconds
Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 200 seconds.
Chain 2: Adjust your expectations accordingly!
Chain 2: 
Chain 2: 
Chain 2: Iteration:    1 / 10000 [  0%]  (Warmup)
Chain 2: Iteration:  500 / 10000 [  5%]  (Warmup)
Chain 2: Iteration: 1000 / 10000 [ 10%]  (Warmup)
Chain 2: Iteration: 1500 / 10000 [ 15%]  (Warmup)
Chain 2: Iteration: 2000 / 10000 [ 20%]  (Warmup)
Chain 2: Iteration: 2500 / 10000 [ 25%]  (Warmup)
Chain 2: Iteration: 3000 / 10000 [ 30%]  (Warmup)
Chain 2: Iteration: 3500 / 10000 [ 35%]  (Warmup)
Chain 2: Iteration: 4000 / 10000 [ 40%]  (Warmup)
Chain 2: Iteration: 4500 / 10000 [ 45%]  (Warmup)
Chain 2: Iteration: 5000 / 10000 [ 50%]  (Warmup)
Chain 2: Iteration: 5001 / 10000 [ 50%]  (Sampling)
Chain 2: Iteration: 5500 / 10000 [ 55%]  (Sampling)
Chain 2: Iteration: 6000 / 10000 [ 60%]  (Sampling)
Chain 2: Iteration: 6500 / 10000 [ 65%]  (Sampling)
Chain 2: Iteration: 7000 / 10000 [ 70%]  (Sampling)
Chain 2: Iteration: 7500 / 10000 [ 75%]  (Sampling)
Chain 2: Iteration: 8000 / 10000 [ 80%]  (Sampling)
Chain 2: Iteration: 8500 / 10000 [ 85%]  (Sampling)
Chain 2: Iteration: 9000 / 10000 [ 90%]  (Sampling)
Chain 2: Iteration: 9500 / 10000 [ 95%]  (Sampling)
Chain 2: Iteration: 10000 / 10000 [100%]  (Sampling)
Chain 2: 
Chain 2:  Elapsed Time: 1477.82 seconds (Warm-up)
Chain 2:                1945.69 seconds (Sampling)
Chain 2:                3423.51 seconds (Total)
Chain 2: 
Warning message:
Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess 

## Run 7: 4/21/23 (k = 1), 10,000 iterations, 5 chains
```{r}
#       the number of layers (K)
#       the allele frequency data (freqs)
#       the sampling coordinates (coords)
#
#   if you're running the nonspatial model, 
#       you do not have to specify 
#       the geographic distance matrix (geoDist)

nonspatial_mod_run7 <- conStruct(spatial = FALSE, 
                    K = 1, 
                    freqs = allele_frqs, 
                    geoDist = NULL, 
                    coords = coords,
                    prefix = "nspK1_5",
                    n.chains = 5,
                    n.iter = 10000 )
```

Output:



# First thoughts on outputs

- I can (and should) adjust estimates for K (1,2,3, maybe more?)
- I can (and should) rerun these analyses with the SAME the number of independent MCMCs, aka chains (n.chains) to verify my results are consistent
  - "Above, I highlight the importance of evaluating performance of individual MCMC runs, but it’s also a good idea to run multiple, independent analyses and compare results across them. Ideally, multiple independent runs converge on the same stationary distribution, with similar parameter estimates and posterior probabilities.
If different runs give very different results, you can check whether there’s a mixing problem or a truly multi-modal posterior probability surface by comparing the values of the posterior probability across runs. If two runs have very different parameter estimates but their posterior probability distributions are indistinguishable, that’s an indication of multi-modality. If multiple runs show different parameter estimates, but the posterior probabilities for a subset of the runs that show consistent results are higher than those of a different subset that gives conflicting results, that indicates that some of the runs are not mixing well."
- 
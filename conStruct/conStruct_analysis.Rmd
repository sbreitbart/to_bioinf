# Set up notebook
## Load libraries & functions
```{r}
# install.packages("conStruct")
library(here)
library(tidyverse)
library(magrittr)
library(conStruct)
# install.packages("fields")
library(fields)

source("functions.R")
```

## Convert allele data in STRUCTURE format to ConStruct format

Following this guide: https://cran.r-project.org/web/packages/conStruct/vignettes/format-data.html#other-formats-to-construct

- copied populations.structure (structure file) to populations_structure.txt, as recommended
- then deleted first line from .txt file: "# Stacks v2.62;  Structure v2.3; May 05, 2023"

This is the "Allele frequency data".
### (don't have to run)- Create new allele frequency dataset with fewer samples
```{r}
allele_frqs <- conStruct::structure2conStruct(
  infile = here::here("./summary_stats/mmaf0.05_R1_populations_output/populations_structure.txt"),
  onerowperind = FALSE,
  start.loci = 3,
  start.samples = 2,
  missing.datum = -9,
  outfile = here("./clean_data/construct_data_20230605"))




# check dimensions
dim(allele_frqs)
# there are more rows (samples) than columns (loci). This won't do, seeing as I get this error message when I try to use this dataset as-is with the conStruct() function:
# 
# Error in validate.data.block(data.block) : 
# your data must have a greater number of loci than there are samples
# 
# I'll need 182 samples if I have 183 loci.

# check for rows that are identical
allele_frqs %>%
  as.data.frame() %>%
  duplicated() %>%
  any()
# no rows are identical.
# I'll have to remove 261-183=78 samples to get an equal number of 
# loci and samples... so I'll remove 79 samples to get loci > samples.

# load in pop_map2_IDs below FIRST
length(unique(pop_map2_IDs$pop_id))
# there are 123 unique populations, so since 123<183, I'll be able to keep at least 1 replicate from each population in the dataset.

# Identify samples to remove (which are represented a lot)
pop_map2_IDs %>%
  dplyr::group_by(pop_id) %>%
  dplyr::summarise(n = n())
# I can remove samples so that each population has at least 2 replicates and decrease the sample size below 123 (but I'll retain
# enough samples so that some are represented 3x to maximize samples)

# first, remove samples so that each pop is represented up to 3x
subsample <- read.csv(here::here("./genomic_resources/pop_map2.csv")) %>%
  dplyr::rename("sample" = 1,
                "pop_id" = 2)  %>% 
    dplyr::group_by(pop_id) %>% 
    add_MW_IDs() %>%
    dplyr::mutate(count = row_number(),
                  patch_id = as.factor(patch_id),
                  pop_id = as.factor(pop_id)) %>% 
    dplyr::filter(count <= 3) %>% 
    dplyr::ungroup() %>% 
    dplyr::select(-count) %T>%
  print

dim(subsample) # 207 samples. So next, remove 207-182=25 more samples represented 3x

# get 25 more samples from populations represented 3x each
last_samples_to_remove <- subsample %>%
  group_by(patch_id) %>%
  filter(n() == 3) %>%
  dplyr::summarise(sample = first(sample)) %>%
  head(25)

# anti-join to remove those 25 samples from final subset
final_subset <- anti_join(subsample,
                          last_samples_to_remove,
                          by = "sample")


# Create a data frame from allele_frqs_matrix with row and column names

# to create this csv, I copied populations_structure.txt into Excel and created a csv
allele_csv <- read.csv(here::here("./summary_stats/mmaf0.05_R1_populations_output/populations_structure_noheading.csv")) %>%
  dplyr::rename("sample" = 1,
                "pop" = 2)

allele_frqs_subset <- as.data.frame(allele_frqs) %>%
  rownames_to_column() %>%
  dplyr::rename("sample" = rowname) %>%
  dplyr::right_join(., final_subset, by = "sample") #%>%
  column_to_rownames(var = "sample") 

# only keep samples in allele_csv that are in allele_frqs_subset

test <- right_join(allele_frqs_subset,
                   allele_csv,
                   by = "sample")
  




# Define the path to the input .structure file
input_file <- here::here("./summary_stats/mmaf0.05_R1_populations_output/populations.structure")

# Define the list of strings to match
strings_to_keep <- final_subset %>%
  dplyr::select(sample) %>%
  pull()

# Read the .structure file, skipping the first row
structure_file <- readLines(input_file)[-1]

# Filter out the rows based on the first string
filtered_structure_file <- structure_file[sapply(strsplit(structure_file, "\t"), function(x) x[1] %in% strings_to_keep)]

# Write the filtered structure file to a new file
writeLines(c(structure_file[1], filtered_structure_file), here::here("./summary_stats/mmaf0.05_R1_populations_output/filtered_populations.structure"))
```

### Usable allele frq dataset
```{r}
# now, try this again with the subset:
allele_frqs <- conStruct::structure2conStruct(
  infile = here::here("./summary_stats/mmaf0.05_R1_populations_output/filtered_populations.txt"),
  onerowperind = FALSE,
  start.loci = 3,
  start.samples = 2,
  missing.datum = -9,
  outfile = here("./clean_data/construct_data_20230608"))

```

## Load in other data
### Geographic sampling coordinates
#### (don't have to run)- Create coordinates csv
```{r}
# coordinates of all populations
all_coords <- read.csv(here::here("./clean_data/urb_metrics.csv"))

# the populations of this project, in order
pop_map2_IDs <- read.csv(here::here("./genomic_resources/pop_map2.csv")) %>%
  dplyr::rename("sample" = 1,
                "pop_id" = 2) %>%
# add MW IDs to populations that are currently numbers
  add_MW_IDs() %>%
  
# keep only samples in final_subset
  dplyr::right_join(., 
                    final_subset,
                    by = c("patch_id", "sample", "pop_id"))

# join coordinates w/current populations
coords <- right_join(all_coords %>%
                      dplyr::select(patch_id, lat, long),
                    pop_map2_IDs %>%
                      dplyr::select(-pop_id),
                    by = "patch_id") %>%
  arrange(sample) %>%
  dplyr::select(long, lat) %>%
  dplyr::rename("Lon" = 1,
                "Lat" = 2) %>%
  as.matrix() %T>%
  write.csv(here::here("./clean_data/conStruct_coords.csv"))
```

#### Load coordinates matrix
```{r}
coords <- read.csv(here::here("./clean_data/conStruct_coords.csv")) %>%
  dplyr::select(-X) %>%
  as.matrix()
```

### Geographic distance matrix
```{r}
# calculate pairwise great-circle distance between sampling coordinates
distances <- fields::rdist.earth(coords,
                            # distances in km
                            miles = FALSE)
```

# Run spatial model
## Run 1: k = 1, 5,000 iterations, 3 chains- NO WARNINGS!
```{r}
#       the number of layers (K)
#       the allele frequency data (freqs)
#       the geographic distance matrix (geoDist)
#       the sampling coordinates (coords)

spatial_mod_run1 <- conStruct(spatial = TRUE, 
                    K = 1, 
                    freqs = allele_frqs,
                    geoDist = distances, 
                    coords = coords,
                    prefix = "sp_K1_iter5000_chains3",
                    n.chains = 3,
                    n.iter = 5000)
```

Output:


checking data.block

	reading 182 samples
	reading 183 loci

checking specified model


user has specified a spatial model with 1 layer(s)


SAMPLING FOR MODEL 'space_oneK' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.023 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 230 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:    1 / 5000 [  0%]  (Warmup)
Chain 1: Iteration:  500 / 5000 [ 10%]  (Warmup)
Chain 1: Iteration: 1000 / 5000 [ 20%]  (Warmup)
Chain 1: Iteration: 1500 / 5000 [ 30%]  (Warmup)
Chain 1: Iteration: 2000 / 5000 [ 40%]  (Warmup)
Chain 1: Iteration: 2500 / 5000 [ 50%]  (Warmup)
Chain 1: Iteration: 2501 / 5000 [ 50%]  (Sampling)
Chain 1: Iteration: 3000 / 5000 [ 60%]  (Sampling)
Chain 1: Iteration: 3500 / 5000 [ 70%]  (Sampling)
Chain 1: Iteration: 4000 / 5000 [ 80%]  (Sampling)
Chain 1: Iteration: 4500 / 5000 [ 90%]  (Sampling)
Chain 1: Iteration: 5000 / 5000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 656.997 seconds (Warm-up)
Chain 1:                642.672 seconds (Sampling)
Chain 1:                1299.67 seconds (Total)
Chain 1: 

SAMPLING FOR MODEL 'space_oneK' NOW (CHAIN 2).
Chain 2: 
Chain 2: Gradient evaluation took 0.021 seconds
Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 210 seconds.
Chain 2: Adjust your expectations accordingly!
Chain 2: 
Chain 2: 
Chain 2: Iteration:    1 / 5000 [  0%]  (Warmup)
Chain 2: Iteration:  500 / 5000 [ 10%]  (Warmup)
Chain 2: Iteration: 1000 / 5000 [ 20%]  (Warmup)
Chain 2: Iteration: 1500 / 5000 [ 30%]  (Warmup)
Chain 2: Iteration: 2000 / 5000 [ 40%]  (Warmup)
Chain 2: Iteration: 2500 / 5000 [ 50%]  (Warmup)
Chain 2: Iteration: 2501 / 5000 [ 50%]  (Sampling)
Chain 2: Iteration: 3000 / 5000 [ 60%]  (Sampling)
Chain 2: Iteration: 3500 / 5000 [ 70%]  (Sampling)
Chain 2: Iteration: 4000 / 5000 [ 80%]  (Sampling)
Chain 2: Iteration: 4500 / 5000 [ 90%]  (Sampling)
Chain 2: Iteration: 5000 / 5000 [100%]  (Sampling)
Chain 2: 
Chain 2:  Elapsed Time: 1096.32 seconds (Warm-up)
Chain 2:                603.386 seconds (Sampling)
Chain 2:                1699.71 seconds (Total)
Chain 2: 

SAMPLING FOR MODEL 'space_oneK' NOW (CHAIN 3).
Chain 3: 
Chain 3: Gradient evaluation took 0.018 seconds
Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 180 seconds.
Chain 3: Adjust your expectations accordingly!
Chain 3: 
Chain 3: 
Chain 3: Iteration:    1 / 5000 [  0%]  (Warmup)
Chain 3: Iteration:  500 / 5000 [ 10%]  (Warmup)
Chain 3: Iteration: 1000 / 5000 [ 20%]  (Warmup)
Chain 3: Iteration: 1500 / 5000 [ 30%]  (Warmup)
Chain 3: Iteration: 2000 / 5000 [ 40%]  (Warmup)
Chain 3: Iteration: 2500 / 5000 [ 50%]  (Warmup)
Chain 3: Iteration: 2501 / 5000 [ 50%]  (Sampling)
Chain 3: Iteration: 3000 / 5000 [ 60%]  (Sampling)
Chain 3: Iteration: 3500 / 5000 [ 70%]  (Sampling)
Chain 3: Iteration: 4000 / 5000 [ 80%]  (Sampling)
Chain 3: Iteration: 4500 / 5000 [ 90%]  (Sampling)
Chain 3: Iteration: 5000 / 5000 [100%]  (Sampling)
Chain 3: 
Chain 3:  Elapsed Time: 623.914 seconds (Warm-up)
Chain 3:                604.839 seconds (Sampling)
Chain 3:                1228.75 seconds (Total)
Chain 3: 

## Run 2: k = 2, 5,000 iterations, 3 chains- WARNINGS
```{r}
spatial_mod_run2 <- conStruct(spatial = TRUE, 
                    K = 2, 
                    freqs = allele_frqs,
                    geoDist = distances, 
                    coords = coords,
                    prefix = "sp_K2_iter5000_chains3",
                    n.chains = 3,
                    n.iter = 5000)
```

checking data.block

	reading 182 samples
	reading 183 loci

checking specified model


user has specified a spatial model with 2 layer(s)


SAMPLING FOR MODEL 'space_multiK' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.032 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 320 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:    1 / 5000 [  0%]  (Warmup)
Chain 1: Iteration:  500 / 5000 [ 10%]  (Warmup)
Chain 1: Iteration: 1000 / 5000 [ 20%]  (Warmup)
Chain 1: Iteration: 1500 / 5000 [ 30%]  (Warmup)
Chain 1: Iteration: 2000 / 5000 [ 40%]  (Warmup)
Chain 1: Iteration: 2500 / 5000 [ 50%]  (Warmup)
Chain 1: Iteration: 2501 / 5000 [ 50%]  (Sampling)
Chain 1: Iteration: 3000 / 5000 [ 60%]  (Sampling)
Chain 1: Iteration: 3500 / 5000 [ 70%]  (Sampling)
Chain 1: Iteration: 4000 / 5000 [ 80%]  (Sampling)
Chain 1: Iteration: 4500 / 5000 [ 90%]  (Sampling)
Chain 1: Iteration: 5000 / 5000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 2746.66 seconds (Warm-up)
Chain 1:                2723.44 seconds (Sampling)
Chain 1:                5470.1 seconds (Total)
Chain 1: 

SAMPLING FOR MODEL 'space_multiK' NOW (CHAIN 2).
Chain 2: 
Chain 2: Gradient evaluation took 0.028 seconds
Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 280 seconds.
Chain 2: Adjust your expectations accordingly!
Chain 2: 
Chain 2: 
Chain 2: Iteration:    1 / 5000 [  0%]  (Warmup)
Chain 2: Iteration:  500 / 5000 [ 10%]  (Warmup)
Chain 2: Iteration: 1000 / 5000 [ 20%]  (Warmup)
Chain 2: Iteration: 1500 / 5000 [ 30%]  (Warmup)
Chain 2: Iteration: 2000 / 5000 [ 40%]  (Warmup)
Chain 2: Iteration: 2500 / 5000 [ 50%]  (Warmup)
Chain 2: Iteration: 2501 / 5000 [ 50%]  (Sampling)
Chain 2: Iteration: 3000 / 5000 [ 60%]  (Sampling)
Chain 2: Iteration: 3500 / 5000 [ 70%]  (Sampling)
Chain 2: Iteration: 4000 / 5000 [ 80%]  (Sampling)
Chain 2: Iteration: 4500 / 5000 [ 90%]  (Sampling)
Chain 2: Iteration: 5000 / 5000 [100%]  (Sampling)
Chain 2: 
Chain 2:  Elapsed Time: 2881.1 seconds (Warm-up)
Chain 2:                2462.78 seconds (Sampling)
Chain 2:                5343.88 seconds (Total)
Chain 2: 

SAMPLING FOR MODEL 'space_multiK' NOW (CHAIN 3).
Chain 3: 
Chain 3: Gradient evaluation took 0.036 seconds
Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 360 seconds.
Chain 3: Adjust your expectations accordingly!
Chain 3: 
Chain 3: 
Chain 3: Iteration:    1 / 5000 [  0%]  (Warmup)
Chain 3: Iteration:  500 / 5000 [ 10%]  (Warmup)
Chain 3: Iteration: 1000 / 5000 [ 20%]  (Warmup)
Chain 3: Iteration: 1500 / 5000 [ 30%]  (Warmup)
Chain 3: Iteration: 2000 / 5000 [ 40%]  (Warmup)
Chain 3: Iteration: 2500 / 5000 [ 50%]  (Warmup)
Chain 3: Iteration: 2501 / 5000 [ 50%]  (Sampling)
Chain 3: Iteration: 3000 / 5000 [ 60%]  (Sampling)
Chain 3: Iteration: 3500 / 5000 [ 70%]  (Sampling)
Chain 3: Iteration: 4000 / 5000 [ 80%]  (Sampling)
Chain 3: Iteration: 4500 / 5000 [ 90%]  (Sampling)
Chain 3: Iteration: 5000 / 5000 [100%]  (Sampling)
Chain 3: 
Chain 3:  Elapsed Time: 3419.14 seconds (Warm-up)
Chain 3:                1568.07 seconds (Sampling)
Chain 3:                4987.21 seconds (Total)
Chain 3: 
Warning messages:
1: There were 737 divergent transitions after warmup. See
https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
to find out why this is a problem and how to eliminate them. 
2: Examine the pairs() plot to diagnose sampling problems
 
3: The largest R-hat is 1.68, indicating chains have not mixed.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#r-hat 
4: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess 
5: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess

## Run 3: k = 2, 10,000 iterations, 3 chains- WARNINGS
```{r}
spatial_mod_run3 <- conStruct(spatial = TRUE, 
                    K = 2, 
                    freqs = allele_frqs,
                    geoDist = distances, 
                    coords = coords,
                    prefix = "sp_K2_iter10000_chains3",
                    n.chains = 3,
                    n.iter = 10000)
```


checking data.block

	reading 182 samples
	reading 183 loci

checking specified model


user has specified a spatial model with 2 layer(s)


SAMPLING FOR MODEL 'space_multiK' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.174 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 1740 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:    1 / 10000 [  0%]  (Warmup)
Chain 1: Iteration:  500 / 10000 [  5%]  (Warmup)
Chain 1: Iteration: 1000 / 10000 [ 10%]  (Warmup)
Chain 1: Iteration: 1500 / 10000 [ 15%]  (Warmup)
Chain 1: Iteration: 2000 / 10000 [ 20%]  (Warmup)
Chain 1: Iteration: 2500 / 10000 [ 25%]  (Warmup)
Chain 1: Iteration: 3000 / 10000 [ 30%]  (Warmup)
Chain 1: Iteration: 3500 / 10000 [ 35%]  (Warmup)
Chain 1: Iteration: 4000 / 10000 [ 40%]  (Warmup)
Chain 1: Iteration: 4500 / 10000 [ 45%]  (Warmup)
Chain 1: Iteration: 5000 / 10000 [ 50%]  (Warmup)
Chain 1: Iteration: 5001 / 10000 [ 50%]  (Sampling)
Chain 1: Iteration: 5500 / 10000 [ 55%]  (Sampling)
Chain 1: Iteration: 6000 / 10000 [ 60%]  (Sampling)
Chain 1: Iteration: 6500 / 10000 [ 65%]  (Sampling)
Chain 1: Iteration: 7000 / 10000 [ 70%]  (Sampling)
Chain 1: Iteration: 7500 / 10000 [ 75%]  (Sampling)
Chain 1: Iteration: 8000 / 10000 [ 80%]  (Sampling)
Chain 1: Iteration: 8500 / 10000 [ 85%]  (Sampling)
Chain 1: Iteration: 9000 / 10000 [ 90%]  (Sampling)
Chain 1: Iteration: 9500 / 10000 [ 95%]  (Sampling)
Chain 1: Iteration: 10000 / 10000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 5241.9 seconds (Warm-up)
Chain 1:                3342.29 seconds (Sampling)
Chain 1:                8584.19 seconds (Total)
Chain 1: 

SAMPLING FOR MODEL 'space_multiK' NOW (CHAIN 2).
Chain 2: 
Chain 2: Gradient evaluation took 0.027 seconds
Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 270 seconds.
Chain 2: Adjust your expectations accordingly!
Chain 2: 
Chain 2: 
Chain 2: Iteration:    1 / 10000 [  0%]  (Warmup)
Chain 2: Iteration:  500 / 10000 [  5%]  (Warmup)
Chain 2: Iteration: 1000 / 10000 [ 10%]  (Warmup)
Chain 2: Iteration: 1500 / 10000 [ 15%]  (Warmup)
Chain 2: Iteration: 2000 / 10000 [ 20%]  (Warmup)
Chain 2: Iteration: 2500 / 10000 [ 25%]  (Warmup)
Chain 2: Iteration: 3000 / 10000 [ 30%]  (Warmup)
Chain 2: Iteration: 3500 / 10000 [ 35%]  (Warmup)
Chain 2: Iteration: 4000 / 10000 [ 40%]  (Warmup)
Chain 2: Iteration: 4500 / 10000 [ 45%]  (Warmup)
Chain 2: Iteration: 5000 / 10000 [ 50%]  (Warmup)
Chain 2: Iteration: 5001 / 10000 [ 50%]  (Sampling)
Chain 2: Iteration: 5500 / 10000 [ 55%]  (Sampling)
Chain 2: Iteration: 6000 / 10000 [ 60%]  (Sampling)
Chain 2: Iteration: 6500 / 10000 [ 65%]  (Sampling)
Chain 2: Iteration: 7000 / 10000 [ 70%]  (Sampling)
Chain 2: Iteration: 7500 / 10000 [ 75%]  (Sampling)
Chain 2: Iteration: 8000 / 10000 [ 80%]  (Sampling)
Chain 2: Iteration: 8500 / 10000 [ 85%]  (Sampling)
Chain 2: Iteration: 9000 / 10000 [ 90%]  (Sampling)
Chain 2: Iteration: 9500 / 10000 [ 95%]  (Sampling)
Chain 2: Iteration: 10000 / 10000 [100%]  (Sampling)
Chain 2: 
Chain 2:  Elapsed Time: 5599.86 seconds (Warm-up)
Chain 2:                3127.18 seconds (Sampling)
Chain 2:                8727.04 seconds (Total)
Chain 2: 

SAMPLING FOR MODEL 'space_multiK' NOW (CHAIN 3).
Chain 3: 
Chain 3: Gradient evaluation took 0.038 seconds
Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 380 seconds.
Chain 3: Adjust your expectations accordingly!
Chain 3: 
Chain 3: 
Chain 3: Iteration:    1 / 10000 [  0%]  (Warmup)
Chain 3: Iteration:  500 / 10000 [  5%]  (Warmup)
Chain 3: Iteration: 1000 / 10000 [ 10%]  (Warmup)
Chain 3: Iteration: 1500 / 10000 [ 15%]  (Warmup)
Chain 3: Iteration: 2000 / 10000 [ 20%]  (Warmup)
Chain 3: Iteration: 2500 / 10000 [ 25%]  (Warmup)
Chain 3: Iteration: 3000 / 10000 [ 30%]  (Warmup)
Chain 3: Iteration: 3500 / 10000 [ 35%]  (Warmup)
Chain 3: Iteration: 4000 / 10000 [ 40%]  (Warmup)
Chain 3: Iteration: 4500 / 10000 [ 45%]  (Warmup)
Chain 3: Iteration: 5000 / 10000 [ 50%]  (Warmup)
Chain 3: Iteration: 5001 / 10000 [ 50%]  (Sampling)
Chain 3: Iteration: 5500 / 10000 [ 55%]  (Sampling)
Chain 3: Iteration: 6000 / 10000 [ 60%]  (Sampling)
Chain 3: Iteration: 6500 / 10000 [ 65%]  (Sampling)
Chain 3: Iteration: 7000 / 10000 [ 70%]  (Sampling)
Chain 3: Iteration: 7500 / 10000 [ 75%]  (Sampling)
Chain 3: Iteration: 8000 / 10000 [ 80%]  (Sampling)
Chain 3: Iteration: 8500 / 10000 [ 85%]  (Sampling)
Chain 3: Iteration: 9000 / 10000 [ 90%]  (Sampling)
Chain 3: Iteration: 9500 / 10000 [ 95%]  (Sampling)
Chain 3: Iteration: 10000 / 10000 [100%]  (Sampling)
Chain 3: 
Chain 3:  Elapsed Time: 5668.35 seconds (Warm-up)
Chain 3:                4516.07 seconds (Sampling)
Chain 3:                10184.4 seconds (Total)
Chain 3: 
Warning messages:
1: There were 722 divergent transitions after warmup. See
https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
to find out why this is a problem and how to eliminate them. 
2: Examine the pairs() plot to diagnose sampling problems
 
3: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess 
4: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess 

## Run 4: k = 2, 5,000 iterations, 5 chains- WARNINGS
```{r}
spatial_mod_run4 <- conStruct(spatial = TRUE, 
                    K = 2, 
                    freqs = allele_frqs,
                    geoDist = distances, 
                    coords = coords,
                    prefix = "sp_K2_iter5000_chains5",
                    n.chains = 5,
                    n.iter = 5000)
```

checking data.block

	reading 182 samples
	reading 183 loci

checking specified model


user has specified a spatial model with 2 layer(s)


SAMPLING FOR MODEL 'space_multiK' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.148 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 1480 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:    1 / 5000 [  0%]  (Warmup)
Chain 1: Iteration:  500 / 5000 [ 10%]  (Warmup)
Chain 1: Iteration: 1000 / 5000 [ 20%]  (Warmup)
Chain 1: Iteration: 1500 / 5000 [ 30%]  (Warmup)
Chain 1: Iteration: 2000 / 5000 [ 40%]  (Warmup)
Chain 1: Iteration: 2500 / 5000 [ 50%]  (Warmup)
Chain 1: Iteration: 2501 / 5000 [ 50%]  (Sampling)
Chain 1: Iteration: 3000 / 5000 [ 60%]  (Sampling)
Chain 1: Iteration: 3500 / 5000 [ 70%]  (Sampling)
Chain 1: Iteration: 4000 / 5000 [ 80%]  (Sampling)
Chain 1: Iteration: 4500 / 5000 [ 90%]  (Sampling)
Chain 1: Iteration: 5000 / 5000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 2874.27 seconds (Warm-up)
Chain 1:                1515.63 seconds (Sampling)
Chain 1:                4389.9 seconds (Total)
Chain 1: 

SAMPLING FOR MODEL 'space_multiK' NOW (CHAIN 2).
Chain 2: 
Chain 2: Gradient evaluation took 0.029 seconds
Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 290 seconds.
Chain 2: Adjust your expectations accordingly!
Chain 2: 
Chain 2: 
Chain 2: Iteration:    1 / 5000 [  0%]  (Warmup)
Chain 2: Iteration:  500 / 5000 [ 10%]  (Warmup)
Chain 2: Iteration: 1000 / 5000 [ 20%]  (Warmup)
Chain 2: Iteration: 1500 / 5000 [ 30%]  (Warmup)
Chain 2: Iteration: 2000 / 5000 [ 40%]  (Warmup)
Chain 2: Iteration: 2500 / 5000 [ 50%]  (Warmup)
Chain 2: Iteration: 2501 / 5000 [ 50%]  (Sampling)
Chain 2: Iteration: 3000 / 5000 [ 60%]  (Sampling)
Chain 2: Iteration: 3500 / 5000 [ 70%]  (Sampling)
Chain 2: Iteration: 4000 / 5000 [ 80%]  (Sampling)
Chain 2: Iteration: 4500 / 5000 [ 90%]  (Sampling)
Chain 2: Iteration: 5000 / 5000 [100%]  (Sampling)
Chain 2: 
Chain 2:  Elapsed Time: 2687.72 seconds (Warm-up)
Chain 2:                1900.71 seconds (Sampling)
Chain 2:                4588.42 seconds (Total)
Chain 2: 

SAMPLING FOR MODEL 'space_multiK' NOW (CHAIN 3).
Chain 3: 
Chain 3: Gradient evaluation took 0.025 seconds
Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 250 seconds.
Chain 3: Adjust your expectations accordingly!
Chain 3: 
Chain 3: 
Chain 3: Iteration:    1 / 5000 [  0%]  (Warmup)
Chain 3: Iteration:  500 / 5000 [ 10%]  (Warmup)
Chain 3: Iteration: 1000 / 5000 [ 20%]  (Warmup)
Chain 3: Iteration: 1500 / 5000 [ 30%]  (Warmup)
Chain 3: Iteration: 2000 / 5000 [ 40%]  (Warmup)
Chain 3: Iteration: 2500 / 5000 [ 50%]  (Warmup)
Chain 3: Iteration: 2501 / 5000 [ 50%]  (Sampling)
Chain 3: Iteration: 3000 / 5000 [ 60%]  (Sampling)
Chain 3: Iteration: 3500 / 5000 [ 70%]  (Sampling)
Chain 3: Iteration: 4000 / 5000 [ 80%]  (Sampling)
Chain 3: Iteration: 4500 / 5000 [ 90%]  (Sampling)
Chain 3: Iteration: 5000 / 5000 [100%]  (Sampling)
Chain 3: 
Chain 3:  Elapsed Time: 2708.82 seconds (Warm-up)
Chain 3:                2323.2 seconds (Sampling)
Chain 3:                5032.02 seconds (Total)
Chain 3: 

SAMPLING FOR MODEL 'space_multiK' NOW (CHAIN 4).
Chain 4: 
Chain 4: Gradient evaluation took 0.024 seconds
Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 240 seconds.
Chain 4: Adjust your expectations accordingly!
Chain 4: 
Chain 4: 
Chain 4: Iteration:    1 / 5000 [  0%]  (Warmup)
Chain 4: Iteration:  500 / 5000 [ 10%]  (Warmup)
Chain 4: Iteration: 1000 / 5000 [ 20%]  (Warmup)
Chain 4: Iteration: 1500 / 5000 [ 30%]  (Warmup)
Chain 4: Iteration: 2000 / 5000 [ 40%]  (Warmup)
Chain 4: Iteration: 2500 / 5000 [ 50%]  (Warmup)
Chain 4: Iteration: 2501 / 5000 [ 50%]  (Sampling)
Chain 4: Iteration: 3000 / 5000 [ 60%]  (Sampling)
Chain 4: Iteration: 3500 / 5000 [ 70%]  (Sampling)
Chain 4: Iteration: 4000 / 5000 [ 80%]  (Sampling)
Chain 4: Iteration: 4500 / 5000 [ 90%]  (Sampling)
Chain 4: Iteration: 5000 / 5000 [100%]  (Sampling)
Chain 4: 
Chain 4:  Elapsed Time: 3315.99 seconds (Warm-up)
Chain 4:                1833.4 seconds (Sampling)
Chain 4:                5149.39 seconds (Total)
Chain 4: 

SAMPLING FOR MODEL 'space_multiK' NOW (CHAIN 5).
Chain 5: 
Chain 5: Gradient evaluation took 0.03 seconds
Chain 5: 1000 transitions using 10 leapfrog steps per transition would take 300 seconds.
Chain 5: Adjust your expectations accordingly!
Chain 5: 
Chain 5: 
Chain 5: Iteration:    1 / 5000 [  0%]  (Warmup)
Chain 5: Iteration:  500 / 5000 [ 10%]  (Warmup)
Chain 5: Iteration: 1000 / 5000 [ 20%]  (Warmup)
Chain 5: Iteration: 1500 / 5000 [ 30%]  (Warmup)
Chain 5: Iteration: 2000 / 5000 [ 40%]  (Warmup)
Chain 5: Iteration: 2500 / 5000 [ 50%]  (Warmup)
Chain 5: Iteration: 2501 / 5000 [ 50%]  (Sampling)
Chain 5: Iteration: 3000 / 5000 [ 60%]  (Sampling)
Chain 5: Iteration: 3500 / 5000 [ 70%]  (Sampling)
Chain 5: Iteration: 4000 / 5000 [ 80%]  (Sampling)
Chain 5: Iteration: 4500 / 5000 [ 90%]  (Sampling)
Chain 5: Iteration: 5000 / 5000 [100%]  (Sampling)
Chain 5: 
Chain 5:  Elapsed Time: 2659.1 seconds (Warm-up)
Chain 5:                1529.29 seconds (Sampling)
Chain 5:                4188.39 seconds (Total)
Chain 5: 
Warning messages:
1: There were 1227 divergent transitions after warmup. See
https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
to find out why this is a problem and how to eliminate them. 
2: Examine the pairs() plot to diagnose sampling problems
 
3: The largest R-hat is 1.71, indicating chains have not mixed.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#r-hat 
4: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess 
5: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess 

## Run 5: k = 2, 10,000 iterations, 5 chains- WARNINGS
```{r}
spatial_mod_run5 <- conStruct(spatial = TRUE, 
                    K = 2, 
                    freqs = allele_frqs,
                    geoDist = distances, 
                    coords = coords,
                    prefix = "sp_K2_iter10000_chains5",
                    n.chains = 5,
                    n.iter = 10000)
```

checking data.block

	reading 182 samples
	reading 183 loci

checking specified model


user has specified a spatial model with 2 layer(s)


SAMPLING FOR MODEL 'space_multiK' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.155 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 1550 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:    1 / 10000 [  0%]  (Warmup)
Chain 1: Iteration:  500 / 10000 [  5%]  (Warmup)
Chain 1: Iteration: 1000 / 10000 [ 10%]  (Warmup)
Chain 1: Iteration: 1500 / 10000 [ 15%]  (Warmup)
Chain 1: Iteration: 2000 / 10000 [ 20%]  (Warmup)
Chain 1: Iteration: 2500 / 10000 [ 25%]  (Warmup)
Chain 1: Iteration: 3000 / 10000 [ 30%]  (Warmup)
Chain 1: Iteration: 3500 / 10000 [ 35%]  (Warmup)
Chain 1: Iteration: 4000 / 10000 [ 40%]  (Warmup)
Chain 1: Iteration: 4500 / 10000 [ 45%]  (Warmup)
Chain 1: Iteration: 5000 / 10000 [ 50%]  (Warmup)
Chain 1: Iteration: 5001 / 10000 [ 50%]  (Sampling)
Chain 1: Iteration: 5500 / 10000 [ 55%]  (Sampling)
Chain 1: Iteration: 6000 / 10000 [ 60%]  (Sampling)
Chain 1: Iteration: 6500 / 10000 [ 65%]  (Sampling)
Chain 1: Iteration: 7000 / 10000 [ 70%]  (Sampling)
Chain 1: Iteration: 7500 / 10000 [ 75%]  (Sampling)
Chain 1: Iteration: 8000 / 10000 [ 80%]  (Sampling)
Chain 1: Iteration: 8500 / 10000 [ 85%]  (Sampling)
Chain 1: Iteration: 9000 / 10000 [ 90%]  (Sampling)
Chain 1: Iteration: 9500 / 10000 [ 95%]  (Sampling)
Chain 1: Iteration: 10000 / 10000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 5836.21 seconds (Warm-up)
Chain 1:                5280.93 seconds (Sampling)
Chain 1:                11117.1 seconds (Total)
Chain 1: 

SAMPLING FOR MODEL 'space_multiK' NOW (CHAIN 2).
Chain 2: 
Chain 2: Gradient evaluation took 0.025 seconds
Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 250 seconds.
Chain 2: Adjust your expectations accordingly!
Chain 2: 
Chain 2: 
Chain 2: Iteration:    1 / 10000 [  0%]  (Warmup)
Chain 2: Iteration:  500 / 10000 [  5%]  (Warmup)
Chain 2: Iteration: 1000 / 10000 [ 10%]  (Warmup)
Chain 2: Iteration: 1500 / 10000 [ 15%]  (Warmup)
Chain 2: Iteration: 2000 / 10000 [ 20%]  (Warmup)
Chain 2: Iteration: 2500 / 10000 [ 25%]  (Warmup)
Chain 2: Iteration: 3000 / 10000 [ 30%]  (Warmup)
Chain 2: Iteration: 3500 / 10000 [ 35%]  (Warmup)
Chain 2: Iteration: 4000 / 10000 [ 40%]  (Warmup)
Chain 2: Iteration: 4500 / 10000 [ 45%]  (Warmup)
Chain 2: Iteration: 5000 / 10000 [ 50%]  (Warmup)
Chain 2: Iteration: 5001 / 10000 [ 50%]  (Sampling)
Chain 2: Iteration: 5500 / 10000 [ 55%]  (Sampling)
Chain 2: Iteration: 6000 / 10000 [ 60%]  (Sampling)
Chain 2: Iteration: 6500 / 10000 [ 65%]  (Sampling)
Chain 2: Iteration: 7000 / 10000 [ 70%]  (Sampling)
Chain 2: Iteration: 7500 / 10000 [ 75%]  (Sampling)
Chain 2: Iteration: 8000 / 10000 [ 80%]  (Sampling)
Chain 2: Iteration: 8500 / 10000 [ 85%]  (Sampling)
Chain 2: Iteration: 9000 / 10000 [ 90%]  (Sampling)
Chain 2: Iteration: 9500 / 10000 [ 95%]  (Sampling)
Chain 2: Iteration: 10000 / 10000 [100%]  (Sampling)
Chain 2: 
Chain 2:  Elapsed Time: 5678.33 seconds (Warm-up)
Chain 2:                24325.8 seconds (Sampling)
Chain 2:                30004.2 seconds (Total)
Chain 2: 

SAMPLING FOR MODEL 'space_multiK' NOW (CHAIN 3).
Chain 3: 
Chain 3: Gradient evaluation took 0.034 seconds
Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 340 seconds.
Chain 3: Adjust your expectations accordingly!
Chain 3: 
Chain 3: 
Chain 3: Iteration:    1 / 10000 [  0%]  (Warmup)
Chain 3: Iteration:  500 / 10000 [  5%]  (Warmup)
Chain 3: Iteration: 1000 / 10000 [ 10%]  (Warmup)
Chain 3: Iteration: 1500 / 10000 [ 15%]  (Warmup)
Chain 3: Iteration: 2000 / 10000 [ 20%]  (Warmup)
Chain 3: Iteration: 2500 / 10000 [ 25%]  (Warmup)
Chain 3: Iteration: 3000 / 10000 [ 30%]  (Warmup)
Chain 3: Iteration: 3500 / 10000 [ 35%]  (Warmup)
Chain 3: Iteration: 4000 / 10000 [ 40%]  (Warmup)
Chain 3: Iteration: 4500 / 10000 [ 45%]  (Warmup)
Chain 3: Iteration: 5000 / 10000 [ 50%]  (Warmup)
Chain 3: Iteration: 5001 / 10000 [ 50%]  (Sampling)
Chain 3: Iteration: 5500 / 10000 [ 55%]  (Sampling)
Chain 3: Iteration: 6000 / 10000 [ 60%]  (Sampling)
Chain 3: Iteration: 6500 / 10000 [ 65%]  (Sampling)
Chain 3: Iteration: 7000 / 10000 [ 70%]  (Sampling)
Chain 3: Iteration: 7500 / 10000 [ 75%]  (Sampling)
Chain 3: Iteration: 8000 / 10000 [ 80%]  (Sampling)
Chain 3: Iteration: 8500 / 10000 [ 85%]  (Sampling)
Chain 3: Iteration: 9000 / 10000 [ 90%]  (Sampling)
Chain 3: Iteration: 9500 / 10000 [ 95%]  (Sampling)
Chain 3: Iteration: 10000 / 10000 [100%]  (Sampling)
Chain 3: 
Chain 3:  Elapsed Time: 5393.43 seconds (Warm-up)
Chain 3:                5682.78 seconds (Sampling)
Chain 3:                11076.2 seconds (Total)
Chain 3: 

SAMPLING FOR MODEL 'space_multiK' NOW (CHAIN 4).
Chain 4: 
Chain 4: Gradient evaluation took 0.025 seconds
Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 250 seconds.
Chain 4: Adjust your expectations accordingly!
Chain 4: 
Chain 4: 
Chain 4: Iteration:    1 / 10000 [  0%]  (Warmup)
Chain 4: Iteration:  500 / 10000 [  5%]  (Warmup)
Chain 4: Iteration: 1000 / 10000 [ 10%]  (Warmup)
Chain 4: Iteration: 1500 / 10000 [ 15%]  (Warmup)
Chain 4: Iteration: 2000 / 10000 [ 20%]  (Warmup)
Chain 4: Iteration: 2500 / 10000 [ 25%]  (Warmup)
Chain 4: Iteration: 3000 / 10000 [ 30%]  (Warmup)
Chain 4: Iteration: 3500 / 10000 [ 35%]  (Warmup)
Chain 4: Iteration: 4000 / 10000 [ 40%]  (Warmup)
Chain 4: Iteration: 4500 / 10000 [ 45%]  (Warmup)
Chain 4: Iteration: 5000 / 10000 [ 50%]  (Warmup)
Chain 4: Iteration: 5001 / 10000 [ 50%]  (Sampling)
Chain 4: Iteration: 5500 / 10000 [ 55%]  (Sampling)
Chain 4: Iteration: 6000 / 10000 [ 60%]  (Sampling)
Chain 4: Iteration: 6500 / 10000 [ 65%]  (Sampling)
Chain 4: Iteration: 7000 / 10000 [ 70%]  (Sampling)
Chain 4: Iteration: 7500 / 10000 [ 75%]  (Sampling)
Chain 4: Iteration: 8000 / 10000 [ 80%]  (Sampling)
Chain 4: Iteration: 8500 / 10000 [ 85%]  (Sampling)
Chain 4: Iteration: 9000 / 10000 [ 90%]  (Sampling)
Chain 4: Iteration: 9500 / 10000 [ 95%]  (Sampling)
Chain 4: Iteration: 10000 / 10000 [100%]  (Sampling)
Chain 4: 
Chain 4:  Elapsed Time: 4612.71 seconds (Warm-up)
Chain 4:                2464.71 seconds (Sampling)
Chain 4:                7077.42 seconds (Total)
Chain 4: 

SAMPLING FOR MODEL 'space_multiK' NOW (CHAIN 5).
Chain 5: 
Chain 5: Gradient evaluation took 0.025 seconds
Chain 5: 1000 transitions using 10 leapfrog steps per transition would take 250 seconds.
Chain 5: Adjust your expectations accordingly!
Chain 5: 
Chain 5: 
Chain 5: Iteration:    1 / 10000 [  0%]  (Warmup)
Chain 5: Iteration:  500 / 10000 [  5%]  (Warmup)
Chain 5: Iteration: 1000 / 10000 [ 10%]  (Warmup)
Chain 5: Iteration: 1500 / 10000 [ 15%]  (Warmup)
Chain 5: Iteration: 2000 / 10000 [ 20%]  (Warmup)
Chain 5: Iteration: 2500 / 10000 [ 25%]  (Warmup)
Chain 5: Iteration: 3000 / 10000 [ 30%]  (Warmup)
Chain 5: Iteration: 3500 / 10000 [ 35%]  (Warmup)
Chain 5: Iteration: 4000 / 10000 [ 40%]  (Warmup)
Chain 5: Iteration: 4500 / 10000 [ 45%]  (Warmup)
Chain 5: Iteration: 5000 / 10000 [ 50%]  (Warmup)
Chain 5: Iteration: 5001 / 10000 [ 50%]  (Sampling)
Chain 5: Iteration: 5500 / 10000 [ 55%]  (Sampling)
Chain 5: Iteration: 6000 / 10000 [ 60%]  (Sampling)
Chain 5: Iteration: 6500 / 10000 [ 65%]  (Sampling)
Chain 5: Iteration: 7000 / 10000 [ 70%]  (Sampling)
Chain 5: Iteration: 7500 / 10000 [ 75%]  (Sampling)
Chain 5: Iteration: 8000 / 10000 [ 80%]  (Sampling)
Chain 5: Iteration: 8500 / 10000 [ 85%]  (Sampling)
Chain 5: Iteration: 9000 / 10000 [ 90%]  (Sampling)
Chain 5: Iteration: 9500 / 10000 [ 95%]  (Sampling)
Chain 5: Iteration: 10000 / 10000 [100%]  (Sampling)
Chain 5: 
Chain 5:  Elapsed Time: 4681.8 seconds (Warm-up)
Chain 5:                3598.33 seconds (Sampling)
Chain 5:                8280.13 seconds (Total)
Chain 5: 
Warning messages:
1: There were 1230 divergent transitions after warmup. See
https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
to find out why this is a problem and how to eliminate them. 
2: Examine the pairs() plot to diagnose sampling problems
 
3: The largest R-hat is 1.69, indicating chains have not mixed.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#r-hat 
4: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess 
5: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess

## Run 6: k = 3, 5,000 iterations, 3 chains- WARNINGS
```{r}
conStruct(spatial = TRUE, 
                    K = 3, 
                    freqs = allele_frqs,
                    geoDist = distances, 
                    coords = coords,
                    prefix = "sp_K3_iter5000_chains3",
                    n.chains = 3,
                    n.iter = 5000)
```

Warning messages:
1: There were 744 divergent transitions after warmup. See
https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
to find out why this is a problem and how to eliminate them. 
2: Examine the pairs() plot to diagnose sampling problems
 
3: The largest R-hat is 1.69, indicating chains have not mixed.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#r-hat 
4: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess 
5: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess 


## Run 7: k = 4, 5,000 iterations, 3 chains- WARNINGS
```{r}
conStruct(spatial = TRUE, 
                    K = 4, 
                    freqs = allele_frqs,
                    geoDist = distances, 
                    coords = coords,
                    prefix = "sp_K4_iter5000_chains3",
                    n.chains = 3,
                    n.iter = 5000)
```

Warning messages:
1: There were 740 divergent transitions after warmup. See
https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
to find out why this is a problem and how to eliminate them. 
2: Examine the pairs() plot to diagnose sampling problems
 
3: The largest R-hat is 1.69, indicating chains have not mixed.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#r-hat 
4: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess 
5: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess


## Run 8: k = 5, 5,000 iterations, 3 chains- would've taken days to run so I stopped it mid-way through
```{r}
conStruct(spatial = TRUE, 
                    K =5, 
                    freqs = allele_frqs,
                    geoDist = distances, 
                    coords = coords,
                    prefix = "sp_K5_iter5000_chains3",
                    n.chains = 3,
                    n.iter = 5000)
```



# Run non-spatial model (like STRUCTURE)
## Run 1: k = 1, 5,000 iterations, 3 chains- NO WARNINGS!
```{r}
#       the number of layers (K)
#       the allele frequency data (freqs)
#       the sampling coordinates (coords)
#
#   if you're running the nonspatial model, 
#       you do not have to specify 
#       the geographic distance matrix (geoDist)

nonspatial_mod_run1 <- conStruct(spatial = FALSE, 
                    K = 1, 
                    freqs = allele_frqs, 
                    geoDist = NULL, 
                    coords = coords,
                    prefix = "nsp_K1_iter5000_chains3",
                    n.chains = 3,
                    n.iter = 5000)
```

Output:
checking data.block

	reading 182 samples
	reading 183 loci

checking specified model


user has specified a purely discrete model with 1 layer(s)


SAMPLING FOR MODEL 'oneK' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.027 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 270 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:    1 / 5000 [  0%]  (Warmup)
Chain 1: Iteration:  500 / 5000 [ 10%]  (Warmup)
Chain 1: Iteration: 1000 / 5000 [ 20%]  (Warmup)
Chain 1: Iteration: 1500 / 5000 [ 30%]  (Warmup)
Chain 1: Iteration: 2000 / 5000 [ 40%]  (Warmup)
Chain 1: Iteration: 2500 / 5000 [ 50%]  (Warmup)
Chain 1: Iteration: 2501 / 5000 [ 50%]  (Sampling)
Chain 1: Iteration: 3000 / 5000 [ 60%]  (Sampling)
Chain 1: Iteration: 3500 / 5000 [ 70%]  (Sampling)
Chain 1: Iteration: 4000 / 5000 [ 80%]  (Sampling)
Chain 1: Iteration: 4500 / 5000 [ 90%]  (Sampling)
Chain 1: Iteration: 5000 / 5000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 248.823 seconds (Warm-up)
Chain 1:                318.529 seconds (Sampling)
Chain 1:                567.352 seconds (Total)
Chain 1: 

SAMPLING FOR MODEL 'oneK' NOW (CHAIN 2).
Chain 2: 
Chain 2: Gradient evaluation took 0.009 seconds
Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 90 seconds.
Chain 2: Adjust your expectations accordingly!
Chain 2: 
Chain 2: 
Chain 2: Iteration:    1 / 5000 [  0%]  (Warmup)
Chain 2: Iteration:  500 / 5000 [ 10%]  (Warmup)
Chain 2: Iteration: 1000 / 5000 [ 20%]  (Warmup)
Chain 2: Iteration: 1500 / 5000 [ 30%]  (Warmup)
Chain 2: Iteration: 2000 / 5000 [ 40%]  (Warmup)
Chain 2: Iteration: 2500 / 5000 [ 50%]  (Warmup)
Chain 2: Iteration: 2501 / 5000 [ 50%]  (Sampling)
Chain 2: Iteration: 3000 / 5000 [ 60%]  (Sampling)
Chain 2: Iteration: 3500 / 5000 [ 70%]  (Sampling)
Chain 2: Iteration: 4000 / 5000 [ 80%]  (Sampling)
Chain 2: Iteration: 4500 / 5000 [ 90%]  (Sampling)
Chain 2: Iteration: 5000 / 5000 [100%]  (Sampling)
Chain 2: 
Chain 2:  Elapsed Time: 268.369 seconds (Warm-up)
Chain 2:                328.238 seconds (Sampling)
Chain 2:                596.607 seconds (Total)
Chain 2: 

SAMPLING FOR MODEL 'oneK' NOW (CHAIN 3).
Chain 3: 
Chain 3: Gradient evaluation took 0.007 seconds
Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 70 seconds.
Chain 3: Adjust your expectations accordingly!
Chain 3: 
Chain 3: 
Chain 3: Iteration:    1 / 5000 [  0%]  (Warmup)
Chain 3: Iteration:  500 / 5000 [ 10%]  (Warmup)
Chain 3: Iteration: 1000 / 5000 [ 20%]  (Warmup)
Chain 3: Iteration: 1500 / 5000 [ 30%]  (Warmup)
Chain 3: Iteration: 2000 / 5000 [ 40%]  (Warmup)
Chain 3: Iteration: 2500 / 5000 [ 50%]  (Warmup)
Chain 3: Iteration: 2501 / 5000 [ 50%]  (Sampling)
Chain 3: Iteration: 3000 / 5000 [ 60%]  (Sampling)
Chain 3: Iteration: 3500 / 5000 [ 70%]  (Sampling)
Chain 3: Iteration: 4000 / 5000 [ 80%]  (Sampling)
Chain 3: Iteration: 4500 / 5000 [ 90%]  (Sampling)
Chain 3: Iteration: 5000 / 5000 [100%]  (Sampling)
Chain 3: 
Chain 3:  Elapsed Time: 234.394 seconds (Warm-up)
Chain 3:                306.08 seconds (Sampling)
Chain 3:                540.474 seconds (Total)
Chain 3: 

## Run 2: k = 2, 5,000 iterations, 3 chains- WARNINGS
```{r}
nonspatial_mod_run2 <- conStruct(spatial = FALSE, 
                    K = 2, 
                    freqs = allele_frqs, 
                    geoDist = NULL, 
                    coords = coords,
                    prefix = "nsp_K2_iter5000_chains3",
                    n.chains = 3,
                    n.iter = 5000)
```

checking data.block

	reading 182 samples
	reading 183 loci

checking specified model


user has specified a purely discrete model with 2 layer(s)


SAMPLING FOR MODEL 'multiK' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.183 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 1830 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:    1 / 5000 [  0%]  (Warmup)
Chain 1: Iteration:  500 / 5000 [ 10%]  (Warmup)
Chain 1: Iteration: 1000 / 5000 [ 20%]  (Warmup)
Chain 1: Iteration: 1500 / 5000 [ 30%]  (Warmup)
Chain 1: Iteration: 2000 / 5000 [ 40%]  (Warmup)
Chain 1: Iteration: 2500 / 5000 [ 50%]  (Warmup)
Chain 1: Iteration: 2501 / 5000 [ 50%]  (Sampling)
Chain 1: Iteration: 3000 / 5000 [ 60%]  (Sampling)
Chain 1: Iteration: 3500 / 5000 [ 70%]  (Sampling)
Chain 1: Iteration: 4000 / 5000 [ 80%]  (Sampling)
Chain 1: Iteration: 4500 / 5000 [ 90%]  (Sampling)
Chain 1: Iteration: 5000 / 5000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 2438.73 seconds (Warm-up)
Chain 1:                739.572 seconds (Sampling)
Chain 1:                3178.31 seconds (Total)
Chain 1: 

SAMPLING FOR MODEL 'multiK' NOW (CHAIN 2).
Chain 2: 
Chain 2: Gradient evaluation took 0.016 seconds
Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 160 seconds.
Chain 2: Adjust your expectations accordingly!
Chain 2: 
Chain 2: 
Chain 2: Iteration:    1 / 5000 [  0%]  (Warmup)
Chain 2: Iteration:  500 / 5000 [ 10%]  (Warmup)
Chain 2: Iteration: 1000 / 5000 [ 20%]  (Warmup)
Chain 2: Iteration: 1500 / 5000 [ 30%]  (Warmup)
Chain 2: Iteration: 2000 / 5000 [ 40%]  (Warmup)
Chain 2: Iteration: 2500 / 5000 [ 50%]  (Warmup)
Chain 2: Iteration: 2501 / 5000 [ 50%]  (Sampling)
Chain 2: Iteration: 3000 / 5000 [ 60%]  (Sampling)
Chain 2: Iteration: 3500 / 5000 [ 70%]  (Sampling)
Chain 2: Iteration: 4000 / 5000 [ 80%]  (Sampling)
Chain 2: Iteration: 4500 / 5000 [ 90%]  (Sampling)
Chain 2: Iteration: 5000 / 5000 [100%]  (Sampling)
Chain 2: 
Chain 2:  Elapsed Time: 1531.22 seconds (Warm-up)
Chain 2:                659.378 seconds (Sampling)
Chain 2:                2190.6 seconds (Total)
Chain 2: 

SAMPLING FOR MODEL 'multiK' NOW (CHAIN 3).
Chain 3: 
Chain 3: Gradient evaluation took 0.024 seconds
Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 240 seconds.
Chain 3: Adjust your expectations accordingly!
Chain 3: 
Chain 3: 
Chain 3: Iteration:    1 / 5000 [  0%]  (Warmup)
Chain 3: Iteration:  500 / 5000 [ 10%]  (Warmup)
Chain 3: Iteration: 1000 / 5000 [ 20%]  (Warmup)
Chain 3: Iteration: 1500 / 5000 [ 30%]  (Warmup)
Chain 3: Iteration: 2000 / 5000 [ 40%]  (Warmup)
Chain 3: Iteration: 2500 / 5000 [ 50%]  (Warmup)
Chain 3: Iteration: 2501 / 5000 [ 50%]  (Sampling)
Chain 3: Iteration: 3000 / 5000 [ 60%]  (Sampling)
Chain 3: Iteration: 3500 / 5000 [ 70%]  (Sampling)
Chain 3: Iteration: 4000 / 5000 [ 80%]  (Sampling)
Chain 3: Iteration: 4500 / 5000 [ 90%]  (Sampling)
Chain 3: Iteration: 5000 / 5000 [100%]  (Sampling)
Chain 3: 
Chain 3:  Elapsed Time: 1668.97 seconds (Warm-up)
Chain 3:                1049.09 seconds (Sampling)
Chain 3:                2718.06 seconds (Total)
Chain 3: 
Warning messages:
1: There were 743 divergent transitions after warmup. See
https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
to find out why this is a problem and how to eliminate them. 
2: Examine the pairs() plot to diagnose sampling problems
 
3: The largest R-hat is 1.25, indicating chains have not mixed.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#r-hat 
4: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess 
5: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess
## Run 3: k = 2, 10,000 iterations, 3 chains- WARNINGS
```{r}
nonspatial_mod_run3 <- conStruct(spatial = FALSE, 
                    K = 2, 
                    freqs = allele_frqs, 
                    geoDist = NULL, 
                    coords = coords,
                    prefix = "nsp_K2_iter10000_chains3",
                    n.chains = 3,
                    n.iter = 10000)
```

checking data.block

	reading 182 samples
	reading 183 loci

checking specified model


user has specified a purely discrete model with 2 layer(s)


SAMPLING FOR MODEL 'multiK' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.103 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 1030 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:    1 / 10000 [  0%]  (Warmup)
Chain 1: Iteration:  500 / 10000 [  5%]  (Warmup)
Chain 1: Iteration: 1000 / 10000 [ 10%]  (Warmup)
Chain 1: Iteration: 1500 / 10000 [ 15%]  (Warmup)
Chain 1: Iteration: 2000 / 10000 [ 20%]  (Warmup)
Chain 1: Iteration: 2500 / 10000 [ 25%]  (Warmup)
Chain 1: Iteration: 3000 / 10000 [ 30%]  (Warmup)
Chain 1: Iteration: 3500 / 10000 [ 35%]  (Warmup)
Chain 1: Iteration: 4000 / 10000 [ 40%]  (Warmup)
Chain 1: Iteration: 4500 / 10000 [ 45%]  (Warmup)
Chain 1: Iteration: 5000 / 10000 [ 50%]  (Warmup)
Chain 1: Iteration: 5001 / 10000 [ 50%]  (Sampling)
Chain 1: Iteration: 5500 / 10000 [ 55%]  (Sampling)
Chain 1: Iteration: 6000 / 10000 [ 60%]  (Sampling)
Chain 1: Iteration: 6500 / 10000 [ 65%]  (Sampling)
Chain 1: Iteration: 7000 / 10000 [ 70%]  (Sampling)
Chain 1: Iteration: 7500 / 10000 [ 75%]  (Sampling)
Chain 1: Iteration: 8000 / 10000 [ 80%]  (Sampling)
Chain 1: Iteration: 8500 / 10000 [ 85%]  (Sampling)
Chain 1: Iteration: 9000 / 10000 [ 90%]  (Sampling)
Chain 1: Iteration: 9500 / 10000 [ 95%]  (Sampling)
Chain 1: Iteration: 10000 / 10000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 2715.7 seconds (Warm-up)
Chain 1:                1297.68 seconds (Sampling)
Chain 1:                4013.37 seconds (Total)
Chain 1: 

SAMPLING FOR MODEL 'multiK' NOW (CHAIN 2).
Chain 2: 
Chain 2: Gradient evaluation took 0.017 seconds
Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 170 seconds.
Chain 2: Adjust your expectations accordingly!
Chain 2: 
Chain 2: 
Chain 2: Iteration:    1 / 10000 [  0%]  (Warmup)
Chain 2: Iteration:  500 / 10000 [  5%]  (Warmup)
Chain 2: Iteration: 1000 / 10000 [ 10%]  (Warmup)
Chain 2: Iteration: 1500 / 10000 [ 15%]  (Warmup)
Chain 2: Iteration: 2000 / 10000 [ 20%]  (Warmup)
Chain 2: Iteration: 2500 / 10000 [ 25%]  (Warmup)
Chain 2: Iteration: 3000 / 10000 [ 30%]  (Warmup)
Chain 2: Iteration: 3500 / 10000 [ 35%]  (Warmup)
Chain 2: Iteration: 4000 / 10000 [ 40%]  (Warmup)
Chain 2: Iteration: 4500 / 10000 [ 45%]  (Warmup)
Chain 2: Iteration: 5000 / 10000 [ 50%]  (Warmup)
Chain 2: Iteration: 5001 / 10000 [ 50%]  (Sampling)
Chain 2: Iteration: 5500 / 10000 [ 55%]  (Sampling)
Chain 2: Iteration: 6000 / 10000 [ 60%]  (Sampling)
Chain 2: Iteration: 6500 / 10000 [ 65%]  (Sampling)
Chain 2: Iteration: 7000 / 10000 [ 70%]  (Sampling)
Chain 2: Iteration: 7500 / 10000 [ 75%]  (Sampling)
Chain 2: Iteration: 8000 / 10000 [ 80%]  (Sampling)
Chain 2: Iteration: 8500 / 10000 [ 85%]  (Sampling)
Chain 2: Iteration: 9000 / 10000 [ 90%]  (Sampling)
Chain 2: Iteration: 9500 / 10000 [ 95%]  (Sampling)
Chain 2: Iteration: 10000 / 10000 [100%]  (Sampling)
Chain 2: 
Chain 2:  Elapsed Time: 2472.45 seconds (Warm-up)
Chain 2:                1139.55 seconds (Sampling)
Chain 2:                3612 seconds (Total)
Chain 2: 

SAMPLING FOR MODEL 'multiK' NOW (CHAIN 3).
Chain 3: 
Chain 3: Gradient evaluation took 0.017 seconds
Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 170 seconds.
Chain 3: Adjust your expectations accordingly!
Chain 3: 
Chain 3: 
Chain 3: Iteration:    1 / 10000 [  0%]  (Warmup)
Chain 3: Iteration:  500 / 10000 [  5%]  (Warmup)
Chain 3: Iteration: 1000 / 10000 [ 10%]  (Warmup)
Chain 3: Iteration: 1500 / 10000 [ 15%]  (Warmup)
Chain 3: Iteration: 2000 / 10000 [ 20%]  (Warmup)
Chain 3: Iteration: 2500 / 10000 [ 25%]  (Warmup)
Chain 3: Iteration: 3000 / 10000 [ 30%]  (Warmup)
Chain 3: Iteration: 3500 / 10000 [ 35%]  (Warmup)
Chain 3: Iteration: 4000 / 10000 [ 40%]  (Warmup)
Chain 3: Iteration: 4500 / 10000 [ 45%]  (Warmup)
Chain 3: Iteration: 5000 / 10000 [ 50%]  (Warmup)
Chain 3: Iteration: 5001 / 10000 [ 50%]  (Sampling)
Chain 3: Iteration: 5500 / 10000 [ 55%]  (Sampling)
Chain 3: Iteration: 6000 / 10000 [ 60%]  (Sampling)
Chain 3: Iteration: 6500 / 10000 [ 65%]  (Sampling)
Chain 3: Iteration: 7000 / 10000 [ 70%]  (Sampling)
Chain 3: Iteration: 7500 / 10000 [ 75%]  (Sampling)
Chain 3: Iteration: 8000 / 10000 [ 80%]  (Sampling)
Chain 3: Iteration: 8500 / 10000 [ 85%]  (Sampling)
Chain 3: Iteration: 9000 / 10000 [ 90%]  (Sampling)
Chain 3: Iteration: 9500 / 10000 [ 95%]  (Sampling)
Chain 3: Iteration: 10000 / 10000 [100%]  (Sampling)
Chain 3: 
Chain 3:  Elapsed Time: 2572.44 seconds (Warm-up)
Chain 3:                2112.45 seconds (Sampling)
Chain 3:                4684.89 seconds (Total)
Chain 3: 
Warning messages:
1: There were 743 divergent transitions after warmup. See
https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
to find out why this is a problem and how to eliminate them. 
2: Examine the pairs() plot to diagnose sampling problems
 
3: The largest R-hat is 1.12, indicating chains have not mixed.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#r-hat 
4: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess 
5: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess 
## Run 4: k = 3, 5,000 iterations, 3 chains- WARNINGS
```{r}
conStruct(spatial = FALSE, 
                    K = 3, 
                    freqs = allele_frqs, 
                    geoDist = NULL, 
                    coords = coords,
                    prefix = "nsp_K3_iter5000_chains3",
                    n.chains = 3,
                    n.iter = 5000)
```

Warning messages:
1: There were 748 divergent transitions after warmup. See
https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
to find out why this is a problem and how to eliminate them. 
2: Examine the pairs() plot to diagnose sampling problems
 
3: The largest R-hat is 1.24, indicating chains have not mixed.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#r-hat 
4: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess 
5: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess 

## Run 5: k = 4, 5,000 iterations, 3 chains- WARNINGS
```{r}
conStruct(spatial = FALSE, 
                    K = 4, 
                    freqs = allele_frqs, 
                    geoDist = NULL, 
                    coords = coords,
                    prefix = "nsp_K4_iter5000_chains3",
                    n.chains = 3,
                    n.iter = 5000)
```

Warning messages:
1: There were 749 divergent transitions after warmup. See
https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
to find out why this is a problem and how to eliminate them. 
2: Examine the pairs() plot to diagnose sampling problems
 
3: The largest R-hat is 1.54, indicating chains have not mixed.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#r-hat 
4: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess 
5: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess 

## Run 6: k = 5, 5,000 iterations, 3 chains- WARNINGS
```{r}
conStruct(spatial = FALSE, 
                    K = 5, 
                    freqs = allele_frqs, 
                    geoDist = NULL, 
                    coords = coords,
                    prefix = "nsp_K5_iter5000_chains3",
                    n.chains = 3,
                    n.iter = 5000)
```



# Compare models
## Calculate layer contributions
### spatial
```{r}

# Create an empty matrix to store layer contributions
layer.contributions <- matrix(NA, nrow = 5, ncol = 5)

# Load the conStruct.results.Robj and data.block.Robj files for K=1
load( here::here("./conStruct/spatial_rObjs/sp_K1_iter5000_chains3_conStruct.results.Robj"))
load( here::here("./conStruct/spatial_rObjs/sp_K1_iter5000_chains3_data.block.Robj"))

# Calculate layer contributions for K=1
layer.contributions[, 1] <- c(calculate.layer.contribution(conStruct.results[[1]], data.block), rep(0, 4))
tmp <- conStruct.results[[1]]$MAP$admix.proportions




# Load the conStruct.results.Robj and data.block.Robj files for K=1
load( here::here("./conStruct/spatial_rObjs/sp_K2_iter5000_chains3_conStruct.results.Robj"))
load( here::here("./conStruct/spatial_rObjs/sp_K2_iter5000_chains3_data.block.Robj"))

# Calculate layer contributions for K=2
layer.contributions[, 2] <- c(calculate.layer.contribution(conStruct.results[[1]], data.block), rep(0,3))
tmp <- conStruct.results[[1]]$MAP$admix.proportions




# Load the conStruct.results.Robj and data.block.Robj files for K=1
load( here::here("./conStruct/spatial_rObjs/sp_K3_iter5000_chains3_conStruct.results.Robj"))
load( here::here("./conStruct/spatial_rObjs/sp_K3_iter5000_chains3_data.block.Robj"))

# Calculate layer contributions for K=3
layer.contributions[, 3] <- c(calculate.layer.contribution(conStruct.results[[1]], data.block), rep(0, 2))
tmp <- conStruct.results[[1]]$MAP$admix.proportions

```

### non-spatial
```{r}

# Create an empty matrix to store layer contributions
layer.contributions_nsp <- matrix(NA, nrow = 5, ncol = 5)

# Load the conStruct.results.Robj and data.block.Robj files for K=1
load( here::here("./conStruct/nspatial_rObjs/nsp_K1_iter5000_chains3_conStruct.results.Robj"))
load( here::here("./conStruct/nspatial_rObjs/nsp_K1_iter5000_chains3_data.block.Robj"))

# Calculate layer contributions for K=1
layer.contributions_nsp[, 1] <- c(calculate.layer.contribution(conStruct.results[[1]], data.block), rep(0, 4))
tmp <- conStruct.results[[1]]$MAP$admix.proportions




# Load the conStruct.results.Robj and data.block.Robj files for K=1
load( here::here("./conStruct/nspatial_rObjs/nsp_K2_iter5000_chains3_conStruct.results.Robj"))
load( here::here("./conStruct/nspatial_rObjs/nsp_K2_iter5000_chains3_data.block.Robj"))

# Calculate layer contributions for K=2
layer.contributions_nsp[, 2] <- c(calculate.layer.contribution(conStruct.results[[1]], data.block), rep(0,3))
tmp <- conStruct.results[[1]]$MAP$admix.proportions




# Load the conStruct.results.Robj and data.block.Robj files for K=1
load( here::here("./conStruct/nspatial_rObjs/nsp_K3_iter5000_chains3_conStruct.results.Robj"))
load( here::here("./conStruct/nspatial_rObjs/nsp_K3_iter5000_chains3_data.block.Robj"))

# Calculate layer contributions for K=3
layer.contributions_nsp[, 3] <- c(calculate.layer.contribution(conStruct.results[[1]], data.block), rep(0, 2))
tmp <- conStruct.results[[1]]$MAP$admix.proportions

```


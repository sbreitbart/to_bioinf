# Set up notebook
## Load libraries & functions
```{r}
# install.packages("conStruct")
library(here)
library(tidyverse)
library(magrittr)
library(conStruct)
# install.packages("fields")
library(fields)
library(parallel)

source("functions.R")
```

## Convert allele data in STRUCTURE format to ConStruct format

Following this guide: https://cran.r-project.org/web/packages/conStruct/vignettes/format-data.html#other-formats-to-construct

- copied populations.structure (structure file) to populations_structure.txt, as recommended
- then deleted first line from .txt file: "# Stacks v2.62;  Structure v2.3; June 10, 2023"

This is the "Allele frequency data".
```{r}
allele_frqs <- conStruct::structure2conStruct(
  infile = here::here("./summary_stats/output_populations_no-IBD/mmaf0.05_R0.75/populations.structure.txt"),
  onerowperind = FALSE,
  start.loci = 3,
  start.samples = 2,
  missing.datum = -9,
  outfile = here("./clean_data/construct_data_20230613"))

```

## Load in other data
### Geographic sampling coordinates
#### (don't have to run)- Create coordinates csv
```{r}
# # coordinates of all populations
# all_coords <- read.csv(here::here("./clean_data/urb_metrics.csv"))
# 
# # the populations of this project, in order
# pop_map3_IDs <- read.csv(here::here("./genomic_resources/pop_map3.csv")) %>%
#   dplyr::rename("sample" = 1,
#                 "pop_id" = 2) %>%
# # add MW IDs to populations that are currently numbers
#   add_MW_IDs() 
# 
# # join coordinates w/current populations
# coords <- right_join(all_coords %>%
#                       dplyr::select(patch_id, lat, long),
#                     pop_map3_IDs %>%
#                       dplyr::select(-pop_id),
#                     by = "patch_id") %>%
#   arrange(sample) %>%
#   dplyr::select(long, lat) %>%
#   dplyr::rename("Lon" = 1,
#                 "Lat" = 2) %>%
#   as.matrix() %T>%
#   write.csv(here::here("./clean_data/conStruct_coords.csv"))
```

#### Load coordinates matrix
```{r}
coords <- read.csv(here::here("./clean_data/conStruct_coords.csv")) %>%
  dplyr::select(-X) %>%
  as.matrix()
```

### Geographic distance matrix
```{r}
# calculate pairwise great-circle distance between sampling coordinates
distances <- fields::rdist.earth(coords,
                            # distances in km
                            miles = FALSE)
```

# Run models (didn't actually run in RStudio- see note below)

At first, I ran these in Rstudio on my local computer. But then, I increased the required computational power and ran these on the HPC. These are example scripts.


## EXAMPLE spatial model: k = 1, 5,000 iterations, 3 chains
```{r}
#       the number of layers (K)
#       the allele frequency data (freqs)
#       the geographic distance matrix (geoDist)
#       the sampling coordinates (coords)

conStruct(spatial = TRUE, 
                    K = 1, 
                    freqs = allele_frqs,
                    geoDist = distances, 
                    coords = coords,
                    prefix = "sp_K1_iter5000_chains3",
                    n.chains = 3,
                    n.iter = 5000)
```

## EXAMPLE non-spatial model (like STRUCTURE): k = 1, 5,000 iterations, 3 chains
```{r}
#       the number of layers (K)
#       the allele frequency data (freqs)
#       the sampling coordinates (coords)
#
#   if you're running the nonspatial model, 
#       you do not have to specify 
#       the geographic distance matrix (geoDist)

conStruct(spatial = FALSE, 
                    K = 1, 
                    freqs = allele_frqs, 
                    geoDist = NULL, 
                    coords = coords,
                    prefix = "nsp_K1_iter5000_chains3",
                    n.chains = 3,
                    n.iter = 5000)
```

## Try parallelizing
### Non-spatial, k = 2
```{r}
library(foreach)
library(doParallel)

# Set the number of cores to be used
num_cores <- 6

# Initialize parallel backend using doParallel
cl <- makeCluster(num_cores)
registerDoParallel(cl)

# Run non-spatial model in parallel
nonspatial_mod_run2 <- foreach(i = 1:num_cores, .packages = "conStruct") %dopar% {
  conStruct(spatial = FALSE,
            K = 2,
            freqs = allele_frqs,
            geoDist = NULL,
            coords = coords,
            prefix = paste0("nsp_K2_iter10000_chains5_", i),
            n.chains = 5,
            n.iter = 10000)
}

print("nonspatial mod run complete")

# Stop the parallel backend
stopCluster(cl)

```

# Compare models
## Calculate layer contributions
### spatial
```{r}

# Create an empty matrix to store layer contributions
layer.contributions <- matrix(NA, nrow = 5, ncol = 5)

# Load the conStruct.results.Robj and data.block.Robj files for K=1
load( here::here("./conStruct/spatial_rObjs/sp_K1_iter5000_chains3_conStruct.results.Robj"))
load( here::here("./conStruct/spatial_rObjs/sp_K1_iter5000_chains3_data.block.Robj"))

# Calculate layer contributions for K=1
layer.contributions[, 1] <- c(calculate.layer.contribution(conStruct.results[[1]], data.block), rep(0, 4))
tmp <- conStruct.results[[1]]$MAP$admix.proportions




# Load the conStruct.results.Robj and data.block.Robj files for K=1
load( here::here("./conStruct/spatial_rObjs/sp_K2_iter5000_chains3_conStruct.results.Robj"))
load( here::here("./conStruct/spatial_rObjs/sp_K2_iter5000_chains3_data.block.Robj"))

# Calculate layer contributions for K=2
layer.contributions[, 2] <- c(calculate.layer.contribution(conStruct.results[[1]], data.block), rep(0,3))
tmp <- conStruct.results[[1]]$MAP$admix.proportions




# Load the conStruct.results.Robj and data.block.Robj files for K=1
load( here::here("./conStruct/spatial_rObjs/sp_K3_iter5000_chains3_conStruct.results.Robj"))
load( here::here("./conStruct/spatial_rObjs/sp_K3_iter5000_chains3_data.block.Robj"))

# Calculate layer contributions for K=3
layer.contributions[, 3] <- c(calculate.layer.contribution(conStruct.results[[1]], data.block), rep(0, 2))
tmp <- conStruct.results[[1]]$MAP$admix.proportions

```

### non-spatial
```{r}

# Create an empty matrix to store layer contributions
layer.contributions_nsp <- matrix(NA, nrow = 5, ncol = 5)

# Load the conStruct.results.Robj and data.block.Robj files for K=1
load( here::here("./conStruct/nspatial_rObjs/nsp_K1_iter5000_chains3_conStruct.results.Robj"))
load( here::here("./conStruct/nspatial_rObjs/nsp_K1_iter5000_chains3_data.block.Robj"))

# Calculate layer contributions for K=1
layer.contributions_nsp[, 1] <- c(calculate.layer.contribution(conStruct.results[[1]], data.block), rep(0, 4))
tmp <- conStruct.results[[1]]$MAP$admix.proportions




# Load the conStruct.results.Robj and data.block.Robj files for K=1
load( here::here("./conStruct/nspatial_rObjs/nsp_K2_iter5000_chains3_conStruct.results.Robj"))
load( here::here("./conStruct/nspatial_rObjs/nsp_K2_iter5000_chains3_data.block.Robj"))

# Calculate layer contributions for K=2
layer.contributions_nsp[, 2] <- c(calculate.layer.contribution(conStruct.results[[1]], data.block), rep(0,3))
tmp <- conStruct.results[[1]]$MAP$admix.proportions




# Load the conStruct.results.Robj and data.block.Robj files for K=1
load( here::here("./conStruct/nspatial_rObjs/nsp_K3_iter5000_chains3_conStruct.results.Robj"))
load( here::here("./conStruct/nspatial_rObjs/nsp_K3_iter5000_chains3_data.block.Robj"))

# Calculate layer contributions for K=3
layer.contributions_nsp[, 3] <- c(calculate.layer.contribution(conStruct.results[[1]], data.block), rep(0, 2))
tmp <- conStruct.results[[1]]$MAP$admix.proportions

```

